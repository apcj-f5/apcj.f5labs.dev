<?xml version="1.0" encoding="utf-8" standalone="yes"?>
<rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom">
  <channel>
    <title>istio on apcj@f5 blog</title>
    <link>/categories/istio/</link>
    <description>Recent content in istio on apcj@f5 blog</description>
    <generator>Hugo -- gohugo.io</generator>
    <language>en-us</language>
    <lastBuildDate>Mon, 02 Aug 2021 16:25:55 +1000</lastBuildDate><atom:link href="/categories/istio/index.xml" rel="self" type="application/rss+xml" />
    <item>
      <title>Learning Istio | Ingress</title>
      <link>/posts/learning-istio/ingress/</link>
      <pubDate>Mon, 02 Aug 2021 16:25:55 +1000</pubDate>
      
      <guid>/posts/learning-istio/ingress/</guid>
      <description>In the previous post, we deployed the Bookinfo application on a k3s cluster with Istio enabled. In this post, we will explore the features on Istio Ingress.
Kubernetes Ingress Istio should handle Kubernetes Ingress resource just fine as documented here.
Here we create a Kubernetes Ingress to access the Bookinfo application. Note the additional annotation kubernetes.io/ingress.class: istio:
kubectl -n bookinfo apply -f - &amp;lt;&amp;lt;EOF apiVersion: networking.k8s.io/v1 kind: Ingress metadata: annotations: kubernetes.</description>
      <content>&lt;p&gt;In the previous &lt;a href=&#34;/posts/learning-istio/01-setup/&#34;&gt;post&lt;/a&gt;, we deployed the &lt;a href=&#34;https://istio.io/latest/docs/examples/bookinfo/#deploying-the-application&#34;&gt;Bookinfo&lt;/a&gt; application on a k3s cluster with Istio enabled. In this post, we will explore the features on Istio Ingress.&lt;/p&gt;
&lt;h1 id=&#34;kubernetes-ingress&#34;&gt;Kubernetes Ingress&lt;/h1&gt;
&lt;p&gt;Istio should handle &lt;a href=&#34;https://kubernetes.io/docs/concepts/services-networking/ingress/&#34;&gt;Kubernetes Ingress&lt;/a&gt; resource just fine as documented &lt;a href=&#34;https://istio.io/latest/docs/tasks/traffic-management/ingress/kubernetes-ingress/&#34;&gt;here&lt;/a&gt;.&lt;/p&gt;
&lt;p&gt;Here we create a Kubernetes Ingress to access the Bookinfo application. Note the additional annotation &lt;code&gt;kubernetes.io/ingress.class: istio&lt;/code&gt;:&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-sh&#34; data-lang=&#34;sh&#34;&gt;kubectl -n bookinfo apply -f - &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;lt;&amp;lt;EOF
&lt;/span&gt;&lt;span style=&#34;color:#e6db74&#34;&gt;apiVersion: networking.k8s.io/v1
&lt;/span&gt;&lt;span style=&#34;color:#e6db74&#34;&gt;kind: Ingress
&lt;/span&gt;&lt;span style=&#34;color:#e6db74&#34;&gt;metadata:
&lt;/span&gt;&lt;span style=&#34;color:#e6db74&#34;&gt;  annotations:
&lt;/span&gt;&lt;span style=&#34;color:#e6db74&#34;&gt;    kubernetes.io/ingress.class: istio
&lt;/span&gt;&lt;span style=&#34;color:#e6db74&#34;&gt;  name: productpage-k8s-ingress
&lt;/span&gt;&lt;span style=&#34;color:#e6db74&#34;&gt;spec:
&lt;/span&gt;&lt;span style=&#34;color:#e6db74&#34;&gt;  rules:
&lt;/span&gt;&lt;span style=&#34;color:#e6db74&#34;&gt;  - http:
&lt;/span&gt;&lt;span style=&#34;color:#e6db74&#34;&gt;      paths:
&lt;/span&gt;&lt;span style=&#34;color:#e6db74&#34;&gt;      - path: /productpage
&lt;/span&gt;&lt;span style=&#34;color:#e6db74&#34;&gt;        pathType: Exact
&lt;/span&gt;&lt;span style=&#34;color:#e6db74&#34;&gt;        backend:
&lt;/span&gt;&lt;span style=&#34;color:#e6db74&#34;&gt;          service:
&lt;/span&gt;&lt;span style=&#34;color:#e6db74&#34;&gt;            name: productpage
&lt;/span&gt;&lt;span style=&#34;color:#e6db74&#34;&gt;            port:
&lt;/span&gt;&lt;span style=&#34;color:#e6db74&#34;&gt;              number: 9080
&lt;/span&gt;&lt;span style=&#34;color:#e6db74&#34;&gt;      - path: /static
&lt;/span&gt;&lt;span style=&#34;color:#e6db74&#34;&gt;        pathType: Prefix
&lt;/span&gt;&lt;span style=&#34;color:#e6db74&#34;&gt;        backend:
&lt;/span&gt;&lt;span style=&#34;color:#e6db74&#34;&gt;          service:
&lt;/span&gt;&lt;span style=&#34;color:#e6db74&#34;&gt;            name: productpage
&lt;/span&gt;&lt;span style=&#34;color:#e6db74&#34;&gt;            port:
&lt;/span&gt;&lt;span style=&#34;color:#e6db74&#34;&gt;              number: 9080
&lt;/span&gt;&lt;span style=&#34;color:#e6db74&#34;&gt;      - path: /login
&lt;/span&gt;&lt;span style=&#34;color:#e6db74&#34;&gt;        pathType: Exact
&lt;/span&gt;&lt;span style=&#34;color:#e6db74&#34;&gt;        backend:
&lt;/span&gt;&lt;span style=&#34;color:#e6db74&#34;&gt;          service:
&lt;/span&gt;&lt;span style=&#34;color:#e6db74&#34;&gt;            name: productpage
&lt;/span&gt;&lt;span style=&#34;color:#e6db74&#34;&gt;            port:
&lt;/span&gt;&lt;span style=&#34;color:#e6db74&#34;&gt;              number: 9080
&lt;/span&gt;&lt;span style=&#34;color:#e6db74&#34;&gt;      - path: /logout
&lt;/span&gt;&lt;span style=&#34;color:#e6db74&#34;&gt;        pathType: Exact
&lt;/span&gt;&lt;span style=&#34;color:#e6db74&#34;&gt;        backend:
&lt;/span&gt;&lt;span style=&#34;color:#e6db74&#34;&gt;          service:
&lt;/span&gt;&lt;span style=&#34;color:#e6db74&#34;&gt;            name: productpage
&lt;/span&gt;&lt;span style=&#34;color:#e6db74&#34;&gt;            port:
&lt;/span&gt;&lt;span style=&#34;color:#e6db74&#34;&gt;              number: 9080
&lt;/span&gt;&lt;span style=&#34;color:#e6db74&#34;&gt;      - path: /api/v1/products
&lt;/span&gt;&lt;span style=&#34;color:#e6db74&#34;&gt;        pathType: Prefix
&lt;/span&gt;&lt;span style=&#34;color:#e6db74&#34;&gt;        backend:
&lt;/span&gt;&lt;span style=&#34;color:#e6db74&#34;&gt;          service:
&lt;/span&gt;&lt;span style=&#34;color:#e6db74&#34;&gt;            name: productpage
&lt;/span&gt;&lt;span style=&#34;color:#e6db74&#34;&gt;            port:
&lt;/span&gt;&lt;span style=&#34;color:#e6db74&#34;&gt;              number: 9080
&lt;/span&gt;&lt;span style=&#34;color:#e6db74&#34;&gt;EOF&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;The application is now exposed through the Istio ingress gateway on port 80, which in turn is exposed on port 8080 via the k3d configuration. Verify that it is working by browsing to &lt;a href=&#34;http://localhost:8080/productpage&#34;&gt;http://localhost:8080/productpage&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;To verify that the route has been configured on the Istio ingress gateway, first get the name of the &lt;code&gt;route&lt;/code&gt; created by the Ingress:&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-sh&#34; data-lang=&#34;sh&#34;&gt;$ ISTIO_INGRESS_GW_POD&lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt;&lt;span style=&#34;color:#66d9ef&#34;&gt;$(&lt;/span&gt;kubectl -n istio-system get pods -l app&lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt;istio-ingressgateway -o jsonpath&lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt;&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#39;{.items[*].metadata.name}&amp;#39;&lt;/span&gt;&lt;span style=&#34;color:#66d9ef&#34;&gt;)&lt;/span&gt;
$ istioctl proxy-config routes -n istio-system $ISTIO_INGRESS_GW_POD
NAME        DOMAINS     MATCH                  VIRTUAL SERVICE
http.80     *           /productpage           -productpage-k8s-ingress-istio-autogenerated-k8s-ingress.bookinfo
            *           /healthz/ready*
            *           /stats/prometheus*
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;In the example above, we see &lt;code&gt;http.80&lt;/code&gt; is the route created for our ingress matching &lt;code&gt;/productpage&lt;/code&gt;. We can then print out the details of the route by name&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-sh&#34; data-lang=&#34;sh&#34;&gt;$ istioctl proxy-config routes -n istio-system $ISTIO_INGRESS_GW_POD --name http.80 -o yaml
- name: http.80
  validateClusters: false
  virtualHosts:
  - domains:
    - &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#39;*&amp;#39;&lt;/span&gt;
    includeRequestAttemptCount: true
    name: &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#39;*:80&amp;#39;&lt;/span&gt;
    routes:
    - decorator:
        operation: productpage.bookinfo.svc.cluster.local:9080/productpage
      match:
        caseSensitive: true
        path: /productpage
      metadata:
        filterMetadata:
          istio:
            config: /apis/networking.istio.io/v1alpha3/namespaces/bookinfo/virtual-service/-productpage-k8s-ingress-istio-autogenerated-k8s-ingress
      route:
        cluster: outbound|9080&lt;span style=&#34;color:#f92672&#34;&gt;||&lt;/span&gt;productpage.bookinfo.svc.cluster.local
        maxGrpcTimeout: 0s
        retryPolicy:
          hostSelectionRetryMaxAttempts: &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;5&amp;#34;&lt;/span&gt;
          numRetries: &lt;span style=&#34;color:#ae81ff&#34;&gt;2&lt;/span&gt;
          retriableStatusCodes:
          - &lt;span style=&#34;color:#ae81ff&#34;&gt;503&lt;/span&gt;
          retryHostPredicate:
          - name: envoy.retry_host_predicates.previous_hosts
          retryOn: connect-failure,refused-stream,unavailable,cancelled,retriable-status-codes
        timeout: 0s
&amp;lt;output truncated&amp;gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;Alternatively, you can go all out and get a config dump from the ingress gateway (which is basically Envoy) by exposing the Envoy admin port &lt;code&gt;15000&lt;/code&gt;&lt;/p&gt;
&lt;pre tabindex=&#34;0&#34;&gt;&lt;code&gt;k -n istio-system port-forward $ISTIO_INGRESS_GW_POD 15000
&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;and calling the &lt;code&gt;config_dump&lt;/code&gt; API in a separate terminal&lt;/p&gt;
&lt;pre tabindex=&#34;0&#34;&gt;&lt;code&gt;curl localhost:15000/config_dump
&lt;/code&gt;&lt;/pre&gt;&lt;h1 id=&#34;istio-gateway-and-virtual-service&#34;&gt;Istio Gateway and Virtual Service&lt;/h1&gt;
&lt;p&gt;Istio offers the &lt;code&gt;Gateway&lt;/code&gt; and &lt;code&gt;VirtualService&lt;/code&gt; CRDs for better control of ingress traffic.&lt;/p&gt;
&lt;p&gt;We start by deploying the &lt;code&gt;Gateway&lt;/code&gt; and &lt;code&gt;VirtualService&lt;/code&gt; resources&lt;/p&gt;
&lt;pre tabindex=&#34;0&#34;&gt;&lt;code&gt;kubectl -n bookinfo apply -f - &amp;lt;&amp;lt;EOF
apiVersion: networking.istio.io/v1alpha3
kind: Gateway
metadata:
  name: bookinfo-gateway
spec:
  selector:
    istio: ingressgateway # use istio default controller
  servers:
  - port:
      number: 80
      name: http
      protocol: HTTP
    hosts:
    - &amp;quot;*&amp;quot;
---
apiVersion: networking.istio.io/v1alpha3
kind: VirtualService
metadata:
  name: bookinfo
spec:
  hosts:
  - &amp;quot;*&amp;quot;
  gateways:
  - bookinfo-gateway
  http:
  - match:
    - uri:
        exact: /productpage
    - uri:
        prefix: /static
    - uri:
        exact: /login
    - uri:
        exact: /logout
    - uri:
        prefix: /api/v1/products
    route:
    - destination:
        host: productpage
        port:
          number: 9080
EOF
&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;Verify that the appropriate routes are created:&lt;/p&gt;
&lt;pre tabindex=&#34;0&#34;&gt;&lt;code&gt;$ istioctl proxy-config routes -n istio-system $ISTIO_INGRESS_GW_POD
NAME        DOMAINS     MATCH                  VIRTUAL SERVICE
http.80     *           /productpage           -productpage-k8s-ingress-istio-autogenerated-k8s-ingress.bookinfo
http.80     *           /static/*              -productpage-k8s-ingress-istio-autogenerated-k8s-ingress.bookinfo
http.80     *           /login                 -productpage-k8s-ingress-istio-autogenerated-k8s-ingress.bookinfo
http.80     *           /logout                -productpage-k8s-ingress-istio-autogenerated-k8s-ingress.bookinfo
http.80     *           /api/v1/products/*     -productpage-k8s-ingress-istio-autogenerated-k8s-ingress.bookinfo
http.80     *           /productpage           bookinfo.bookinfo
http.80     *           /static*               bookinfo.bookinfo
http.80     *           /login                 bookinfo.bookinfo
http.80     *           /logout                bookinfo.bookinfo
http.80     *           /api/v1/products*      bookinfo.bookinfo
            *           /healthz/ready*
            *           /stats/prometheus*
&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;Notice that we now have 2 sets of routes, 1 from Kubernetes Ingress and another from the Istio VirtualService. According to Envoy&amp;rsquo;s &lt;a href=&#34;https://www.envoyproxy.io/docs/envoy/latest/configuration/http/http_conn_man/route_matching&#34;&gt;route matching&lt;/a&gt; rules, they are evaluated in order, so the routes introduced by the Ingress resource still has priority.&lt;/p&gt;
&lt;p&gt;Let&amp;rsquo;s verify this by changing the target port for /productpage in the &lt;code&gt;productpage-k8s-ingress&lt;/code&gt; Ingress to something else&lt;/p&gt;
&lt;pre tabindex=&#34;0&#34;&gt;&lt;code&gt;kubectl -n bookinfo patch ingress productpage-k8s-ingress -p &#39;{
  &amp;quot;spec&amp;quot;: {
    &amp;quot;rules&amp;quot;: [
      {
        &amp;quot;http&amp;quot;: {
          &amp;quot;paths&amp;quot;: [
            {
              &amp;quot;path&amp;quot;: &amp;quot;/productpage&amp;quot;,
              &amp;quot;pathType&amp;quot;: &amp;quot;Exact&amp;quot;,
              &amp;quot;backend&amp;quot;: {
                &amp;quot;service&amp;quot;: {
                  &amp;quot;name&amp;quot;: &amp;quot;productpage&amp;quot;,
                  &amp;quot;port&amp;quot;: {
                    &amp;quot;number&amp;quot;: 10080
                  }
                }
              }
            }
          ]
        }
      }
    ]
  }
}&#39;
&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;Attempting to browse to &lt;a href=&#34;http://localhost:8080/productpage&#34;&gt;http://localhost:8080/productpage&lt;/a&gt; will now fail as expected since the &lt;code&gt;productpage-k8s-ingress&lt;/code&gt; Ingress configuration is wrong.&lt;/p&gt;
&lt;p&gt;Now that we have observed this behaviour of Envoy route matching, we can remove the &lt;code&gt;productpage-k8s-ingress&lt;/code&gt; Ingress, and have Istio&amp;rsquo;s Gateway and VirtualService to take effect&lt;/p&gt;
&lt;pre tabindex=&#34;0&#34;&gt;&lt;code&gt;kubectl -n bookinfo delete ingress productpage-k8s-ingress
&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;The &lt;a href=&#34;http://localhost:8080/productpage&#34;&gt;productpage&lt;/a&gt; should now work again.&lt;/p&gt;
&lt;h1 id=&#34;learnings&#34;&gt;Learnings&lt;/h1&gt;
&lt;ul&gt;
&lt;li&gt;Istio can handle Kubernetes Ingress once the &lt;code&gt;kubernetes.io/ingress.class: istio&lt;/code&gt; annotation has been added&lt;/li&gt;
&lt;li&gt;Viewing the Ingress gateway routes&lt;/li&gt;
&lt;li&gt;Ingress gateway route matching behaviour&lt;/li&gt;
&lt;/ul&gt;
</content>
    </item>
    
    <item>
      <title>Istio | Sidecar iptables and traffic steering detail</title>
      <link>/posts/istio-traffic-control-deepdive/</link>
      <pubDate>Thu, 25 Jun 2020 00:00:00 +0000</pubDate>
      
      <guid>/posts/istio-traffic-control-deepdive/</guid>
      <description>How istio manipulates traffic.</description>
      <content>&lt;h2 id=&#34;istio-injected-iptables&#34;&gt;Istio injected iptables&lt;/h2&gt;
&lt;p&gt;Istio implements the hijacking and processing of traffic by injecting the init container and envoy proxy container into the business pod. After the init container runs, the following NAT table rules for iptables will be generated in the corresponding linux namespace&lt;/p&gt;
&lt;pre tabindex=&#34;0&#34;&gt;&lt;code&gt;&amp;amp;#91;root@k8s-node1-v1-16 ~]# iptables -t nat -L -v
Chain PREROUTING (policy ACCEPT 192K packets, 12M bytes)
 pkts bytes target     prot opt in     out     source               destination
 192K   12M ISTIO_INBOUND  tcp  --  any    any     anywhere             anywhere

Chain INPUT (policy ACCEPT 192K packets, 12M bytes)
 pkts bytes target     prot opt in     out     source               destination

Chain OUTPUT (policy ACCEPT 40673 packets, 3694K bytes)
 pkts bytes target     prot opt in     out     source               destination
 8917  535K ISTIO_OUTPUT  tcp  --  any    any     anywhere             anywhere

Chain POSTROUTING (policy ACCEPT 40673 packets, 3694K bytes)
 pkts bytes target     prot opt in     out     source               destination

Chain ISTIO_INBOUND (1 references)
 pkts bytes target     prot opt in     out     source               destination
    0     0 RETURN     tcp  --  any    any     anywhere             anywhere             tcp dpt:ssh
  356 21360 RETURN     tcp  --  any    any     anywhere             anywhere             tcp dpt:15090
 192K   11M RETURN     tcp  --  any    any     anywhere             anywhere             tcp dpt:15021
    0     0 RETURN     tcp  --  any    any     anywhere             anywhere             tcp dpt:15020
   34  2040 ISTIO_IN_REDIRECT  tcp  --  any    any     anywhere             anywhere

Chain ISTIO_IN_REDIRECT (3 references)
 pkts bytes target     prot opt in     out     source               destination
   34  2040 REDIRECT   tcp  --  any    any     anywhere             anywhere             redir ports 15006

Chain ISTIO_OUTPUT (1 references)
 pkts bytes target     prot opt in     out     source               destination
    0     0 RETURN     all  --  any    lo      127.0.0.6            anywhere    
    0     0 ISTIO_IN_REDIRECT  all  --  any    lo      anywhere            !localhost            owner UID match 1337
    0     0 RETURN     all  --  any    lo      anywhere             anywhere             ! owner UID match 1337
 8917  535K RETURN     all  --  any    any     anywhere             anywhere             owner UID match 1337
    0     0 ISTIO_IN_REDIRECT  all  --  any    lo      anywhere            !localhost            owner GID match 1337
    0     0 RETURN     all  --  any    lo      anywhere             anywhere             ! owner GID match 1337
    0     0 RETURN     all  --  any    any     anywhere             anywhere             owner GID match 1337
    0     0 RETURN     all  --  any    any     anywhere             localhost
    0     0 ISTIO_REDIRECT  all  --  any    any     anywhere             anywhere

Chain ISTIO_REDIRECT (1 references)
 pkts bytes target     prot opt in     out     source               destination
    0     0 REDIRECT   tcp  --  any    any     anywhere             anywhere             redir ports 15001
&lt;/code&gt;&lt;/pre&gt;&lt;h2 id=&#34;outbound-flow-control&#34;&gt;Outbound flow control&lt;/h2&gt;
&lt;p&gt;When the business container sends the request to the outside, such as productpage to reviews: 9080 port access, this connection will be redirected by iptables to port 127.0.0.1:115001, and then processed by envoy.&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;REDIRECT
This target is only valid in the nat table, in the PREROUTING and OUTPUT chains, and user-defined chains which are only called from those chains. It redirects the packet to the machine itself by changing the destination IP to the primary address of the incoming interface (locally-generated packets are mapped to the localhost address, 127.0.0.1 for IPv4 and ::1 for IPv6).&lt;/p&gt;
&lt;p&gt;&lt;a href=&#34;https://ipset.netfilter.org/iptables-extensions.man.html#lbDK&#34;&gt;https://ipset.netfilter.org/iptables-extensions.man.html#lbDK&lt;/a&gt;&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;The virtualOutbound in envoy will be hit. This is a special listener. It contains the Original Destination listener filter. Note &amp;ldquo;useOriginalDst&amp;rdquo;: truethat after such configuration in the following configuration , envoy will re-find the matching listener in the configuration. If found, press the hit. The listener performs follow-up processing. If it cannot find it, it sends the request to the cluster in this listener. Here is a passthrough cluster. This cluster will forward the packet directly to the fourth layer.&lt;/p&gt;
&lt;pre tabindex=&#34;0&#34;&gt;&lt;code&gt;root@k8s-master-v1-16 ~]# istioctl proxy-config listener productpage-v1-7f4cc988c6-qxqjs.istio-bookinfo --port 15001 -o json
&amp;amp;#91;
    {
        &amp;quot;name&amp;quot;: &amp;quot;virtualOutbound&amp;quot;,
        &amp;quot;address&amp;quot;: {
            &amp;quot;socketAddress&amp;quot;: {
                &amp;quot;address&amp;quot;: &amp;quot;0.0.0.0&amp;quot;,
                &amp;quot;portValue&amp;quot;: 15001
            }
        },
        &amp;quot;filterChains&amp;quot;: &amp;amp;#91;
            {
                &amp;quot;filters&amp;quot;: &amp;amp;#91;
                    {
                        &amp;quot;name&amp;quot;: &amp;quot;istio.stats&amp;quot;,
                        &amp;quot;typedConfig&amp;quot;: {
                            &amp;quot;@type&amp;quot;: &amp;quot;type.googleapis.com/udpa.type.v1.TypedStruct&amp;quot;,
                            &amp;quot;typeUrl&amp;quot;: &amp;quot;type.googleapis.com/envoy.extensions.filters.network.wasm.v3.Wasm&amp;quot;,
                            &amp;quot;value&amp;quot;: {
                                &amp;quot;config&amp;quot;: {
                                    &amp;quot;configuration&amp;quot;: &amp;quot;{\n  \&amp;quot;debug\&amp;quot;: \&amp;quot;false\&amp;quot;,\n  \&amp;quot;stat_prefix\&amp;quot;: \&amp;quot;istio\&amp;quot;\n}\n&amp;quot;,
                                    &amp;quot;root_id&amp;quot;: &amp;quot;stats_outbound&amp;quot;,
                                    &amp;quot;vm_config&amp;quot;: {
                                        &amp;quot;code&amp;quot;: {
                                            &amp;quot;local&amp;quot;: {
                                                &amp;quot;inline_string&amp;quot;: &amp;quot;envoy.wasm.stats&amp;quot;
                                            }
                                        },
                                        &amp;quot;runtime&amp;quot;: &amp;quot;envoy.wasm.runtime.null&amp;quot;,
                                        &amp;quot;vm_id&amp;quot;: &amp;quot;tcp_stats_outbound&amp;quot;
                                    }
                                }
                            }
                        }
                    },
                    {
                        &amp;quot;name&amp;quot;: &amp;quot;envoy.tcp_proxy&amp;quot;,
                        &amp;quot;typedConfig&amp;quot;: {
                            &amp;quot;@type&amp;quot;: &amp;quot;type.googleapis.com/envoy.config.filter.network.tcp_proxy.v2.TcpProxy&amp;quot;,
                            &amp;quot;statPrefix&amp;quot;: &amp;quot;PassthroughCluster&amp;quot;,
                            &amp;quot;cluster&amp;quot;: &amp;quot;PassthroughCluster&amp;quot;,
                            &amp;quot;accessLog&amp;quot;: &amp;amp;#91;
                                {
                                    &amp;quot;name&amp;quot;: &amp;quot;envoy.file_access_log&amp;quot;,
                                    &amp;quot;typedConfig&amp;quot;: {
                                        &amp;quot;@type&amp;quot;: &amp;quot;type.googleapis.com/envoy.config.accesslog.v2.FileAccessLog&amp;quot;,
                                        &amp;quot;path&amp;quot;: &amp;quot;/dev/stdout&amp;quot;,
                                        &amp;quot;format&amp;quot;: &amp;quot;&amp;amp;#91;%START_TIME%] \&amp;quot;%REQ(:METHOD)% %REQ(X-ENVOY-ORIGINAL-PATH?:PATH)% %PROTOCOL%\&amp;quot; %RESPONSE_CODE% %RESPONSE_FLAGS% \&amp;quot;%DYNAMIC_METADATA(istio.mixer:status)%\&amp;quot; \&amp;quot;%UPSTREAM_TRANSPORT_FAILURE_REASON%\&amp;quot; %BYTES_RECEIVED% %BYTES_SENT% %DURATION% %RESP(X-ENVOY-UPSTREAM-SERVICE-TIME)% \&amp;quot;%REQ(X-FORWARDED-FOR)%\&amp;quot; \&amp;quot;%REQ(USER-AGENT)%\&amp;quot; \&amp;quot;%REQ(X-REQUEST-ID)%\&amp;quot; \&amp;quot;%REQ(:AUTHORITY)%\&amp;quot; \&amp;quot;%UPSTREAM_HOST%\&amp;quot; %UPSTREAM_CLUSTER% %UPSTREAM_LOCAL_ADDRESS% %DOWNSTREAM_LOCAL_ADDRESS% %DOWNSTREAM_REMOTE_ADDRESS% %REQUESTED_SERVER_NAME% %ROUTE_NAME%\n&amp;quot;
                                    }
                                }
                            ]
                        }
                    }
                ],
                &amp;quot;name&amp;quot;: &amp;quot;virtualOutbound-catchall-tcp&amp;quot;
            }
        ],
        &amp;quot;useOriginalDst&amp;quot;: true,
        &amp;quot;trafficDirection&amp;quot;: &amp;quot;OUTBOUND&amp;quot;
    }
]
&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;The above listener will hand over the connection to the listener that matches the original destination IP and port. In the bookinfo example, it will be handed over to the 9080 listener. There is a question to consider here. From the perspective of envoy, the destination port of this link is already 15001, why can it match the following port 0.0.0.0:9080. This is because the NAT is done in the system kernel when iptables is redirected. The system kernel has this converted storage. Envoy obtains the real destination port through getsockopt() , so that it can correctly match the business listener.&lt;/p&gt;
&lt;pre tabindex=&#34;0&#34;&gt;&lt;code&gt;&amp;amp;#91;root@k8s-master-v1-16 ~]# istioctl proxy-config listener productpage-v1-7f4cc988c6-qxqjs.istio-bookinfo --port 9080 -o json
&amp;amp;#91;
    {
        &amp;quot;name&amp;quot;: &amp;quot;0.0.0.0_9080&amp;quot;,
        &amp;quot;address&amp;quot;: {
            &amp;quot;socketAddress&amp;quot;: {
                &amp;quot;address&amp;quot;: &amp;quot;0.0.0.0&amp;quot;,
                &amp;quot;portValue&amp;quot;: 9080
            }
        },
        &amp;quot;filterChains&amp;quot;: &amp;amp;#91;
            {
                &amp;quot;filterChainMatch&amp;quot;: {
                    &amp;quot;applicationProtocols&amp;quot;: &amp;amp;#91;
                        &amp;quot;http/1.0&amp;quot;,
                        &amp;quot;http/1.1&amp;quot;,
                        &amp;quot;h2c&amp;quot;
                    ]
                },
                &amp;quot;filters&amp;quot;: &amp;amp;#91;
                    {
                        &amp;quot;name&amp;quot;: &amp;quot;envoy.http_connection_manager&amp;quot;,
                        &amp;quot;typedConfig&amp;quot;: {
                            &amp;quot;@type&amp;quot;: &amp;quot;type.googleapis.com/envoy.config.filter.network.http_connection_manager.v2.HttpConnectionManager&amp;quot;,
                            &amp;quot;statPrefix&amp;quot;: &amp;quot;outbound_0.0.0.0_9080&amp;quot;,
                            &amp;quot;rds&amp;quot;: {
                                &amp;quot;configSource&amp;quot;: {
                                    &amp;quot;ads&amp;quot;: {}
                                },
                                &amp;quot;routeConfigName&amp;quot;: &amp;quot;9080&amp;quot;
                            },
&lt;/code&gt;&lt;/pre&gt;&lt;pre tabindex=&#34;0&#34;&gt;&lt;code&gt;&amp;amp;#91;root@k8s-master-v1-16 ~]# istioctl proxy-config listener productpage-v1-7f4cc988c6-qxqjs.istio-bookinfo
ADDRESS            PORT      TYPE
10.102.252.88      15012     TCP
10.96.122.225      31400     TCP
10.96.0.10         53        TCP
10.110.88.185      15443     TCP
10.96.122.225      15443     TCP
10.110.88.185      443       TCP
10.102.252.88      443       TCP
10.106.109.172     9001      TCP
10.96.0.1          443       TCP
10.96.122.225      443       TCP
10.106.109.172     9000      TCP
10.105.130.171     14267     HTTP+TCP
10.96.81.27        5601      HTTP+TCP
0.0.0.0            15014     HTTP+TCP
10.105.130.171     14250     HTTP+TCP
0.0.0.0            20001     HTTP+TCP
0.0.0.0            9411      HTTP+TCP
10.111.37.34       9090      HTTP+TCP
10.105.145.36      80        HTTP+TCP
10.105.130.171     14268     HTTP+TCP
10.96.0.10         9153      HTTP+TCP
10.110.244.188     80        HTTP+TCP
10.102.252.88      853       HTTP+TCP
10.99.139.251      16686     HTTP+TCP
0.0.0.0            12345     HTTP+TCP
10.103.155.149     80        HTTP+TCP
0.0.0.0            8000      HTTP+TCP
0.0.0.0            15010     HTTP+TCP
10.96.122.225      15020     HTTP+TCP
0.0.0.0            9090      HTTP+TCP
10.107.150.251     80        HTTP+TCP
0.0.0.0            14250     HTTP+TCP
0.0.0.0            80        HTTP+TCP
0.0.0.0            3000      HTTP+TCP
10.110.28.96       8181      HTTP+TCP
10.102.69.143      9200      HTTP+TCP
0.0.0.0            9080      HTTP+TCP 《《《《《《《《《《《《
0.0.0.0            15001     TCP 《《《《《《《《《《《《
0.0.0.0            15006     HTTP+TCP
0.0.0.0            15090     HTTP
0.0.0.0            15021     HTTP
&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;Related passthrough cluster:&lt;/p&gt;
&lt;pre tabindex=&#34;0&#34;&gt;&lt;code&gt;root@k8s-master-v1-16 ~]# istioctl proxy-config cluster productpage-v1-7f4cc988c6-qxqjs.istio-bookinfo --fqdn PassthroughCluster -o json
&amp;amp;#91;
。。。。忽略。。。
    {
        &amp;quot;name&amp;quot;: &amp;quot;PassthroughCluster&amp;quot;,
        &amp;quot;type&amp;quot;: &amp;quot;ORIGINAL_DST&amp;quot;,
        &amp;quot;connectTimeout&amp;quot;: &amp;quot;10s&amp;quot;,
        &amp;quot;lbPolicy&amp;quot;: &amp;quot;CLUSTER_PROVIDED&amp;quot;,
        &amp;quot;circuitBreakers&amp;quot;: {
            &amp;quot;thresholds&amp;quot;: &amp;amp;#91;
                {
                    &amp;quot;maxConnections&amp;quot;: 4294967295,
                    &amp;quot;maxPendingRequests&amp;quot;: 4294967295,
                    &amp;quot;maxRequests&amp;quot;: 4294967295,
                    &amp;quot;maxRetries&amp;quot;: 4294967295
                }
            ]
        },
        &amp;quot;filters&amp;quot;: &amp;amp;#91;
            {
                &amp;quot;name&amp;quot;: &amp;quot;istio.metadata_exchange&amp;quot;,
                &amp;quot;typedConfig&amp;quot;: {
                    &amp;quot;@type&amp;quot;: &amp;quot;type.googleapis.com/udpa.type.v1.TypedStruct&amp;quot;,
                    &amp;quot;typeUrl&amp;quot;: &amp;quot;type.googleapis.com/envoy.tcp.metadataexchange.config.MetadataExchange&amp;quot;,
                    &amp;quot;value&amp;quot;: {
                        &amp;quot;protocol&amp;quot;: &amp;quot;istio-peer-exchange&amp;quot;
                    }
                }
            }
        ]
    }
]
&lt;/code&gt;&lt;/pre&gt;&lt;h2 id=&#34;inbound-flow-control&#34;&gt;Inbound flow control&lt;/h2&gt;
&lt;p&gt;When it is an inbound request, the destination address of the packet is the IP of the pod, and the destination port is the real port of the business (9080, non-svc mapping port). Since the link destination port of iptables is changed to 15006, it will Hit virtual inbound listener (0.0.0.0:15006), this listener has a series of filterchain, and the virtualoutbound listener configuration method is different, virtualinbound contains a series of actual service filters for specific ports, the connection will find specific in these fitlers Business matching. So how does it match the real 9080 business? For example, the following output:
addressPrefix can be matched. If the pod actually has multiple ports, only addressPrefix does not match. It also needs to match the application layer protocol, but the DestinationPort in the Match condition is not matched . In fact, it is similar to Virtualoutbound. The filter of the original destination listener is also used, so envoy will obtain the real destination port and IP from the kernel. This configuration method is different from the virtual outbound &amp;ldquo;useOriginalDst&amp;rdquo;: true configuration method, because this is an updated configuration method.&amp;quot; useOriginalDst&amp;quot;: true This configuration is about to be abandoned.&lt;/p&gt;
&lt;p&gt;&lt;code&gt;&amp;quot;listenerFilters&amp;quot;: [ { &amp;quot;name&amp;quot;: &amp;quot;envoy.listener.original_dst&amp;quot;, &amp;quot;typedConfig&amp;quot;: { &amp;quot;@type&amp;quot;: &amp;quot;type.googleapis.com/envoy.config.filter.listener.original_dst.v2.OriginalDst&amp;quot; } },&lt;/code&gt;&lt;/p&gt;
&lt;p&gt;(According to &lt;a href=&#34;https://www.envoyproxy.io/docs/envoy/latest/api-v2/api/v2/listener/listener_components.proto&#34;&gt;https://www.envoyproxy.io/docs/envoy/latest/api-v2/api/v2/listener/listener_components.proto&lt;/a&gt;, the  filtermatch condition is that all must match)&lt;/p&gt;
&lt;pre tabindex=&#34;0&#34;&gt;&lt;code&gt;            {
                &amp;quot;filterChainMatch&amp;quot;: {
                    &amp;quot;destinationPort&amp;quot;: 9080,
                    &amp;quot;prefixRanges&amp;quot;: &amp;amp;#91;
                        {
                            &amp;quot;addressPrefix&amp;quot;: &amp;quot;10.244.2.138&amp;quot;,
                            &amp;quot;prefixLen&amp;quot;: 32
                        }
                    ],
### 根据https://istio.io/latest/zh/docs/ops/deployment/requirements/ , 
### 同一个业务端口是不能被两个用不同协议的svc来发布的，因此这帮助避免了同端口同协议的match在整个配置文件里的出现。
                    &amp;quot;applicationProtocols&amp;quot;: &amp;amp;#91;
                        &amp;quot;istio&amp;quot;,
                        &amp;quot;istio-http/1.0&amp;quot;,
                        &amp;quot;istio-http/1.1&amp;quot;,
                        &amp;quot;istio-h2&amp;quot;
                    ]
                },
                &amp;quot;filters&amp;quot;: &amp;amp;#91;
                    {
                        &amp;quot;name&amp;quot;: &amp;quot;istio.metadata_exchange&amp;quot;,
                        &amp;quot;typedConfig&amp;quot;: {
                            &amp;quot;@type&amp;quot;: &amp;quot;type.googleapis.com/udpa.type.v1.TypedStruct&amp;quot;,
                            &amp;quot;typeUrl&amp;quot;: &amp;quot;type.googleapis.com/envoy.tcp.metadataexchange.config.MetadataExchange&amp;quot;,
                            &amp;quot;value&amp;quot;: {
                                &amp;quot;protocol&amp;quot;: &amp;quot;istio-peer-exchange&amp;quot;
                            }
                        }
                    },
                    {
                        &amp;quot;name&amp;quot;: &amp;quot;envoy.http_connection_manager&amp;quot;,
                        &amp;quot;typedConfig&amp;quot;: {
                            &amp;quot;@type&amp;quot;: &amp;quot;type.googleapis.com/envoy.config.filter.network.http_connection_manager.v2.HttpConnectionManager&amp;quot;,
                            &amp;quot;statPrefix&amp;quot;: &amp;quot;inbound_10.244.2.138_9080&amp;quot;,
                            &amp;quot;routeConfig&amp;quot;: {
                                &amp;quot;name&amp;quot;: &amp;quot;inbound|9080|http|productpage.istio-bookinfo.svc.cluster.local&amp;quot;,
                                &amp;quot;virtualHosts&amp;quot;: &amp;amp;#91;
                                    {
                                        &amp;quot;name&amp;quot;: &amp;quot;inbound|http|9080&amp;quot;,
                                        &amp;quot;domains&amp;quot;: &amp;amp;#91;
                                            &amp;quot;*&amp;quot;
                                        ],
                                        &amp;quot;routes&amp;quot;: &amp;amp;#91;
                                            {
                                                &amp;quot;name&amp;quot;: &amp;quot;default&amp;quot;,
                                                &amp;quot;match&amp;quot;: {
                                                    &amp;quot;prefix&amp;quot;: &amp;quot;/&amp;quot;
                                                },
                                                &amp;quot;route&amp;quot;: {
                                                    &amp;quot;cluster&amp;quot;: &amp;quot;inbound|9080|http|productpage.istio-bookinfo.svc.cluster.local&amp;quot;,
                                                    &amp;quot;timeout&amp;quot;: &amp;quot;0s&amp;quot;,
                                                    &amp;quot;maxGrpcTimeout&amp;quot;: &amp;quot;0s&amp;quot;
                                                },
                                                &amp;quot;decorator&amp;quot;: {
                                                    &amp;quot;operation&amp;quot;: &amp;quot;productpage.istio-bookinfo.svc.cluster.local:9080/*&amp;quot;
                                                }
                                            }
                                        ]
                                    }
                                ],
&lt;/code&gt;&lt;/pre&gt;&lt;h2 id=&#34;last&#34;&gt;Last&lt;/h2&gt;
&lt;p&gt;Attach the actual configuration of 15006&lt;/p&gt;
&lt;pre tabindex=&#34;0&#34;&gt;&lt;code&gt;&amp;amp;#91;root@k8s-master-v1-16 ~]# istioctl proxy-config listener productpage-v1-7f4cc988c6-qxqjs.istio-bookinfo --port 15006 -o json
&amp;amp;#91;
    {
        &amp;quot;name&amp;quot;: &amp;quot;virtualInbound&amp;quot;,
        &amp;quot;address&amp;quot;: {
            &amp;quot;socketAddress&amp;quot;: {
                &amp;quot;address&amp;quot;: &amp;quot;0.0.0.0&amp;quot;,
                &amp;quot;portValue&amp;quot;: 15006
            }
        },
        &amp;quot;filterChains&amp;quot;: &amp;amp;#91;
            {
                &amp;quot;filterChainMatch&amp;quot;: {
                    &amp;quot;prefixRanges&amp;quot;: &amp;amp;#91;
                        {
                            &amp;quot;addressPrefix&amp;quot;: &amp;quot;0.0.0.0&amp;quot;,
                            &amp;quot;prefixLen&amp;quot;: 0
                        }
                    ],
                    &amp;quot;transportProtocol&amp;quot;: &amp;quot;tls&amp;quot;,
                    &amp;quot;applicationProtocols&amp;quot;: &amp;amp;#91;
                        &amp;quot;istio-peer-exchange&amp;quot;,
                        &amp;quot;istio&amp;quot;
                    ]
                },
                &amp;quot;filters&amp;quot;: &amp;amp;#91;
                    {
                        &amp;quot;name&amp;quot;: &amp;quot;istio.metadata_exchange&amp;quot;,
                        &amp;quot;typedConfig&amp;quot;: {
                            &amp;quot;@type&amp;quot;: &amp;quot;type.googleapis.com/udpa.type.v1.TypedStruct&amp;quot;,
                            &amp;quot;typeUrl&amp;quot;: &amp;quot;type.googleapis.com/envoy.tcp.metadataexchange.config.MetadataExchange&amp;quot;,
                            &amp;quot;value&amp;quot;: {
                                &amp;quot;protocol&amp;quot;: &amp;quot;istio-peer-exchange&amp;quot;
                            }
                        }
                    },
                    {
                        &amp;quot;name&amp;quot;: &amp;quot;istio.stats&amp;quot;,
                        &amp;quot;typedConfig&amp;quot;: {
                            &amp;quot;@type&amp;quot;: &amp;quot;type.googleapis.com/udpa.type.v1.TypedStruct&amp;quot;,
                            &amp;quot;typeUrl&amp;quot;: &amp;quot;type.googleapis.com/envoy.extensions.filters.network.wasm.v3.Wasm&amp;quot;,
                            &amp;quot;value&amp;quot;: {
                                &amp;quot;config&amp;quot;: {
                                    &amp;quot;configuration&amp;quot;: &amp;quot;{\n  \&amp;quot;debug\&amp;quot;: \&amp;quot;false\&amp;quot;,\n  \&amp;quot;stat_prefix\&amp;quot;: \&amp;quot;istio\&amp;quot;\n}\n&amp;quot;,
                                    &amp;quot;root_id&amp;quot;: &amp;quot;stats_inbound&amp;quot;,
                                    &amp;quot;vm_config&amp;quot;: {
                                        &amp;quot;code&amp;quot;: {
                                            &amp;quot;local&amp;quot;: {
                                                &amp;quot;inline_string&amp;quot;: &amp;quot;envoy.wasm.stats&amp;quot;
                                            }
                                        },
                                        &amp;quot;runtime&amp;quot;: &amp;quot;envoy.wasm.runtime.null&amp;quot;,
                                        &amp;quot;vm_id&amp;quot;: &amp;quot;tcp_stats_inbound&amp;quot;
                                    }
                                }
                            }
                        }
                    },
                    {
                        &amp;quot;name&amp;quot;: &amp;quot;envoy.tcp_proxy&amp;quot;,
                        &amp;quot;typedConfig&amp;quot;: {
                            &amp;quot;@type&amp;quot;: &amp;quot;type.googleapis.com/envoy.config.filter.network.tcp_proxy.v2.TcpProxy&amp;quot;,
                            &amp;quot;statPrefix&amp;quot;: &amp;quot;InboundPassthroughClusterIpv4&amp;quot;,
                            &amp;quot;cluster&amp;quot;: &amp;quot;InboundPassthroughClusterIpv4&amp;quot;,
                            &amp;quot;accessLog&amp;quot;: &amp;amp;#91;
                                {
                                    &amp;quot;name&amp;quot;: &amp;quot;envoy.file_access_log&amp;quot;,
                                    &amp;quot;typedConfig&amp;quot;: {
                                        &amp;quot;@type&amp;quot;: &amp;quot;type.googleapis.com/envoy.config.accesslog.v2.FileAccessLog&amp;quot;,
                                        &amp;quot;path&amp;quot;: &amp;quot;/dev/stdout&amp;quot;,
                                        &amp;quot;format&amp;quot;: &amp;quot;&amp;amp;#91;%START_TIME%] \&amp;quot;%REQ(:METHOD)% %REQ(X-ENVOY-ORIGINAL-PATH?:PATH)% %PROTOCOL%\&amp;quot; %RESPONSE_CODE% %RESPONSE_FLAGS% \&amp;quot;%DYNAMIC_METADATA(istio.mixer:status)%\&amp;quot; \&amp;quot;%UPSTREAM_TRANSPORT_FAILURE_REASON%\&amp;quot; %BYTES_RECEIVED% %BYTES_SENT% %DURATION% %RESP(X-ENVOY-UPSTREAM-SERVICE-TIME)% \&amp;quot;%REQ(X-FORWARDED-FOR)%\&amp;quot; \&amp;quot;%REQ(USER-AGENT)%\&amp;quot; \&amp;quot;%REQ(X-REQUEST-ID)%\&amp;quot; \&amp;quot;%REQ(:AUTHORITY)%\&amp;quot; \&amp;quot;%UPSTREAM_HOST%\&amp;quot; %UPSTREAM_CLUSTER% %UPSTREAM_LOCAL_ADDRESS% %DOWNSTREAM_LOCAL_ADDRESS% %DOWNSTREAM_REMOTE_ADDRESS% %REQUESTED_SERVER_NAME% %ROUTE_NAME%\n&amp;quot;
                                    }
                                }
                            ]
                        }
                    }
                ],
                &amp;quot;transportSocket&amp;quot;: {
                    &amp;quot;name&amp;quot;: &amp;quot;envoy.transport_sockets.tls&amp;quot;,
                    &amp;quot;typedConfig&amp;quot;: {
                        &amp;quot;@type&amp;quot;: &amp;quot;type.googleapis.com/envoy.api.v2.auth.DownstreamTlsContext&amp;quot;,
                        &amp;quot;commonTlsContext&amp;quot;: {
                            &amp;quot;tlsCertificateSdsSecretConfigs&amp;quot;: &amp;amp;#91;
                                {
                                    &amp;quot;name&amp;quot;: &amp;quot;default&amp;quot;,
                                    &amp;quot;sdsConfig&amp;quot;: {
                                        &amp;quot;apiConfigSource&amp;quot;: {
                                            &amp;quot;apiType&amp;quot;: &amp;quot;GRPC&amp;quot;,
                                            &amp;quot;grpcServices&amp;quot;: &amp;amp;#91;
                                                {
                                                    &amp;quot;envoyGrpc&amp;quot;: {
                                                        &amp;quot;clusterName&amp;quot;: &amp;quot;sds-grpc&amp;quot;
                                                    }
                                                }
                                            ]
                                        }
                                    }
                                }
                            ],
                            &amp;quot;combinedValidationContext&amp;quot;: {
                                &amp;quot;defaultValidationContext&amp;quot;: {},
                                &amp;quot;validationContextSdsSecretConfig&amp;quot;: {
                                    &amp;quot;name&amp;quot;: &amp;quot;ROOTCA&amp;quot;,
                                    &amp;quot;sdsConfig&amp;quot;: {
                                        &amp;quot;apiConfigSource&amp;quot;: {
                                            &amp;quot;apiType&amp;quot;: &amp;quot;GRPC&amp;quot;,
                                            &amp;quot;grpcServices&amp;quot;: &amp;amp;#91;
                                                {
                                                    &amp;quot;envoyGrpc&amp;quot;: {
                                                        &amp;quot;clusterName&amp;quot;: &amp;quot;sds-grpc&amp;quot;
                                                    }
                                                }
                                            ]
                                        }
                                    }
                                }
                            },
                            &amp;quot;alpnProtocols&amp;quot;: &amp;amp;#91;
                                &amp;quot;istio-peer-exchange&amp;quot;,
                                &amp;quot;h2&amp;quot;,
                                &amp;quot;http/1.1&amp;quot;
                            ]
                        },
                        &amp;quot;requireClientCertificate&amp;quot;: true
                    }
                },
                &amp;quot;name&amp;quot;: &amp;quot;virtualInbound&amp;quot;
            },
            {
                &amp;quot;filterChainMatch&amp;quot;: {
                    &amp;quot;prefixRanges&amp;quot;: &amp;amp;#91;
                        {
                            &amp;quot;addressPrefix&amp;quot;: &amp;quot;0.0.0.0&amp;quot;,
                            &amp;quot;prefixLen&amp;quot;: 0
                        }
                    ]
                },
                &amp;quot;filters&amp;quot;: &amp;amp;#91;
                    {
                        &amp;quot;name&amp;quot;: &amp;quot;istio.metadata_exchange&amp;quot;,
                        &amp;quot;typedConfig&amp;quot;: {
                            &amp;quot;@type&amp;quot;: &amp;quot;type.googleapis.com/udpa.type.v1.TypedStruct&amp;quot;,
                            &amp;quot;typeUrl&amp;quot;: &amp;quot;type.googleapis.com/envoy.tcp.metadataexchange.config.MetadataExchange&amp;quot;,
                            &amp;quot;value&amp;quot;: {
                                &amp;quot;protocol&amp;quot;: &amp;quot;istio-peer-exchange&amp;quot;
                            }
                        }
                    },
                    {
                        &amp;quot;name&amp;quot;: &amp;quot;istio.stats&amp;quot;,
                        &amp;quot;typedConfig&amp;quot;: {
                            &amp;quot;@type&amp;quot;: &amp;quot;type.googleapis.com/udpa.type.v1.TypedStruct&amp;quot;,
                            &amp;quot;typeUrl&amp;quot;: &amp;quot;type.googleapis.com/envoy.extensions.filters.network.wasm.v3.Wasm&amp;quot;,
                            &amp;quot;value&amp;quot;: {
                                &amp;quot;config&amp;quot;: {
                                    &amp;quot;configuration&amp;quot;: &amp;quot;{\n  \&amp;quot;debug\&amp;quot;: \&amp;quot;false\&amp;quot;,\n  \&amp;quot;stat_prefix\&amp;quot;: \&amp;quot;istio\&amp;quot;\n}\n&amp;quot;,
                                    &amp;quot;root_id&amp;quot;: &amp;quot;stats_inbound&amp;quot;,
                                    &amp;quot;vm_config&amp;quot;: {
                                        &amp;quot;code&amp;quot;: {
                                            &amp;quot;local&amp;quot;: {
                                                &amp;quot;inline_string&amp;quot;: &amp;quot;envoy.wasm.stats&amp;quot;
                                            }
                                        },
                                        &amp;quot;runtime&amp;quot;: &amp;quot;envoy.wasm.runtime.null&amp;quot;,
                                        &amp;quot;vm_id&amp;quot;: &amp;quot;tcp_stats_inbound&amp;quot;
                                    }
                                }
                            }
                        }
                    },
                    {
                        &amp;quot;name&amp;quot;: &amp;quot;envoy.tcp_proxy&amp;quot;,
                        &amp;quot;typedConfig&amp;quot;: {
                            &amp;quot;@type&amp;quot;: &amp;quot;type.googleapis.com/envoy.config.filter.network.tcp_proxy.v2.TcpProxy&amp;quot;,
                            &amp;quot;statPrefix&amp;quot;: &amp;quot;InboundPassthroughClusterIpv4&amp;quot;,
                            &amp;quot;cluster&amp;quot;: &amp;quot;InboundPassthroughClusterIpv4&amp;quot;,
                            &amp;quot;accessLog&amp;quot;: &amp;amp;#91;
                                {
                                    &amp;quot;name&amp;quot;: &amp;quot;envoy.file_access_log&amp;quot;,
                                    &amp;quot;typedConfig&amp;quot;: {
                                        &amp;quot;@type&amp;quot;: &amp;quot;type.googleapis.com/envoy.config.accesslog.v2.FileAccessLog&amp;quot;,
                                        &amp;quot;path&amp;quot;: &amp;quot;/dev/stdout&amp;quot;,
                                        &amp;quot;format&amp;quot;: &amp;quot;&amp;amp;#91;%START_TIME%] \&amp;quot;%REQ(:METHOD)% %REQ(X-ENVOY-ORIGINAL-PATH?:PATH)% %PROTOCOL%\&amp;quot; %RESPONSE_CODE% %RESPONSE_FLAGS% \&amp;quot;%DYNAMIC_METADATA(istio.mixer:status)%\&amp;quot; \&amp;quot;%UPSTREAM_TRANSPORT_FAILURE_REASON%\&amp;quot; %BYTES_RECEIVED% %BYTES_SENT% %DURATION% %RESP(X-ENVOY-UPSTREAM-SERVICE-TIME)% \&amp;quot;%REQ(X-FORWARDED-FOR)%\&amp;quot; \&amp;quot;%REQ(USER-AGENT)%\&amp;quot; \&amp;quot;%REQ(X-REQUEST-ID)%\&amp;quot; \&amp;quot;%REQ(:AUTHORITY)%\&amp;quot; \&amp;quot;%UPSTREAM_HOST%\&amp;quot; %UPSTREAM_CLUSTER% %UPSTREAM_LOCAL_ADDRESS% %DOWNSTREAM_LOCAL_ADDRESS% %DOWNSTREAM_REMOTE_ADDRESS% %REQUESTED_SERVER_NAME% %ROUTE_NAME%\n&amp;quot;
                                    }
                                }
                            ]
                        }
                    }
                ],
                &amp;quot;name&amp;quot;: &amp;quot;virtualInbound&amp;quot;
            },
            {
                &amp;quot;filterChainMatch&amp;quot;: {
                    &amp;quot;prefixRanges&amp;quot;: &amp;amp;#91;
                        {
                            &amp;quot;addressPrefix&amp;quot;: &amp;quot;0.0.0.0&amp;quot;,
                            &amp;quot;prefixLen&amp;quot;: 0
                        }
                    ],
                    &amp;quot;transportProtocol&amp;quot;: &amp;quot;tls&amp;quot;,
                    &amp;quot;applicationProtocols&amp;quot;: &amp;amp;#91;
                        &amp;quot;http/1.0&amp;quot;,
                        &amp;quot;http/1.1&amp;quot;,
                        &amp;quot;h2c&amp;quot;,
                        &amp;quot;istio-http/1.0&amp;quot;,
                        &amp;quot;istio-http/1.1&amp;quot;,
                        &amp;quot;istio-h2&amp;quot;
                    ]
                },
                &amp;quot;filters&amp;quot;: &amp;amp;#91;
                    {
                        &amp;quot;name&amp;quot;: &amp;quot;istio.metadata_exchange&amp;quot;,
                        &amp;quot;typedConfig&amp;quot;: {
                            &amp;quot;@type&amp;quot;: &amp;quot;type.googleapis.com/udpa.type.v1.TypedStruct&amp;quot;,
                            &amp;quot;typeUrl&amp;quot;: &amp;quot;type.googleapis.com/envoy.tcp.metadataexchange.config.MetadataExchange&amp;quot;,
                            &amp;quot;value&amp;quot;: {
                                &amp;quot;protocol&amp;quot;: &amp;quot;istio-peer-exchange&amp;quot;
                            }
                        }
                    },
                    {
                        &amp;quot;name&amp;quot;: &amp;quot;envoy.http_connection_manager&amp;quot;,
                        &amp;quot;typedConfig&amp;quot;: {
                            &amp;quot;@type&amp;quot;: &amp;quot;type.googleapis.com/envoy.config.filter.network.http_connection_manager.v2.HttpConnectionManager&amp;quot;,
                            &amp;quot;statPrefix&amp;quot;: &amp;quot;InboundPassthroughClusterIpv4&amp;quot;,
                            &amp;quot;routeConfig&amp;quot;: {
                                &amp;quot;name&amp;quot;: &amp;quot;InboundPassthroughClusterIpv4&amp;quot;,
                                &amp;quot;virtualHosts&amp;quot;: &amp;amp;#91;
                                    {
                                        &amp;quot;name&amp;quot;: &amp;quot;inbound|http|0&amp;quot;,
                                        &amp;quot;domains&amp;quot;: &amp;amp;#91;
                                            &amp;quot;*&amp;quot;
                                        ],
                                        &amp;quot;routes&amp;quot;: &amp;amp;#91;
                                            {
                                                &amp;quot;name&amp;quot;: &amp;quot;default&amp;quot;,
                                                &amp;quot;match&amp;quot;: {
                                                    &amp;quot;prefix&amp;quot;: &amp;quot;/&amp;quot;
                                                },
                                                &amp;quot;route&amp;quot;: {
                                                    &amp;quot;cluster&amp;quot;: &amp;quot;InboundPassthroughClusterIpv4&amp;quot;,
                                                    &amp;quot;timeout&amp;quot;: &amp;quot;0s&amp;quot;,
                                                    &amp;quot;maxGrpcTimeout&amp;quot;: &amp;quot;0s&amp;quot;
                                                },
                                                &amp;quot;decorator&amp;quot;: {
                                                    &amp;quot;operation&amp;quot;: &amp;quot;:0/*&amp;quot;
                                                }
                                            }
                                        ]
                                    }
                                ],
                                &amp;quot;validateClusters&amp;quot;: false
                            },
                            &amp;quot;httpFilters&amp;quot;: &amp;amp;#91;
                                {
                                    &amp;quot;name&amp;quot;: &amp;quot;istio.metadata_exchange&amp;quot;,
                                    &amp;quot;typedConfig&amp;quot;: {
                                        &amp;quot;@type&amp;quot;: &amp;quot;type.googleapis.com/udpa.type.v1.TypedStruct&amp;quot;,
                                        &amp;quot;typeUrl&amp;quot;: &amp;quot;type.googleapis.com/envoy.extensions.filters.http.wasm.v3.Wasm&amp;quot;,
                                        &amp;quot;value&amp;quot;: {
                                            &amp;quot;config&amp;quot;: {
                                                &amp;quot;configuration&amp;quot;: &amp;quot;{}\n&amp;quot;,
                                                &amp;quot;vm_config&amp;quot;: {
                                                    &amp;quot;code&amp;quot;: {
                                                        &amp;quot;local&amp;quot;: {
                                                            &amp;quot;inline_string&amp;quot;: &amp;quot;envoy.wasm.metadata_exchange&amp;quot;
                                                        }
                                                    },
                                                    &amp;quot;runtime&amp;quot;: &amp;quot;envoy.wasm.runtime.null&amp;quot;
                                                }
                                            }
                                        }
                                    }
                                },
                                {
                                    &amp;quot;name&amp;quot;: &amp;quot;envoy.cors&amp;quot;,
                                    &amp;quot;typedConfig&amp;quot;: {
                                        &amp;quot;@type&amp;quot;: &amp;quot;type.googleapis.com/envoy.config.filter.http.cors.v2.Cors&amp;quot;
                                    }
                                },
                                {
                                    &amp;quot;name&amp;quot;: &amp;quot;envoy.fault&amp;quot;,
                                    &amp;quot;typedConfig&amp;quot;: {
                                        &amp;quot;@type&amp;quot;: &amp;quot;type.googleapis.com/envoy.config.filter.http.fault.v2.HTTPFault&amp;quot;
                                    }
                                },
                                {
                                    &amp;quot;name&amp;quot;: &amp;quot;istio.stats&amp;quot;,
                                    &amp;quot;typedConfig&amp;quot;: {
                                        &amp;quot;@type&amp;quot;: &amp;quot;type.googleapis.com/udpa.type.v1.TypedStruct&amp;quot;,
                                        &amp;quot;typeUrl&amp;quot;: &amp;quot;type.googleapis.com/envoy.extensions.filters.http.wasm.v3.Wasm&amp;quot;,
                                        &amp;quot;value&amp;quot;: {
                                            &amp;quot;config&amp;quot;: {
                                                &amp;quot;configuration&amp;quot;: &amp;quot;{\n  \&amp;quot;debug\&amp;quot;: \&amp;quot;false\&amp;quot;,\n  \&amp;quot;stat_prefix\&amp;quot;: \&amp;quot;istio\&amp;quot;\n}\n&amp;quot;,
                                                &amp;quot;root_id&amp;quot;: &amp;quot;stats_inbound&amp;quot;,
                                                &amp;quot;vm_config&amp;quot;: {
                                                    &amp;quot;code&amp;quot;: {
                                                        &amp;quot;local&amp;quot;: {
                                                            &amp;quot;inline_string&amp;quot;: &amp;quot;envoy.wasm.stats&amp;quot;
                                                        }
                                                    },
                                                    &amp;quot;runtime&amp;quot;: &amp;quot;envoy.wasm.runtime.null&amp;quot;,
                                                    &amp;quot;vm_id&amp;quot;: &amp;quot;stats_inbound&amp;quot;
                                                }
                                            }
                                        }
                                    }
                                },
                                {
                                    &amp;quot;name&amp;quot;: &amp;quot;envoy.router&amp;quot;,
                                    &amp;quot;typedConfig&amp;quot;: {
                                        &amp;quot;@type&amp;quot;: &amp;quot;type.googleapis.com/envoy.config.filter.http.router.v2.Router&amp;quot;
                                    }
                                }
                            ],
                            &amp;quot;tracing&amp;quot;: {
                                &amp;quot;clientSampling&amp;quot;: {
                                    &amp;quot;value&amp;quot;: 100
                                },
                                &amp;quot;randomSampling&amp;quot;: {
                                    &amp;quot;value&amp;quot;: 100
                                },
                                &amp;quot;overallSampling&amp;quot;: {
                                    &amp;quot;value&amp;quot;: 100
                                }
                            },
                            &amp;quot;serverName&amp;quot;: &amp;quot;istio-envoy&amp;quot;,
                            &amp;quot;streamIdleTimeout&amp;quot;: &amp;quot;0s&amp;quot;,
                            &amp;quot;accessLog&amp;quot;: &amp;amp;#91;
                                {
                                    &amp;quot;name&amp;quot;: &amp;quot;envoy.file_access_log&amp;quot;,
                                    &amp;quot;typedConfig&amp;quot;: {
                                        &amp;quot;@type&amp;quot;: &amp;quot;type.googleapis.com/envoy.config.accesslog.v2.FileAccessLog&amp;quot;,
                                        &amp;quot;path&amp;quot;: &amp;quot;/dev/stdout&amp;quot;,
                                        &amp;quot;format&amp;quot;: &amp;quot;&amp;amp;#91;%START_TIME%] \&amp;quot;%REQ(:METHOD)% %REQ(X-ENVOY-ORIGINAL-PATH?:PATH)% %PROTOCOL%\&amp;quot; %RESPONSE_CODE% %RESPONSE_FLAGS% \&amp;quot;%DYNAMIC_METADATA(istio.mixer:status)%\&amp;quot; \&amp;quot;%UPSTREAM_TRANSPORT_FAILURE_REASON%\&amp;quot; %BYTES_RECEIVED% %BYTES_SENT% %DURATION% %RESP(X-ENVOY-UPSTREAM-SERVICE-TIME)% \&amp;quot;%REQ(X-FORWARDED-FOR)%\&amp;quot; \&amp;quot;%REQ(USER-AGENT)%\&amp;quot; \&amp;quot;%REQ(X-REQUEST-ID)%\&amp;quot; \&amp;quot;%REQ(:AUTHORITY)%\&amp;quot; \&amp;quot;%UPSTREAM_HOST%\&amp;quot; %UPSTREAM_CLUSTER% %UPSTREAM_LOCAL_ADDRESS% %DOWNSTREAM_LOCAL_ADDRESS% %DOWNSTREAM_REMOTE_ADDRESS% %REQUESTED_SERVER_NAME% %ROUTE_NAME%\n&amp;quot;
                                    }
                                }
                            ],
                            &amp;quot;useRemoteAddress&amp;quot;: false,
                            &amp;quot;generateRequestId&amp;quot;: true,
                            &amp;quot;forwardClientCertDetails&amp;quot;: &amp;quot;APPEND_FORWARD&amp;quot;,
                            &amp;quot;setCurrentClientCertDetails&amp;quot;: {
                                &amp;quot;subject&amp;quot;: true,
                                &amp;quot;dns&amp;quot;: true,
                                &amp;quot;uri&amp;quot;: true
                            },
                            &amp;quot;upgradeConfigs&amp;quot;: &amp;amp;#91;
                                {
                                    &amp;quot;upgradeType&amp;quot;: &amp;quot;websocket&amp;quot;
                                }
                            ],
                            &amp;quot;normalizePath&amp;quot;: true
                        }
                    }
                ],
                &amp;quot;transportSocket&amp;quot;: {
                    &amp;quot;name&amp;quot;: &amp;quot;envoy.transport_sockets.tls&amp;quot;,
                    &amp;quot;typedConfig&amp;quot;: {
                        &amp;quot;@type&amp;quot;: &amp;quot;type.googleapis.com/envoy.api.v2.auth.DownstreamTlsContext&amp;quot;,
                        &amp;quot;commonTlsContext&amp;quot;: {
                            &amp;quot;tlsCertificateSdsSecretConfigs&amp;quot;: &amp;amp;#91;
                                {
                                    &amp;quot;name&amp;quot;: &amp;quot;default&amp;quot;,
                                    &amp;quot;sdsConfig&amp;quot;: {
                                        &amp;quot;apiConfigSource&amp;quot;: {
                                            &amp;quot;apiType&amp;quot;: &amp;quot;GRPC&amp;quot;,
                                            &amp;quot;grpcServices&amp;quot;: &amp;amp;#91;
                                                {
                                                    &amp;quot;envoyGrpc&amp;quot;: {
                                                        &amp;quot;clusterName&amp;quot;: &amp;quot;sds-grpc&amp;quot;
                                                    }
                                                }
                                            ]
                                        }
                                    }
                                }
                            ],
                            &amp;quot;combinedValidationContext&amp;quot;: {
                                &amp;quot;defaultValidationContext&amp;quot;: {},
                                &amp;quot;validationContextSdsSecretConfig&amp;quot;: {
                                    &amp;quot;name&amp;quot;: &amp;quot;ROOTCA&amp;quot;,
                                    &amp;quot;sdsConfig&amp;quot;: {
                                        &amp;quot;apiConfigSource&amp;quot;: {
                                            &amp;quot;apiType&amp;quot;: &amp;quot;GRPC&amp;quot;,
                                            &amp;quot;grpcServices&amp;quot;: &amp;amp;#91;
                                                {
                                                    &amp;quot;envoyGrpc&amp;quot;: {
                                                        &amp;quot;clusterName&amp;quot;: &amp;quot;sds-grpc&amp;quot;
                                                    }
                                                }
                                            ]
                                        }
                                    }
                                }
                            },
                            &amp;quot;alpnProtocols&amp;quot;: &amp;amp;#91;
                                &amp;quot;h2&amp;quot;,
                                &amp;quot;http/1.1&amp;quot;
                            ]
                        },
                        &amp;quot;requireClientCertificate&amp;quot;: true
                    }
                },
                &amp;quot;name&amp;quot;: &amp;quot;virtualInbound-catchall-http&amp;quot;
            },
            {
                &amp;quot;filterChainMatch&amp;quot;: {
                    &amp;quot;prefixRanges&amp;quot;: &amp;amp;#91;
                        {
                            &amp;quot;addressPrefix&amp;quot;: &amp;quot;0.0.0.0&amp;quot;,
                            &amp;quot;prefixLen&amp;quot;: 0
                        }
                    ],
                    &amp;quot;applicationProtocols&amp;quot;: &amp;amp;#91;
                        &amp;quot;http/1.0&amp;quot;,
                        &amp;quot;http/1.1&amp;quot;,
                        &amp;quot;h2c&amp;quot;
                    ]
                },
                &amp;quot;filters&amp;quot;: &amp;amp;#91;
                    {
                        &amp;quot;name&amp;quot;: &amp;quot;istio.metadata_exchange&amp;quot;,
                        &amp;quot;typedConfig&amp;quot;: {
                            &amp;quot;@type&amp;quot;: &amp;quot;type.googleapis.com/udpa.type.v1.TypedStruct&amp;quot;,
                            &amp;quot;typeUrl&amp;quot;: &amp;quot;type.googleapis.com/envoy.tcp.metadataexchange.config.MetadataExchange&amp;quot;,
                            &amp;quot;value&amp;quot;: {
                                &amp;quot;protocol&amp;quot;: &amp;quot;istio-peer-exchange&amp;quot;
                            }
                        }
                    },
                    {
                        &amp;quot;name&amp;quot;: &amp;quot;envoy.http_connection_manager&amp;quot;,
                        &amp;quot;typedConfig&amp;quot;: {
                            &amp;quot;@type&amp;quot;: &amp;quot;type.googleapis.com/envoy.config.filter.network.http_connection_manager.v2.HttpConnectionManager&amp;quot;,
                            &amp;quot;statPrefix&amp;quot;: &amp;quot;InboundPassthroughClusterIpv4&amp;quot;,
                            &amp;quot;routeConfig&amp;quot;: {
                                &amp;quot;name&amp;quot;: &amp;quot;InboundPassthroughClusterIpv4&amp;quot;,
                                &amp;quot;virtualHosts&amp;quot;: &amp;amp;#91;
                                    {
                                        &amp;quot;name&amp;quot;: &amp;quot;inbound|http|0&amp;quot;,
                                        &amp;quot;domains&amp;quot;: &amp;amp;#91;
                                            &amp;quot;*&amp;quot;
                                        ],
                                        &amp;quot;routes&amp;quot;: &amp;amp;#91;
                                            {
                                                &amp;quot;name&amp;quot;: &amp;quot;default&amp;quot;,
                                                &amp;quot;match&amp;quot;: {
                                                    &amp;quot;prefix&amp;quot;: &amp;quot;/&amp;quot;
                                                },
                                                &amp;quot;route&amp;quot;: {
                                                    &amp;quot;cluster&amp;quot;: &amp;quot;InboundPassthroughClusterIpv4&amp;quot;,
                                                    &amp;quot;timeout&amp;quot;: &amp;quot;0s&amp;quot;,
                                                    &amp;quot;maxGrpcTimeout&amp;quot;: &amp;quot;0s&amp;quot;
                                                },
                                                &amp;quot;decorator&amp;quot;: {
                                                    &amp;quot;operation&amp;quot;: &amp;quot;:0/*&amp;quot;
                                                }
                                            }
                                        ]
                                    }
                                ],
                                &amp;quot;validateClusters&amp;quot;: false
                            },
                            &amp;quot;httpFilters&amp;quot;: &amp;amp;#91;
                                {
                                    &amp;quot;name&amp;quot;: &amp;quot;istio.metadata_exchange&amp;quot;,
                                    &amp;quot;typedConfig&amp;quot;: {
                                        &amp;quot;@type&amp;quot;: &amp;quot;type.googleapis.com/udpa.type.v1.TypedStruct&amp;quot;,
                                        &amp;quot;typeUrl&amp;quot;: &amp;quot;type.googleapis.com/envoy.extensions.filters.http.wasm.v3.Wasm&amp;quot;,
                                        &amp;quot;value&amp;quot;: {
                                            &amp;quot;config&amp;quot;: {
                                                &amp;quot;configuration&amp;quot;: &amp;quot;{}\n&amp;quot;,
                                                &amp;quot;vm_config&amp;quot;: {
                                                    &amp;quot;code&amp;quot;: {
                                                        &amp;quot;local&amp;quot;: {
                                                            &amp;quot;inline_string&amp;quot;: &amp;quot;envoy.wasm.metadata_exchange&amp;quot;
                                                        }
                                                    },
                                                    &amp;quot;runtime&amp;quot;: &amp;quot;envoy.wasm.runtime.null&amp;quot;
                                                }
                                            }
                                        }
                                    }
                                },
                                {
                                    &amp;quot;name&amp;quot;: &amp;quot;envoy.cors&amp;quot;,
                                    &amp;quot;typedConfig&amp;quot;: {
                                        &amp;quot;@type&amp;quot;: &amp;quot;type.googleapis.com/envoy.config.filter.http.cors.v2.Cors&amp;quot;
                                    }
                                },
                                {
                                    &amp;quot;name&amp;quot;: &amp;quot;envoy.fault&amp;quot;,
                                    &amp;quot;typedConfig&amp;quot;: {
                                        &amp;quot;@type&amp;quot;: &amp;quot;type.googleapis.com/envoy.config.filter.http.fault.v2.HTTPFault&amp;quot;
                                    }
                                },
                                {
                                    &amp;quot;name&amp;quot;: &amp;quot;istio.stats&amp;quot;,
                                    &amp;quot;typedConfig&amp;quot;: {
                                        &amp;quot;@type&amp;quot;: &amp;quot;type.googleapis.com/udpa.type.v1.TypedStruct&amp;quot;,
                                        &amp;quot;typeUrl&amp;quot;: &amp;quot;type.googleapis.com/envoy.extensions.filters.http.wasm.v3.Wasm&amp;quot;,
                                        &amp;quot;value&amp;quot;: {
                                            &amp;quot;config&amp;quot;: {
                                                &amp;quot;configuration&amp;quot;: &amp;quot;{\n  \&amp;quot;debug\&amp;quot;: \&amp;quot;false\&amp;quot;,\n  \&amp;quot;stat_prefix\&amp;quot;: \&amp;quot;istio\&amp;quot;\n}\n&amp;quot;,
                                                &amp;quot;root_id&amp;quot;: &amp;quot;stats_inbound&amp;quot;,
                                                &amp;quot;vm_config&amp;quot;: {
                                                    &amp;quot;code&amp;quot;: {
                                                        &amp;quot;local&amp;quot;: {
                                                            &amp;quot;inline_string&amp;quot;: &amp;quot;envoy.wasm.stats&amp;quot;
                                                        }
                                                    },
                                                    &amp;quot;runtime&amp;quot;: &amp;quot;envoy.wasm.runtime.null&amp;quot;,
                                                    &amp;quot;vm_id&amp;quot;: &amp;quot;stats_inbound&amp;quot;
                                                }
                                            }
                                        }
                                    }
                                },
                                {
                                    &amp;quot;name&amp;quot;: &amp;quot;envoy.router&amp;quot;,
                                    &amp;quot;typedConfig&amp;quot;: {
                                        &amp;quot;@type&amp;quot;: &amp;quot;type.googleapis.com/envoy.config.filter.http.router.v2.Router&amp;quot;
                                    }
                                }
                            ],
                            &amp;quot;tracing&amp;quot;: {
                                &amp;quot;clientSampling&amp;quot;: {
                                    &amp;quot;value&amp;quot;: 100
                                },
                                &amp;quot;randomSampling&amp;quot;: {
                                    &amp;quot;value&amp;quot;: 100
                                },
                                &amp;quot;overallSampling&amp;quot;: {
                                    &amp;quot;value&amp;quot;: 100
                                }
                            },
                            &amp;quot;serverName&amp;quot;: &amp;quot;istio-envoy&amp;quot;,
                            &amp;quot;streamIdleTimeout&amp;quot;: &amp;quot;0s&amp;quot;,
                            &amp;quot;accessLog&amp;quot;: &amp;amp;#91;
                                {
                                    &amp;quot;name&amp;quot;: &amp;quot;envoy.file_access_log&amp;quot;,
                                    &amp;quot;typedConfig&amp;quot;: {
                                        &amp;quot;@type&amp;quot;: &amp;quot;type.googleapis.com/envoy.config.accesslog.v2.FileAccessLog&amp;quot;,
                                        &amp;quot;path&amp;quot;: &amp;quot;/dev/stdout&amp;quot;,
                                        &amp;quot;format&amp;quot;: &amp;quot;&amp;amp;#91;%START_TIME%] \&amp;quot;%REQ(:METHOD)% %REQ(X-ENVOY-ORIGINAL-PATH?:PATH)% %PROTOCOL%\&amp;quot; %RESPONSE_CODE% %RESPONSE_FLAGS% \&amp;quot;%DYNAMIC_METADATA(istio.mixer:status)%\&amp;quot; \&amp;quot;%UPSTREAM_TRANSPORT_FAILURE_REASON%\&amp;quot; %BYTES_RECEIVED% %BYTES_SENT% %DURATION% %RESP(X-ENVOY-UPSTREAM-SERVICE-TIME)% \&amp;quot;%REQ(X-FORWARDED-FOR)%\&amp;quot; \&amp;quot;%REQ(USER-AGENT)%\&amp;quot; \&amp;quot;%REQ(X-REQUEST-ID)%\&amp;quot; \&amp;quot;%REQ(:AUTHORITY)%\&amp;quot; \&amp;quot;%UPSTREAM_HOST%\&amp;quot; %UPSTREAM_CLUSTER% %UPSTREAM_LOCAL_ADDRESS% %DOWNSTREAM_LOCAL_ADDRESS% %DOWNSTREAM_REMOTE_ADDRESS% %REQUESTED_SERVER_NAME% %ROUTE_NAME%\n&amp;quot;
                                    }
                                }
                            ],
                            &amp;quot;useRemoteAddress&amp;quot;: false,
                            &amp;quot;generateRequestId&amp;quot;: true,
                            &amp;quot;forwardClientCertDetails&amp;quot;: &amp;quot;APPEND_FORWARD&amp;quot;,
                            &amp;quot;setCurrentClientCertDetails&amp;quot;: {
                                &amp;quot;subject&amp;quot;: true,
                                &amp;quot;dns&amp;quot;: true,
                                &amp;quot;uri&amp;quot;: true
                            },
                            &amp;quot;upgradeConfigs&amp;quot;: &amp;amp;#91;
                                {
                                    &amp;quot;upgradeType&amp;quot;: &amp;quot;websocket&amp;quot;
                                }
                            ],
                            &amp;quot;normalizePath&amp;quot;: true
                        }
                    }
                ],
                &amp;quot;name&amp;quot;: &amp;quot;virtualInbound-catchall-http&amp;quot;
            },
            {
                &amp;quot;filterChainMatch&amp;quot;: {
                    &amp;quot;destinationPort&amp;quot;: 15021,
                    &amp;quot;prefixRanges&amp;quot;: &amp;amp;#91;
                        {
                            &amp;quot;addressPrefix&amp;quot;: &amp;quot;10.244.2.155&amp;quot;,
                            &amp;quot;prefixLen&amp;quot;: 32
                        }
                    ]
                },
                &amp;quot;filters&amp;quot;: &amp;amp;#91;
                    {
                        &amp;quot;name&amp;quot;: &amp;quot;istio.metadata_exchange&amp;quot;,
                        &amp;quot;typedConfig&amp;quot;: {
                            &amp;quot;@type&amp;quot;: &amp;quot;type.googleapis.com/udpa.type.v1.TypedStruct&amp;quot;,
                            &amp;quot;typeUrl&amp;quot;: &amp;quot;type.googleapis.com/envoy.tcp.metadataexchange.config.MetadataExchange&amp;quot;,
                            &amp;quot;value&amp;quot;: {
                                &amp;quot;protocol&amp;quot;: &amp;quot;istio-peer-exchange&amp;quot;
                            }
                        }
                    },
                    {
                        &amp;quot;name&amp;quot;: &amp;quot;istio.stats&amp;quot;,
                        &amp;quot;typedConfig&amp;quot;: {
                            &amp;quot;@type&amp;quot;: &amp;quot;type.googleapis.com/udpa.type.v1.TypedStruct&amp;quot;,
                            &amp;quot;typeUrl&amp;quot;: &amp;quot;type.googleapis.com/envoy.extensions.filters.network.wasm.v3.Wasm&amp;quot;,
                            &amp;quot;value&amp;quot;: {
                                &amp;quot;config&amp;quot;: {
                                    &amp;quot;configuration&amp;quot;: &amp;quot;{\n  \&amp;quot;debug\&amp;quot;: \&amp;quot;false\&amp;quot;,\n  \&amp;quot;stat_prefix\&amp;quot;: \&amp;quot;istio\&amp;quot;\n}\n&amp;quot;,
                                    &amp;quot;root_id&amp;quot;: &amp;quot;stats_inbound&amp;quot;,
                                    &amp;quot;vm_config&amp;quot;: {
                                        &amp;quot;code&amp;quot;: {
                                            &amp;quot;local&amp;quot;: {
                                                &amp;quot;inline_string&amp;quot;: &amp;quot;envoy.wasm.stats&amp;quot;
                                            }
                                        },
                                        &amp;quot;runtime&amp;quot;: &amp;quot;envoy.wasm.runtime.null&amp;quot;,
                                        &amp;quot;vm_id&amp;quot;: &amp;quot;tcp_stats_inbound&amp;quot;
                                    }
                                }
                            }
                        }
                    },
                    {
                        &amp;quot;name&amp;quot;: &amp;quot;envoy.tcp_proxy&amp;quot;,
                        &amp;quot;typedConfig&amp;quot;: {
                            &amp;quot;@type&amp;quot;: &amp;quot;type.googleapis.com/envoy.config.filter.network.tcp_proxy.v2.TcpProxy&amp;quot;,
                            &amp;quot;statPrefix&amp;quot;: &amp;quot;inbound|15021|mgmt-15021|mgmtCluster&amp;quot;,
                            &amp;quot;cluster&amp;quot;: &amp;quot;inbound|15021|mgmt-15021|mgmtCluster&amp;quot;,
                            &amp;quot;accessLog&amp;quot;: &amp;amp;#91;
                                {
                                    &amp;quot;name&amp;quot;: &amp;quot;envoy.file_access_log&amp;quot;,
                                    &amp;quot;typedConfig&amp;quot;: {
                                        &amp;quot;@type&amp;quot;: &amp;quot;type.googleapis.com/envoy.config.accesslog.v2.FileAccessLog&amp;quot;,
                                        &amp;quot;path&amp;quot;: &amp;quot;/dev/stdout&amp;quot;,
                                        &amp;quot;format&amp;quot;: &amp;quot;&amp;amp;#91;%START_TIME%] \&amp;quot;%REQ(:METHOD)% %REQ(X-ENVOY-ORIGINAL-PATH?:PATH)% %PROTOCOL%\&amp;quot; %RESPONSE_CODE% %RESPONSE_FLAGS% \&amp;quot;%DYNAMIC_METADATA(istio.mixer:status)%\&amp;quot; \&amp;quot;%UPSTREAM_TRANSPORT_FAILURE_REASON%\&amp;quot; %BYTES_RECEIVED% %BYTES_SENT% %DURATION% %RESP(X-ENVOY-UPSTREAM-SERVICE-TIME)% \&amp;quot;%REQ(X-FORWARDED-FOR)%\&amp;quot; \&amp;quot;%REQ(USER-AGENT)%\&amp;quot; \&amp;quot;%REQ(X-REQUEST-ID)%\&amp;quot; \&amp;quot;%REQ(:AUTHORITY)%\&amp;quot; \&amp;quot;%UPSTREAM_HOST%\&amp;quot; %UPSTREAM_CLUSTER% %UPSTREAM_LOCAL_ADDRESS% %DOWNSTREAM_LOCAL_ADDRESS% %DOWNSTREAM_REMOTE_ADDRESS% %REQUESTED_SERVER_NAME% %ROUTE_NAME%\n&amp;quot;
                                    }
                                }
                            ]
                        }
                    }
                ],
                &amp;quot;name&amp;quot;: &amp;quot;10.244.2.155_15021&amp;quot;
            },
            {
                &amp;quot;filterChainMatch&amp;quot;: {
                    &amp;quot;destinationPort&amp;quot;: 9080,
                    &amp;quot;prefixRanges&amp;quot;: &amp;amp;#91;
                        {
                            &amp;quot;addressPrefix&amp;quot;: &amp;quot;10.244.2.155&amp;quot;,
                            &amp;quot;prefixLen&amp;quot;: 32
                        }
                    ],
                    &amp;quot;applicationProtocols&amp;quot;: &amp;amp;#91;
                        &amp;quot;istio&amp;quot;,
                        &amp;quot;istio-http/1.0&amp;quot;,
                        &amp;quot;istio-http/1.1&amp;quot;,
                        &amp;quot;istio-h2&amp;quot;
                    ]
                },
                &amp;quot;filters&amp;quot;: &amp;amp;#91;
                    {
                        &amp;quot;name&amp;quot;: &amp;quot;istio.metadata_exchange&amp;quot;,
                        &amp;quot;typedConfig&amp;quot;: {
                            &amp;quot;@type&amp;quot;: &amp;quot;type.googleapis.com/udpa.type.v1.TypedStruct&amp;quot;,
                            &amp;quot;typeUrl&amp;quot;: &amp;quot;type.googleapis.com/envoy.tcp.metadataexchange.config.MetadataExchange&amp;quot;,
                            &amp;quot;value&amp;quot;: {
                                &amp;quot;protocol&amp;quot;: &amp;quot;istio-peer-exchange&amp;quot;
                            }
                        }
                    },
                    {
                        &amp;quot;name&amp;quot;: &amp;quot;envoy.http_connection_manager&amp;quot;,
                        &amp;quot;typedConfig&amp;quot;: {
                            &amp;quot;@type&amp;quot;: &amp;quot;type.googleapis.com/envoy.config.filter.network.http_connection_manager.v2.HttpConnectionManager&amp;quot;,
                            &amp;quot;statPrefix&amp;quot;: &amp;quot;inbound_10.244.2.155_9080&amp;quot;,
                            &amp;quot;routeConfig&amp;quot;: {
                                &amp;quot;name&amp;quot;: &amp;quot;inbound|9080|http|productpage.istio-bookinfo.svc.cluster.local&amp;quot;,
                                &amp;quot;virtualHosts&amp;quot;: &amp;amp;#91;
                                    {
                                        &amp;quot;name&amp;quot;: &amp;quot;inbound|http|9080&amp;quot;,
                                        &amp;quot;domains&amp;quot;: &amp;amp;#91;
                                            &amp;quot;*&amp;quot;
                                        ],
                                        &amp;quot;routes&amp;quot;: &amp;amp;#91;
                                            {
                                                &amp;quot;name&amp;quot;: &amp;quot;default&amp;quot;,
                                                &amp;quot;match&amp;quot;: {
                                                    &amp;quot;prefix&amp;quot;: &amp;quot;/&amp;quot;
                                                },
                                                &amp;quot;route&amp;quot;: {
                                                    &amp;quot;cluster&amp;quot;: &amp;quot;inbound|9080|http|productpage.istio-bookinfo.svc.cluster.local&amp;quot;,
                                                    &amp;quot;timeout&amp;quot;: &amp;quot;0s&amp;quot;,
                                                    &amp;quot;maxGrpcTimeout&amp;quot;: &amp;quot;0s&amp;quot;
                                                },
                                                &amp;quot;decorator&amp;quot;: {
                                                    &amp;quot;operation&amp;quot;: &amp;quot;productpage.istio-bookinfo.svc.cluster.local:9080/*&amp;quot;
                                                }
                                            }
                                        ]
                                    }
                                ],
                                &amp;quot;validateClusters&amp;quot;: false
                            },
                            &amp;quot;httpFilters&amp;quot;: &amp;amp;#91;
                                {
                                    &amp;quot;name&amp;quot;: &amp;quot;istio.metadata_exchange&amp;quot;,
                                    &amp;quot;typedConfig&amp;quot;: {
                                        &amp;quot;@type&amp;quot;: &amp;quot;type.googleapis.com/udpa.type.v1.TypedStruct&amp;quot;,
                                        &amp;quot;typeUrl&amp;quot;: &amp;quot;type.googleapis.com/envoy.extensions.filters.http.wasm.v3.Wasm&amp;quot;,
                                        &amp;quot;value&amp;quot;: {
                                            &amp;quot;config&amp;quot;: {
                                                &amp;quot;configuration&amp;quot;: &amp;quot;{}\n&amp;quot;,
                                                &amp;quot;vm_config&amp;quot;: {
                                                    &amp;quot;code&amp;quot;: {
                                                        &amp;quot;local&amp;quot;: {
                                                            &amp;quot;inline_string&amp;quot;: &amp;quot;envoy.wasm.metadata_exchange&amp;quot;
                                                        }
                                                    },
                                                    &amp;quot;runtime&amp;quot;: &amp;quot;envoy.wasm.runtime.null&amp;quot;
                                                }
                                            }
                                        }
                                    }
                                },
                                {
                                    &amp;quot;name&amp;quot;: &amp;quot;istio_authn&amp;quot;,
                                    &amp;quot;typedConfig&amp;quot;: {
                                        &amp;quot;@type&amp;quot;: &amp;quot;type.googleapis.com/istio.envoy.config.filter.http.authn.v2alpha1.FilterConfig&amp;quot;,
                                        &amp;quot;policy&amp;quot;: {
                                            &amp;quot;peers&amp;quot;: &amp;amp;#91;
                                                {
                                                    &amp;quot;mtls&amp;quot;: {
                                                        &amp;quot;mode&amp;quot;: &amp;quot;PERMISSIVE&amp;quot;
                                                    }
                                                }
                                            ]
                                        }
                                    }
                                },
                                {
                                    &amp;quot;name&amp;quot;: &amp;quot;envoy.cors&amp;quot;,
                                    &amp;quot;typedConfig&amp;quot;: {
                                        &amp;quot;@type&amp;quot;: &amp;quot;type.googleapis.com/envoy.config.filter.http.cors.v2.Cors&amp;quot;
                                    }
                                },
                                {
                                    &amp;quot;name&amp;quot;: &amp;quot;envoy.fault&amp;quot;,
                                    &amp;quot;typedConfig&amp;quot;: {
                                        &amp;quot;@type&amp;quot;: &amp;quot;type.googleapis.com/envoy.config.filter.http.fault.v2.HTTPFault&amp;quot;
                                    }
                                },
                                {
                                    &amp;quot;name&amp;quot;: &amp;quot;istio.stats&amp;quot;,
                                    &amp;quot;typedConfig&amp;quot;: {
                                        &amp;quot;@type&amp;quot;: &amp;quot;type.googleapis.com/udpa.type.v1.TypedStruct&amp;quot;,
                                        &amp;quot;typeUrl&amp;quot;: &amp;quot;type.googleapis.com/envoy.extensions.filters.http.wasm.v3.Wasm&amp;quot;,
                                        &amp;quot;value&amp;quot;: {
                                            &amp;quot;config&amp;quot;: {
                                                &amp;quot;configuration&amp;quot;: &amp;quot;{\n  \&amp;quot;debug\&amp;quot;: \&amp;quot;false\&amp;quot;,\n  \&amp;quot;stat_prefix\&amp;quot;: \&amp;quot;istio\&amp;quot;\n}\n&amp;quot;,
                                                &amp;quot;root_id&amp;quot;: &amp;quot;stats_inbound&amp;quot;,
                                                &amp;quot;vm_config&amp;quot;: {
                                                    &amp;quot;code&amp;quot;: {
                                                        &amp;quot;local&amp;quot;: {
                                                            &amp;quot;inline_string&amp;quot;: &amp;quot;envoy.wasm.stats&amp;quot;
                                                        }
                                                    },
                                                    &amp;quot;runtime&amp;quot;: &amp;quot;envoy.wasm.runtime.null&amp;quot;,
                                                    &amp;quot;vm_id&amp;quot;: &amp;quot;stats_inbound&amp;quot;
                                                }
                                            }
                                        }
                                    }
                                },
                                {
                                    &amp;quot;name&amp;quot;: &amp;quot;envoy.router&amp;quot;,
                                    &amp;quot;typedConfig&amp;quot;: {
                                        &amp;quot;@type&amp;quot;: &amp;quot;type.googleapis.com/envoy.config.filter.http.router.v2.Router&amp;quot;
                                    }
                                }
                            ],
                            &amp;quot;tracing&amp;quot;: {
                                &amp;quot;clientSampling&amp;quot;: {
                                    &amp;quot;value&amp;quot;: 100
                                },
                                &amp;quot;randomSampling&amp;quot;: {
                                    &amp;quot;value&amp;quot;: 100
                                },
                                &amp;quot;overallSampling&amp;quot;: {
                                    &amp;quot;value&amp;quot;: 100
                                }
                            },
                            &amp;quot;serverName&amp;quot;: &amp;quot;istio-envoy&amp;quot;,
                            &amp;quot;streamIdleTimeout&amp;quot;: &amp;quot;0s&amp;quot;,
                            &amp;quot;accessLog&amp;quot;: &amp;amp;#91;
                                {
                                    &amp;quot;name&amp;quot;: &amp;quot;envoy.file_access_log&amp;quot;,
                                    &amp;quot;typedConfig&amp;quot;: {
                                        &amp;quot;@type&amp;quot;: &amp;quot;type.googleapis.com/envoy.config.accesslog.v2.FileAccessLog&amp;quot;,
                                        &amp;quot;path&amp;quot;: &amp;quot;/dev/stdout&amp;quot;,
                                        &amp;quot;format&amp;quot;: &amp;quot;&amp;amp;#91;%START_TIME%] \&amp;quot;%REQ(:METHOD)% %REQ(X-ENVOY-ORIGINAL-PATH?:PATH)% %PROTOCOL%\&amp;quot; %RESPONSE_CODE% %RESPONSE_FLAGS% \&amp;quot;%DYNAMIC_METADATA(istio.mixer:status)%\&amp;quot; \&amp;quot;%UPSTREAM_TRANSPORT_FAILURE_REASON%\&amp;quot; %BYTES_RECEIVED% %BYTES_SENT% %DURATION% %RESP(X-ENVOY-UPSTREAM-SERVICE-TIME)% \&amp;quot;%REQ(X-FORWARDED-FOR)%\&amp;quot; \&amp;quot;%REQ(USER-AGENT)%\&amp;quot; \&amp;quot;%REQ(X-REQUEST-ID)%\&amp;quot; \&amp;quot;%REQ(:AUTHORITY)%\&amp;quot; \&amp;quot;%UPSTREAM_HOST%\&amp;quot; %UPSTREAM_CLUSTER% %UPSTREAM_LOCAL_ADDRESS% %DOWNSTREAM_LOCAL_ADDRESS% %DOWNSTREAM_REMOTE_ADDRESS% %REQUESTED_SERVER_NAME% %ROUTE_NAME%\n&amp;quot;
                                    }
                                }
                            ],
                            &amp;quot;useRemoteAddress&amp;quot;: false,
                            &amp;quot;generateRequestId&amp;quot;: true,
                            &amp;quot;forwardClientCertDetails&amp;quot;: &amp;quot;APPEND_FORWARD&amp;quot;,
                            &amp;quot;setCurrentClientCertDetails&amp;quot;: {
                                &amp;quot;subject&amp;quot;: true,
                                &amp;quot;dns&amp;quot;: true,
                                &amp;quot;uri&amp;quot;: true
                            },
                            &amp;quot;upgradeConfigs&amp;quot;: &amp;amp;#91;
                                {
                                    &amp;quot;upgradeType&amp;quot;: &amp;quot;websocket&amp;quot;
                                }
                            ],
                            &amp;quot;normalizePath&amp;quot;: true
                        }
                    }
                ],
                &amp;quot;transportSocket&amp;quot;: {
                    &amp;quot;name&amp;quot;: &amp;quot;envoy.transport_sockets.tls&amp;quot;,
                    &amp;quot;typedConfig&amp;quot;: {
                        &amp;quot;@type&amp;quot;: &amp;quot;type.googleapis.com/envoy.api.v2.auth.DownstreamTlsContext&amp;quot;,
                        &amp;quot;commonTlsContext&amp;quot;: {
                            &amp;quot;tlsCertificateSdsSecretConfigs&amp;quot;: &amp;amp;#91;
                                {
                                    &amp;quot;name&amp;quot;: &amp;quot;default&amp;quot;,
                                    &amp;quot;sdsConfig&amp;quot;: {
                                        &amp;quot;apiConfigSource&amp;quot;: {
                                            &amp;quot;apiType&amp;quot;: &amp;quot;GRPC&amp;quot;,
                                            &amp;quot;grpcServices&amp;quot;: &amp;amp;#91;
                                                {
                                                    &amp;quot;envoyGrpc&amp;quot;: {
                                                        &amp;quot;clusterName&amp;quot;: &amp;quot;sds-grpc&amp;quot;
                                                    }
                                                }
                                            ]
                                        }
                                    }
                                }
                            ],
                            &amp;quot;combinedValidationContext&amp;quot;: {
                                &amp;quot;defaultValidationContext&amp;quot;: {},
                                &amp;quot;validationContextSdsSecretConfig&amp;quot;: {
                                    &amp;quot;name&amp;quot;: &amp;quot;ROOTCA&amp;quot;,
                                    &amp;quot;sdsConfig&amp;quot;: {
                                        &amp;quot;apiConfigSource&amp;quot;: {
                                            &amp;quot;apiType&amp;quot;: &amp;quot;GRPC&amp;quot;,
                                            &amp;quot;grpcServices&amp;quot;: &amp;amp;#91;
                                                {
                                                    &amp;quot;envoyGrpc&amp;quot;: {
                                                        &amp;quot;clusterName&amp;quot;: &amp;quot;sds-grpc&amp;quot;
                                                    }
                                                }
                                            ]
                                        }
                                    }
                                }
                            },
                            &amp;quot;alpnProtocols&amp;quot;: &amp;amp;#91;
                                &amp;quot;h2&amp;quot;,
                                &amp;quot;http/1.1&amp;quot;
                            ]
                        },
                        &amp;quot;requireClientCertificate&amp;quot;: true
                    }
                },
                &amp;quot;name&amp;quot;: &amp;quot;10.244.2.155_9080&amp;quot;
            },
            {
                &amp;quot;filterChainMatch&amp;quot;: {
                    &amp;quot;destinationPort&amp;quot;: 9080,
                    &amp;quot;prefixRanges&amp;quot;: &amp;amp;#91;
                        {
                            &amp;quot;addressPrefix&amp;quot;: &amp;quot;10.244.2.155&amp;quot;,
                            &amp;quot;prefixLen&amp;quot;: 32
                        }
                    ]
                },
                &amp;quot;filters&amp;quot;: &amp;amp;#91;
                    {
                        &amp;quot;name&amp;quot;: &amp;quot;istio.metadata_exchange&amp;quot;,
                        &amp;quot;typedConfig&amp;quot;: {
                            &amp;quot;@type&amp;quot;: &amp;quot;type.googleapis.com/udpa.type.v1.TypedStruct&amp;quot;,
                            &amp;quot;typeUrl&amp;quot;: &amp;quot;type.googleapis.com/envoy.tcp.metadataexchange.config.MetadataExchange&amp;quot;,
                            &amp;quot;value&amp;quot;: {
                                &amp;quot;protocol&amp;quot;: &amp;quot;istio-peer-exchange&amp;quot;
                            }
                        }
                    },
                    {
                        &amp;quot;name&amp;quot;: &amp;quot;envoy.http_connection_manager&amp;quot;,
                        &amp;quot;typedConfig&amp;quot;: {
                            &amp;quot;@type&amp;quot;: &amp;quot;type.googleapis.com/envoy.config.filter.network.http_connection_manager.v2.HttpConnectionManager&amp;quot;,
                            &amp;quot;statPrefix&amp;quot;: &amp;quot;inbound_10.244.2.155_9080&amp;quot;,
                            &amp;quot;routeConfig&amp;quot;: {
                                &amp;quot;name&amp;quot;: &amp;quot;inbound|9080|http|productpage.istio-bookinfo.svc.cluster.local&amp;quot;,
                                &amp;quot;virtualHosts&amp;quot;: &amp;amp;#91;
                                    {
                                        &amp;quot;name&amp;quot;: &amp;quot;inbound|http|9080&amp;quot;,
                                        &amp;quot;domains&amp;quot;: &amp;amp;#91;
                                            &amp;quot;*&amp;quot;
                                        ],
                                        &amp;quot;routes&amp;quot;: &amp;amp;#91;
                                            {
                                                &amp;quot;name&amp;quot;: &amp;quot;default&amp;quot;,
                                                &amp;quot;match&amp;quot;: {
                                                    &amp;quot;prefix&amp;quot;: &amp;quot;/&amp;quot;
                                                },
                                                &amp;quot;route&amp;quot;: {
                                                    &amp;quot;cluster&amp;quot;: &amp;quot;inbound|9080|http|productpage.istio-bookinfo.svc.cluster.local&amp;quot;,
                                                    &amp;quot;timeout&amp;quot;: &amp;quot;0s&amp;quot;,
                                                    &amp;quot;maxGrpcTimeout&amp;quot;: &amp;quot;0s&amp;quot;
                                                },
                                                &amp;quot;decorator&amp;quot;: {
                                                    &amp;quot;operation&amp;quot;: &amp;quot;productpage.istio-bookinfo.svc.cluster.local:9080/*&amp;quot;
                                                }
                                            }
                                        ]
                                    }
                                ],
                                &amp;quot;validateClusters&amp;quot;: false
                            },
                            &amp;quot;httpFilters&amp;quot;: &amp;amp;#91;
                                {
                                    &amp;quot;name&amp;quot;: &amp;quot;istio.metadata_exchange&amp;quot;,
                                    &amp;quot;typedConfig&amp;quot;: {
                                        &amp;quot;@type&amp;quot;: &amp;quot;type.googleapis.com/udpa.type.v1.TypedStruct&amp;quot;,
                                        &amp;quot;typeUrl&amp;quot;: &amp;quot;type.googleapis.com/envoy.extensions.filters.http.wasm.v3.Wasm&amp;quot;,
                                        &amp;quot;value&amp;quot;: {
                                            &amp;quot;config&amp;quot;: {
                                                &amp;quot;configuration&amp;quot;: &amp;quot;{}\n&amp;quot;,
                                                &amp;quot;vm_config&amp;quot;: {
                                                    &amp;quot;code&amp;quot;: {
                                                        &amp;quot;local&amp;quot;: {
                                                            &amp;quot;inline_string&amp;quot;: &amp;quot;envoy.wasm.metadata_exchange&amp;quot;
                                                        }
                                                    },
                                                    &amp;quot;runtime&amp;quot;: &amp;quot;envoy.wasm.runtime.null&amp;quot;
                                                }
                                            }
                                        }
                                    }
                                },
                                {
                                    &amp;quot;name&amp;quot;: &amp;quot;istio_authn&amp;quot;,
                                    &amp;quot;typedConfig&amp;quot;: {
                                        &amp;quot;@type&amp;quot;: &amp;quot;type.googleapis.com/istio.envoy.config.filter.http.authn.v2alpha1.FilterConfig&amp;quot;,
                                        &amp;quot;policy&amp;quot;: {
                                            &amp;quot;peers&amp;quot;: &amp;amp;#91;
                                                {
                                                    &amp;quot;mtls&amp;quot;: {
                                                        &amp;quot;mode&amp;quot;: &amp;quot;PERMISSIVE&amp;quot;
                                                    }
                                                }
                                            ]
                                        }
                                    }
                                },
                                {
                                    &amp;quot;name&amp;quot;: &amp;quot;envoy.cors&amp;quot;,
                                    &amp;quot;typedConfig&amp;quot;: {
                                        &amp;quot;@type&amp;quot;: &amp;quot;type.googleapis.com/envoy.config.filter.http.cors.v2.Cors&amp;quot;
                                    }
                                },
                                {
                                    &amp;quot;name&amp;quot;: &amp;quot;envoy.fault&amp;quot;,
                                    &amp;quot;typedConfig&amp;quot;: {
                                        &amp;quot;@type&amp;quot;: &amp;quot;type.googleapis.com/envoy.config.filter.http.fault.v2.HTTPFault&amp;quot;
                                    }
                                },
                                {
                                    &amp;quot;name&amp;quot;: &amp;quot;istio.stats&amp;quot;,
                                    &amp;quot;typedConfig&amp;quot;: {
                                        &amp;quot;@type&amp;quot;: &amp;quot;type.googleapis.com/udpa.type.v1.TypedStruct&amp;quot;,
                                        &amp;quot;typeUrl&amp;quot;: &amp;quot;type.googleapis.com/envoy.extensions.filters.http.wasm.v3.Wasm&amp;quot;,
                                        &amp;quot;value&amp;quot;: {
                                            &amp;quot;config&amp;quot;: {
                                                &amp;quot;configuration&amp;quot;: &amp;quot;{\n  \&amp;quot;debug\&amp;quot;: \&amp;quot;false\&amp;quot;,\n  \&amp;quot;stat_prefix\&amp;quot;: \&amp;quot;istio\&amp;quot;\n}\n&amp;quot;,
                                                &amp;quot;root_id&amp;quot;: &amp;quot;stats_inbound&amp;quot;,
                                                &amp;quot;vm_config&amp;quot;: {
                                                    &amp;quot;code&amp;quot;: {
                                                        &amp;quot;local&amp;quot;: {
                                                            &amp;quot;inline_string&amp;quot;: &amp;quot;envoy.wasm.stats&amp;quot;
                                                        }
                                                    },
                                                    &amp;quot;runtime&amp;quot;: &amp;quot;envoy.wasm.runtime.null&amp;quot;,
                                                    &amp;quot;vm_id&amp;quot;: &amp;quot;stats_inbound&amp;quot;
                                                }
                                            }
                                        }
                                    }
                                },
                                {
                                    &amp;quot;name&amp;quot;: &amp;quot;envoy.router&amp;quot;,
                                    &amp;quot;typedConfig&amp;quot;: {
                                        &amp;quot;@type&amp;quot;: &amp;quot;type.googleapis.com/envoy.config.filter.http.router.v2.Router&amp;quot;
                                    }
                                }
                            ],
                            &amp;quot;tracing&amp;quot;: {
                                &amp;quot;clientSampling&amp;quot;: {
                                    &amp;quot;value&amp;quot;: 100
                                },
                                &amp;quot;randomSampling&amp;quot;: {
                                    &amp;quot;value&amp;quot;: 100
                                },
                                &amp;quot;overallSampling&amp;quot;: {
                                    &amp;quot;value&amp;quot;: 100
                                }
                            },
                            &amp;quot;serverName&amp;quot;: &amp;quot;istio-envoy&amp;quot;,
                            &amp;quot;streamIdleTimeout&amp;quot;: &amp;quot;0s&amp;quot;,
                            &amp;quot;accessLog&amp;quot;: &amp;amp;#91;
                                {
                                    &amp;quot;name&amp;quot;: &amp;quot;envoy.file_access_log&amp;quot;,
                                    &amp;quot;typedConfig&amp;quot;: {
                                        &amp;quot;@type&amp;quot;: &amp;quot;type.googleapis.com/envoy.config.accesslog.v2.FileAccessLog&amp;quot;,
                                        &amp;quot;path&amp;quot;: &amp;quot;/dev/stdout&amp;quot;,
                                        &amp;quot;format&amp;quot;: &amp;quot;&amp;amp;#91;%START_TIME%] \&amp;quot;%REQ(:METHOD)% %REQ(X-ENVOY-ORIGINAL-PATH?:PATH)% %PROTOCOL%\&amp;quot; %RESPONSE_CODE% %RESPONSE_FLAGS% \&amp;quot;%DYNAMIC_METADATA(istio.mixer:status)%\&amp;quot; \&amp;quot;%UPSTREAM_TRANSPORT_FAILURE_REASON%\&amp;quot; %BYTES_RECEIVED% %BYTES_SENT% %DURATION% %RESP(X-ENVOY-UPSTREAM-SERVICE-TIME)% \&amp;quot;%REQ(X-FORWARDED-FOR)%\&amp;quot; \&amp;quot;%REQ(USER-AGENT)%\&amp;quot; \&amp;quot;%REQ(X-REQUEST-ID)%\&amp;quot; \&amp;quot;%REQ(:AUTHORITY)%\&amp;quot; \&amp;quot;%UPSTREAM_HOST%\&amp;quot; %UPSTREAM_CLUSTER% %UPSTREAM_LOCAL_ADDRESS% %DOWNSTREAM_LOCAL_ADDRESS% %DOWNSTREAM_REMOTE_ADDRESS% %REQUESTED_SERVER_NAME% %ROUTE_NAME%\n&amp;quot;
                                    }
                                }
                            ],
                            &amp;quot;useRemoteAddress&amp;quot;: false,
                            &amp;quot;generateRequestId&amp;quot;: true,
                            &amp;quot;forwardClientCertDetails&amp;quot;: &amp;quot;APPEND_FORWARD&amp;quot;,
                            &amp;quot;setCurrentClientCertDetails&amp;quot;: {
                                &amp;quot;subject&amp;quot;: true,
                                &amp;quot;dns&amp;quot;: true,
                                &amp;quot;uri&amp;quot;: true
                            },
                            &amp;quot;upgradeConfigs&amp;quot;: &amp;amp;#91;
                                {
                                    &amp;quot;upgradeType&amp;quot;: &amp;quot;websocket&amp;quot;
                                }
                            ],
                            &amp;quot;normalizePath&amp;quot;: true
                        }
                    }
                ],
                &amp;quot;name&amp;quot;: &amp;quot;10.244.2.155_9080&amp;quot;
            }
        ],
        &amp;quot;listenerFilters&amp;quot;: &amp;amp;#91;
            {
                &amp;quot;name&amp;quot;: &amp;quot;envoy.listener.original_dst&amp;quot;,
                &amp;quot;typedConfig&amp;quot;: {
                    &amp;quot;@type&amp;quot;: &amp;quot;type.googleapis.com/envoy.config.filter.listener.original_dst.v2.OriginalDst&amp;quot;
                }
            },
            {
                &amp;quot;name&amp;quot;: &amp;quot;envoy.listener.tls_inspector&amp;quot;,
                &amp;quot;typedConfig&amp;quot;: {
                    &amp;quot;@type&amp;quot;: &amp;quot;type.googleapis.com/envoy.config.filter.listener.tls_inspector.v2.TlsInspector&amp;quot;
                }
            },
            {
                &amp;quot;name&amp;quot;: &amp;quot;envoy.listener.http_inspector&amp;quot;,
                &amp;quot;typedConfig&amp;quot;: {
                    &amp;quot;@type&amp;quot;: &amp;quot;type.googleapis.com/envoy.config.filter.listener.http_inspector.v2.HttpInspector&amp;quot;
                }
            }
        ],
        &amp;quot;listenerFiltersTimeout&amp;quot;: &amp;quot;1s&amp;quot;,
        &amp;quot;continueOnListenerFiltersTimeout&amp;quot;: true,
        &amp;quot;trafficDirection&amp;quot;: &amp;quot;INBOUND&amp;quot;
    }
]
&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;Check more istio practice detail at my tech blog &lt;a href=&#34;https://imesh.club&#34;&gt;https://imesh.club&lt;/a&gt;&lt;/p&gt;
</content>
    </item>
    
  </channel>
</rss>
