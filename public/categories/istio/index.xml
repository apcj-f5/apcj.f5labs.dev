<?xml version="1.0" encoding="utf-8" standalone="yes"?>
<rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom">
  <channel>
    <title>istio on apcj@f5 blog</title>
    <link>/categories/istio/</link>
    <description>Recent content in istio on apcj@f5 blog</description>
    <generator>Hugo -- gohugo.io</generator>
    <language>en-us</language>
    <lastBuildDate>Sat, 06 Nov 2021 00:00:00 +0000</lastBuildDate><atom:link href="/categories/istio/index.xml" rel="self" type="application/rss+xml" />
    <item>
      <title>Learning Istio | JWT Auth</title>
      <link>/posts/learning-istio/jwt-auth/</link>
      <pubDate>Sat, 06 Nov 2021 00:00:00 +0000</pubDate>
      
      <guid>/posts/learning-istio/jwt-auth/</guid>
      <description>In this post, we will be looking at how Istio handles end user authentication/authorization based on JSON Web Tokens (JWT). JWT is commonly used in OAuth2.0 flows to specify the resources a client has access to, but there are a couple of things to verify before the client is given access:
 Is the JWT issued by the right party Is the client who they claim to be  The logic for the checks above are usually coded into the application.</description>
      <content>&lt;p&gt;In this post, we will be looking at how Istio handles end user authentication/authorization based on JSON Web Tokens (JWT). JWT is commonly used in OAuth2.0 flows to specify the resources a client has access to, but there are a couple of things to verify before the client is given access:&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;Is the JWT issued by the right party&lt;/li&gt;
&lt;li&gt;Is the client who they claim to be&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;The logic for the checks above are usually coded into the application.&lt;/p&gt;
&lt;p&gt;Alternatively, as we will discover in this post, we can simplify the application by offloading this to Istio using the &lt;a href=&#34;https://istio.io/latest/docs/reference/config/security/request_authentication/&#34;&gt;RequestAuthentication&lt;/a&gt; and &lt;a href=&#34;https://istio.io/latest/docs/reference/config/security/authorization-policy/&#34;&gt;AuthorizationPolicy&lt;/a&gt; resources.&lt;/p&gt;
&lt;h1 id=&#34;setup&#34;&gt;Setup&lt;/h1&gt;
&lt;h2 id=&#34;test-application&#34;&gt;Test application&lt;/h2&gt;
&lt;p&gt;For the test application, I will be using the &lt;a href=&#34;https://hub.docker.com/r/kennethreitz/httpbin/&#34;&gt;httpbin&lt;/a&gt; image as it exposes a &lt;code&gt;/headers&lt;/code&gt; endpoint which prints out the headers as seen by the application, allowing us to see the changes done by the sidecar proxy.&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-Bash&#34; data-lang=&#34;Bash&#34;&gt;kubectl apply -f - &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;lt;&amp;lt;EOF
&lt;/span&gt;&lt;span style=&#34;color:#e6db74&#34;&gt;apiVersion: apps/v1
&lt;/span&gt;&lt;span style=&#34;color:#e6db74&#34;&gt;kind: Deployment
&lt;/span&gt;&lt;span style=&#34;color:#e6db74&#34;&gt;metadata:
&lt;/span&gt;&lt;span style=&#34;color:#e6db74&#34;&gt;  labels:
&lt;/span&gt;&lt;span style=&#34;color:#e6db74&#34;&gt;    app: httpbin
&lt;/span&gt;&lt;span style=&#34;color:#e6db74&#34;&gt;  name: httpbin
&lt;/span&gt;&lt;span style=&#34;color:#e6db74&#34;&gt;spec:
&lt;/span&gt;&lt;span style=&#34;color:#e6db74&#34;&gt;  replicas: 1
&lt;/span&gt;&lt;span style=&#34;color:#e6db74&#34;&gt;  selector:
&lt;/span&gt;&lt;span style=&#34;color:#e6db74&#34;&gt;    matchLabels:
&lt;/span&gt;&lt;span style=&#34;color:#e6db74&#34;&gt;      app: httpbin
&lt;/span&gt;&lt;span style=&#34;color:#e6db74&#34;&gt;  template:
&lt;/span&gt;&lt;span style=&#34;color:#e6db74&#34;&gt;    metadata:
&lt;/span&gt;&lt;span style=&#34;color:#e6db74&#34;&gt;      labels:
&lt;/span&gt;&lt;span style=&#34;color:#e6db74&#34;&gt;        app: httpbin
&lt;/span&gt;&lt;span style=&#34;color:#e6db74&#34;&gt;    spec:
&lt;/span&gt;&lt;span style=&#34;color:#e6db74&#34;&gt;      containers:
&lt;/span&gt;&lt;span style=&#34;color:#e6db74&#34;&gt;      - image: kennethreitz/httpbin
&lt;/span&gt;&lt;span style=&#34;color:#e6db74&#34;&gt;        name: httpbin
&lt;/span&gt;&lt;span style=&#34;color:#e6db74&#34;&gt;---
&lt;/span&gt;&lt;span style=&#34;color:#e6db74&#34;&gt;apiVersion: v1
&lt;/span&gt;&lt;span style=&#34;color:#e6db74&#34;&gt;kind: Service
&lt;/span&gt;&lt;span style=&#34;color:#e6db74&#34;&gt;metadata:
&lt;/span&gt;&lt;span style=&#34;color:#e6db74&#34;&gt;  labels:
&lt;/span&gt;&lt;span style=&#34;color:#e6db74&#34;&gt;    app: httpbin
&lt;/span&gt;&lt;span style=&#34;color:#e6db74&#34;&gt;  name: httpbin
&lt;/span&gt;&lt;span style=&#34;color:#e6db74&#34;&gt;spec:
&lt;/span&gt;&lt;span style=&#34;color:#e6db74&#34;&gt;  ports:
&lt;/span&gt;&lt;span style=&#34;color:#e6db74&#34;&gt;  - name: http  # this is important. See Additional Learnings below
&lt;/span&gt;&lt;span style=&#34;color:#e6db74&#34;&gt;    port: 80
&lt;/span&gt;&lt;span style=&#34;color:#e6db74&#34;&gt;    protocol: TCP
&lt;/span&gt;&lt;span style=&#34;color:#e6db74&#34;&gt;    targetPort: 80
&lt;/span&gt;&lt;span style=&#34;color:#e6db74&#34;&gt;  selector:
&lt;/span&gt;&lt;span style=&#34;color:#e6db74&#34;&gt;    app: httpbin
&lt;/span&gt;&lt;span style=&#34;color:#e6db74&#34;&gt;EOF&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;h2 id=&#34;jwt-provider&#34;&gt;JWT provider&lt;/h2&gt;
&lt;p&gt;The JWT used in most of the examples in this post is obtained from Auth0 via the &lt;a href=&#34;https://auth0.com/docs/authorization/flows/call-your-api-using-the-client-credentials-flow&#34;&gt;client credentials flow&lt;/a&gt;:&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-Bash&#34; data-lang=&#34;Bash&#34;&gt;&lt;span style=&#34;color:#75715e&#34;&gt;# Get access token&lt;/span&gt;
$ BASE_URL&lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt;https://leonseng.au.auth0.com
$ APP_CLIENT_ID&lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt;&amp;lt;Auth0 app client ID&amp;gt;
$ APP_CLIENT_SECRET&lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt;&amp;lt;Auth0 app client secret&amp;gt;
$ API_IDENTIFIER&lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt;&amp;lt;Auth0 API identifier&amp;gt;
$ ACCESS_TOKEN&lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt;&lt;span style=&#34;color:#66d9ef&#34;&gt;$(&lt;/span&gt;curl -s --request POST &lt;span style=&#34;color:#ae81ff&#34;&gt;\
&lt;/span&gt;&lt;span style=&#34;color:#ae81ff&#34;&gt;&lt;/span&gt;  --url &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;&lt;/span&gt;$BASE_URL&lt;span style=&#34;color:#e6db74&#34;&gt;/oauth/token&amp;#34;&lt;/span&gt; &lt;span style=&#34;color:#ae81ff&#34;&gt;\
&lt;/span&gt;&lt;span style=&#34;color:#ae81ff&#34;&gt;&lt;/span&gt;  --header &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#39;content-type: application/x-www-form-urlencoded&amp;#39;&lt;/span&gt; &lt;span style=&#34;color:#ae81ff&#34;&gt;\
&lt;/span&gt;&lt;span style=&#34;color:#ae81ff&#34;&gt;&lt;/span&gt;  --data grant_type&lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt;client_credentials &lt;span style=&#34;color:#ae81ff&#34;&gt;\
&lt;/span&gt;&lt;span style=&#34;color:#ae81ff&#34;&gt;&lt;/span&gt;  --data client_id&lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt;$APP_CLIENT_ID &lt;span style=&#34;color:#ae81ff&#34;&gt;\
&lt;/span&gt;&lt;span style=&#34;color:#ae81ff&#34;&gt;&lt;/span&gt;  --data client_secret&lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt;$APP_CLIENT_SECRET &lt;span style=&#34;color:#ae81ff&#34;&gt;\
&lt;/span&gt;&lt;span style=&#34;color:#ae81ff&#34;&gt;&lt;/span&gt;  --data audience&lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt;$API_IDENTIFIER | jq -r .access_token&lt;span style=&#34;color:#66d9ef&#34;&gt;)&lt;/span&gt;

&lt;span style=&#34;color:#75715e&#34;&gt;# Check content of JWT&lt;/span&gt;
$ jq -R &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#39;split(&amp;#34;.&amp;#34;) | .[0],.[1] | @base64d | fromjson&amp;#39;&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;&amp;lt;&amp;lt;&lt;/span&gt; &lt;span style=&#34;color:#66d9ef&#34;&gt;$(&lt;/span&gt;echo $ACCESS_TOKEN&lt;span style=&#34;color:#66d9ef&#34;&gt;)&lt;/span&gt;
&lt;span style=&#34;color:#f92672&#34;&gt;{&lt;/span&gt;
  &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;alg&amp;#34;&lt;/span&gt;: &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;RS256&amp;#34;&lt;/span&gt;,
  &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;typ&amp;#34;&lt;/span&gt;: &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;JWT&amp;#34;&lt;/span&gt;,
  &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;kid&amp;#34;&lt;/span&gt;: &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;qv9xb5h9OYy-uJgVyDEyx&amp;#34;&lt;/span&gt;
&lt;span style=&#34;color:#f92672&#34;&gt;}&lt;/span&gt;
&lt;span style=&#34;color:#f92672&#34;&gt;{&lt;/span&gt;
  &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;iss&amp;#34;&lt;/span&gt;: &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;https://leonseng.au.auth0.com/&amp;#34;&lt;/span&gt;,
  &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;sub&amp;#34;&lt;/span&gt;: &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;QWPjwvmVTLVJiQejcPJim0CKR3pxtgd3@clients&amp;#34;&lt;/span&gt;,
  &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;aud&amp;#34;&lt;/span&gt;: &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;istio-jwt-test&amp;#34;&lt;/span&gt;,
  &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;iat&amp;#34;&lt;/span&gt;: 1636331240,
  &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;exp&amp;#34;&lt;/span&gt;: 1636331300,
  &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;azp&amp;#34;&lt;/span&gt;: &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;QWPjwvmVTLVJiQejcPJim0CKR3pxtgd3&amp;#34;&lt;/span&gt;,
  &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;scope&amp;#34;&lt;/span&gt;: &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;read:database write:database&amp;#34;&lt;/span&gt;,
  &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;gty&amp;#34;&lt;/span&gt;: &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;client-credentials&amp;#34;&lt;/span&gt;
&lt;span style=&#34;color:#f92672&#34;&gt;}&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;h1 id=&#34;requestauthentication&#34;&gt;RequestAuthentication&lt;/h1&gt;
&lt;p&gt;Istio&amp;rsquo;s &lt;a href=&#34;https://istio.io/latest/docs/reference/config/security/request_authentication/&#34;&gt;RequestAuthentication&lt;/a&gt; is responsible for validating the JWT in a request is signed by the expected issuer, and that the payload has not been tampered with.&lt;/p&gt;
&lt;p&gt;Below is an example where we specify the JWT issuer and the JSON Web Key Set (JWKS) for JWT validation. The decoded JWT payload can be passed onto the application in a HTTP header via the &lt;code&gt;outputPayloadToHeader&lt;/code&gt; field, allowing application to access the trusted claim without having to perform token validation itself.&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-Bash&#34; data-lang=&#34;Bash&#34;&gt;kubectl apply -f - &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;lt;&amp;lt;EOF
&lt;/span&gt;&lt;span style=&#34;color:#e6db74&#34;&gt;apiVersion: security.istio.io/v1beta1
&lt;/span&gt;&lt;span style=&#34;color:#e6db74&#34;&gt;kind: RequestAuthentication
&lt;/span&gt;&lt;span style=&#34;color:#e6db74&#34;&gt;metadata:
&lt;/span&gt;&lt;span style=&#34;color:#e6db74&#34;&gt;  name: &amp;#34;httpbin-jwt-req-auth&amp;#34;
&lt;/span&gt;&lt;span style=&#34;color:#e6db74&#34;&gt;spec:
&lt;/span&gt;&lt;span style=&#34;color:#e6db74&#34;&gt;  selector:
&lt;/span&gt;&lt;span style=&#34;color:#e6db74&#34;&gt;    matchLabels:
&lt;/span&gt;&lt;span style=&#34;color:#e6db74&#34;&gt;      app: httpbin
&lt;/span&gt;&lt;span style=&#34;color:#e6db74&#34;&gt;  jwtRules:
&lt;/span&gt;&lt;span style=&#34;color:#e6db74&#34;&gt;  - issuer: &amp;#34;https://leonseng.au.auth0.com/&amp;#34;
&lt;/span&gt;&lt;span style=&#34;color:#e6db74&#34;&gt;    jwksUri: &amp;#34;https://leonseng.au.auth0.com/.well-known/jwks.json&amp;#34;
&lt;/span&gt;&lt;span style=&#34;color:#e6db74&#34;&gt;    outputPayloadToHeader: x-jwt-payload
&lt;/span&gt;&lt;span style=&#34;color:#e6db74&#34;&gt;EOF&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;Here&amp;rsquo;s a test to show that our request with the right JWT can go through&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-Bash&#34; data-lang=&#34;Bash&#34;&gt;$ RESPONSE&lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt;&lt;span style=&#34;color:#66d9ef&#34;&gt;$(&lt;/span&gt;curl -s -H &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;Authorization: Bearer &lt;/span&gt;$ACCESS_TOKEN&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;&lt;/span&gt; httpbin/headers&lt;span style=&#34;color:#66d9ef&#34;&gt;)&lt;/span&gt;
$ echo $RESPONSE | jq .
&lt;span style=&#34;color:#f92672&#34;&gt;{&lt;/span&gt;
  &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;headers&amp;#34;&lt;/span&gt;: &lt;span style=&#34;color:#f92672&#34;&gt;{&lt;/span&gt;
    &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;Accept&amp;#34;&lt;/span&gt;: &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;*/*&amp;#34;&lt;/span&gt;,
    &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;Content-Length&amp;#34;&lt;/span&gt;: &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;0&amp;#34;&lt;/span&gt;,
    &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;Host&amp;#34;&lt;/span&gt;: &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;httpbin&amp;#34;&lt;/span&gt;,
    &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;User-Agent&amp;#34;&lt;/span&gt;: &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;curl/7.79.1-DEV&amp;#34;&lt;/span&gt;,
    &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;X-B3-Parentspanid&amp;#34;&lt;/span&gt;: &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;40f941f2847fb38d&amp;#34;&lt;/span&gt;,
    &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;X-B3-Sampled&amp;#34;&lt;/span&gt;: &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;0&amp;#34;&lt;/span&gt;,
    &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;X-B3-Spanid&amp;#34;&lt;/span&gt;: &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;7c93024a6eb09cf5&amp;#34;&lt;/span&gt;,
    &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;X-B3-Traceid&amp;#34;&lt;/span&gt;: &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;38ab74cb85a129d240f941f2847fb38d&amp;#34;&lt;/span&gt;,
    &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;X-Envoy-Attempt-Count&amp;#34;&lt;/span&gt;: &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;1&amp;#34;&lt;/span&gt;,
    &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;X-Forwarded-Client-Cert&amp;#34;&lt;/span&gt;: &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;By=spiffe://cluster.local/ns/default/sa/default;Hash=dc1fd96b48b91947ef1bfeeb6a9755164343eb982eeb2d29373e3521a90350dc;Subject=\&amp;#34;\&amp;#34;;URI=spiffe://cluster.local/ns/default/sa/default&amp;#34;&lt;/span&gt;,
    &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;X-Jwt-Payload&amp;#34;&lt;/span&gt;: &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;eyJpc3MiOiJodHRwczovL2xlb25zZW5nLmF1LmF1dGgwLmNvbS8iLCJzdWIiOiJRV1Bqd3ZtVlRMVkppUWVqY1BKaW0wQ0tSM3B4dGdkM0BjbGllbnRzIiwiYXVkIjoiaXN0aW8tand0LXRlc3QiLCJpYXQiOjE2MzY0MjkwODUsImV4cCI6MTYzNjUxNTQ4NSwiYXpwIjoiUVdQand2bVZUTFZKaVFlamNQSmltMENLUjNweHRnZDMiLCJzY29wZSI6InJlYWQ6ZGF0YWJhc2Ugd3JpdGU6ZGF0YWJhc2UiLCJndHkiOiJjbGllbnQtY3JlZGVudGlhbHMifQ&amp;#34;&lt;/span&gt;
  &lt;span style=&#34;color:#f92672&#34;&gt;}&lt;/span&gt;
&lt;span style=&#34;color:#f92672&#34;&gt;}&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;We can see that the decoded payload is accessible by the application in the &lt;code&gt;X-Jwt-Payload&lt;/code&gt; header after performing a base64 decode&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-Bash&#34; data-lang=&#34;Bash&#34;&gt;$ FORWARDED_PAYLOAD&lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt;&lt;span style=&#34;color:#66d9ef&#34;&gt;$(&lt;/span&gt;echo $RESPONSE | jq -r &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#39;.headers.&amp;#34;X-Jwt-Payload&amp;#34;&amp;#39;&lt;/span&gt;&lt;span style=&#34;color:#66d9ef&#34;&gt;)&lt;/span&gt;
$ echo $FORWARDED_PAYLOAD | base64 -d | jq .
base64: invalid input
&lt;span style=&#34;color:#f92672&#34;&gt;{&lt;/span&gt;
  &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;iss&amp;#34;&lt;/span&gt;: &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;https://leonseng.au.auth0.com/&amp;#34;&lt;/span&gt;,
  &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;sub&amp;#34;&lt;/span&gt;: &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;QWPjwvmVTLVJiQejcPJim0CKR3pxtgd3@clients&amp;#34;&lt;/span&gt;,
  &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;aud&amp;#34;&lt;/span&gt;: &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;istio-jwt-test&amp;#34;&lt;/span&gt;,
  &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;iat&amp;#34;&lt;/span&gt;: 1636429085,
  &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;exp&amp;#34;&lt;/span&gt;: 1636515485,
  &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;azp&amp;#34;&lt;/span&gt;: &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;QWPjwvmVTLVJiQejcPJim0CKR3pxtgd3&amp;#34;&lt;/span&gt;,
  &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;scope&amp;#34;&lt;/span&gt;: &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;read:database write:database&amp;#34;&lt;/span&gt;,
  &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;gty&amp;#34;&lt;/span&gt;: &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;client-credentials&amp;#34;&lt;/span&gt;
&lt;span style=&#34;color:#f92672&#34;&gt;}&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;Malformed, expired and JWT issued by other issuers will be rejected:&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-Bash&#34; data-lang=&#34;Bash&#34;&gt;&lt;span style=&#34;color:#75715e&#34;&gt;# Malformed token&lt;/span&gt;
$ curl -s -H &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;Authorization: Bearer bad&amp;#34;&lt;/span&gt; httpbin/headers
Jwt is not in the form of Header.Payload.Signature with two dots and &lt;span style=&#34;color:#ae81ff&#34;&gt;3&lt;/span&gt; sections

&lt;span style=&#34;color:#75715e&#34;&gt;# Expired token&lt;/span&gt;
$ curl -s -H &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;Authorization: Bearer &lt;/span&gt;$ACCESS_TOKEN&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;&lt;/span&gt; httpbin/headers
Jwt is expired

&lt;span style=&#34;color:#75715e&#34;&gt;# Valid JWT from another issuer - jwt.io&lt;/span&gt;
INVALID_TOKEN&lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt;eyJhbGciOiJSUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIxMjM0NTY3ODkwIiwibmFtZSI6IkpvaG4gRG9lIiwiYWRtaW4iOnRydWUsImlhdCI6MTUxNjIzOTAyMn0.NHVaYe26MbtOYhSKkoKYdFVomg4i8ZJd8_-RU8VNbftc4TSMb4bXP3l3YlNWACwyXPGffz5aXHc6lty1Y2t4SWRqGteragsVdZufDn5BlnJl9pdR_kdVFUsra2rWKEofkZeIC4yWytE58sMIihvo9H1ScmmVwBcQP6XETqYd0aSHp1gOa9RdUPDvoXQ5oqygTqVtxaDr6wUFKrKItgBMzWIdNZ6y7O9E0DhEPTbE9rfBo6KTFsHAZnMg4k68CDp2woYIaXbmYTWcvbzIuHO7_37GT79XdIwkm95QJ7hYC9RiwrV7mesbY4PAahERJawntho0my942XheVLmGwLMBkQ
$ curl -s -H &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;Authorization: Bearer &lt;/span&gt;$INVALID_TOKEN&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;&lt;/span&gt; httpbin/headers
Jwks doesn&lt;span style=&#34;color:#960050;background-color:#1e0010&#34;&gt;&amp;#39;&lt;/span&gt;t have key to match kid or alg from Jwt
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;Requests without JWT is expected to fail, but &lt;strong&gt;it didn&amp;rsquo;t&lt;/strong&gt;&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-Bash&#34; data-lang=&#34;Bash&#34;&gt;$ curl -s httpbin/headers
&lt;span style=&#34;color:#f92672&#34;&gt;{&lt;/span&gt;
  &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;headers&amp;#34;&lt;/span&gt;: &lt;span style=&#34;color:#f92672&#34;&gt;{&lt;/span&gt;
    &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;Accept&amp;#34;&lt;/span&gt;: &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;*/*&amp;#34;&lt;/span&gt;,
    &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;Content-Length&amp;#34;&lt;/span&gt;: &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;0&amp;#34;&lt;/span&gt;,
    &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;Host&amp;#34;&lt;/span&gt;: &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;httpbin&amp;#34;&lt;/span&gt;,
    &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;User-Agent&amp;#34;&lt;/span&gt;: &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;curl/7.79.1-DEV&amp;#34;&lt;/span&gt;,
    &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;X-B3-Parentspanid&amp;#34;&lt;/span&gt;: &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;de8e7a515c92e784&amp;#34;&lt;/span&gt;,
    &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;X-B3-Sampled&amp;#34;&lt;/span&gt;: &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;0&amp;#34;&lt;/span&gt;,
    &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;X-B3-Spanid&amp;#34;&lt;/span&gt;: &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;a2994910ea2fd7f2&amp;#34;&lt;/span&gt;,
    &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;X-B3-Traceid&amp;#34;&lt;/span&gt;: &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;11f49e2d3230c711de8e7a515c92e784&amp;#34;&lt;/span&gt;,
    &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;X-Envoy-Attempt-Count&amp;#34;&lt;/span&gt;: &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;1&amp;#34;&lt;/span&gt;,
    &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;X-Forwarded-Client-Cert&amp;#34;&lt;/span&gt;: &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;By=spiffe://cluster.local/ns/default/sa/default;Hash=b01278f0dac370955d49f07b1484118c6581fea591a3843d5ccd341ef7b872e6;Subject=\&amp;#34;\&amp;#34;;URI=spiffe://cluster.local/ns/default/sa/default&amp;#34;&lt;/span&gt;
  &lt;span style=&#34;color:#f92672&#34;&gt;}&lt;/span&gt;
&lt;span style=&#34;color:#f92672&#34;&gt;}&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;This was unexpected to me, but it is a &lt;a href=&#34;https://istio.io/latest/docs/reference/config/security/request_authentication/&#34;&gt;documented behaviour&lt;/a&gt;:&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;A request that does not contain any authentication credentials will be accepted but will not have any authenticated identity. To restrict access to authenticated requests only, this should be accompanied by an authorization rule.&lt;/p&gt;
&lt;/blockquote&gt;
&lt;hr&gt;
&lt;h1 id=&#34;authorizationpolicy&#34;&gt;AuthorizationPolicy&lt;/h1&gt;
&lt;p&gt;&lt;a href=&#34;https://istio.io/latest/docs/reference/config/security/authorization-policy/&#34;&gt;AuthorizationPolicy&lt;/a&gt; further extends RBAC through the configuration of more granular rules, covering:&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;&lt;a href=&#34;#who-is-the-requester&#34;&gt;who is the requester&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;#what-is-the-requester-trying-to-do&#34;&gt;what the requester is trying to do&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;#additional-conditions-in-the-jwt&#34;&gt;additional conditions in the JWT&lt;/a&gt;&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;Below is an example which we will be using&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-Bash&#34; data-lang=&#34;Bash&#34;&gt;kubectl apply -f - &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;lt;&amp;lt;EOF
&lt;/span&gt;&lt;span style=&#34;color:#e6db74&#34;&gt;apiVersion: security.istio.io/v1beta1
&lt;/span&gt;&lt;span style=&#34;color:#e6db74&#34;&gt;kind: AuthorizationPolicy
&lt;/span&gt;&lt;span style=&#34;color:#e6db74&#34;&gt;metadata:
&lt;/span&gt;&lt;span style=&#34;color:#e6db74&#34;&gt;  name: httpbin-authz-policy
&lt;/span&gt;&lt;span style=&#34;color:#e6db74&#34;&gt;spec:
&lt;/span&gt;&lt;span style=&#34;color:#e6db74&#34;&gt;  selector:
&lt;/span&gt;&lt;span style=&#34;color:#e6db74&#34;&gt;    matchLabels:
&lt;/span&gt;&lt;span style=&#34;color:#e6db74&#34;&gt;      app: httpbin
&lt;/span&gt;&lt;span style=&#34;color:#e6db74&#34;&gt;  rules:
&lt;/span&gt;&lt;span style=&#34;color:#e6db74&#34;&gt;  - from:
&lt;/span&gt;&lt;span style=&#34;color:#e6db74&#34;&gt;    - source:
&lt;/span&gt;&lt;span style=&#34;color:#e6db74&#34;&gt;        requestPrincipals: [&amp;#34;https://leonseng.au.auth0.com//QWPjwvmVTLVJiQejcPJim0CKR3pxtgd3@clients&amp;#34;]
&lt;/span&gt;&lt;span style=&#34;color:#e6db74&#34;&gt;    to:
&lt;/span&gt;&lt;span style=&#34;color:#e6db74&#34;&gt;    - operation:
&lt;/span&gt;&lt;span style=&#34;color:#e6db74&#34;&gt;        methods: [&amp;#34;GET&amp;#34;]
&lt;/span&gt;&lt;span style=&#34;color:#e6db74&#34;&gt;        paths: [&amp;#34;/headers&amp;#34;]
&lt;/span&gt;&lt;span style=&#34;color:#e6db74&#34;&gt;    when:
&lt;/span&gt;&lt;span style=&#34;color:#e6db74&#34;&gt;    - key: request.auth.claims[aud]
&lt;/span&gt;&lt;span style=&#34;color:#e6db74&#34;&gt;      values: [&amp;#34;httpbin&amp;#34;]
&lt;/span&gt;&lt;span style=&#34;color:#e6db74&#34;&gt;    - key: request.auth.claims[scope]
&lt;/span&gt;&lt;span style=&#34;color:#e6db74&#34;&gt;      values: [&amp;#34;write:database, fetch:email&amp;#34;]
&lt;/span&gt;&lt;span style=&#34;color:#e6db74&#34;&gt;EOF&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;A quick test to verify that it hasn&amp;rsquo;t broken our setup&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-Bash&#34; data-lang=&#34;Bash&#34;&gt;$ curl -s -H &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;Authorization: Bearer &lt;/span&gt;$ACCESS_TOKEN&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;&lt;/span&gt; httpbin/headers
&lt;span style=&#34;color:#f92672&#34;&gt;{&lt;/span&gt;
  &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;headers&amp;#34;&lt;/span&gt;: &lt;span style=&#34;color:#f92672&#34;&gt;{&lt;/span&gt;
    &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;Accept&amp;#34;&lt;/span&gt;: &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;*/*&amp;#34;&lt;/span&gt;,
    &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;Content-Length&amp;#34;&lt;/span&gt;: &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;0&amp;#34;&lt;/span&gt;,
    &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;Host&amp;#34;&lt;/span&gt;: &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;httpbin&amp;#34;&lt;/span&gt;,
    &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;User-Agent&amp;#34;&lt;/span&gt;: &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;curl/7.79.1-DEV&amp;#34;&lt;/span&gt;,
    &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;X-B3-Parentspanid&amp;#34;&lt;/span&gt;: &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;60c70087740ac4fa&amp;#34;&lt;/span&gt;,
    &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;X-B3-Sampled&amp;#34;&lt;/span&gt;: &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;0&amp;#34;&lt;/span&gt;,
    &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;X-B3-Spanid&amp;#34;&lt;/span&gt;: &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;a4f01ac9e90d5ac5&amp;#34;&lt;/span&gt;,
    &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;X-B3-Traceid&amp;#34;&lt;/span&gt;: &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;afcacf8ed3355d7160c70087740ac4fa&amp;#34;&lt;/span&gt;,
    &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;X-Envoy-Attempt-Count&amp;#34;&lt;/span&gt;: &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;1&amp;#34;&lt;/span&gt;,
    &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;X-Forwarded-Client-Cert&amp;#34;&lt;/span&gt;: &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;By=spiffe://cluster.local/ns/default/sa/default;Hash=72d075873d9fb6b17553f5b428fac8ad0168162e917b74f44c42b7e145267507;Subject=\&amp;#34;\&amp;#34;;URI=spiffe://cluster.local/ns/default/sa/default&amp;#34;&lt;/span&gt;,
    &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;X-Jwt-Payload&amp;#34;&lt;/span&gt;: &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;eyJpc3MiOiJodHRwczovL2xlb25zZW5nLmF1LmF1dGgwLmNvbS8iLCJzdWIiOiJRV1Bqd3ZtVlRMVkppUWVqY1BKaW0wQ0tSM3B4dGdkM0BjbGllbnRzIiwiYXVkIjoiaXN0aW8tand0LXRlc3QiLCJpYXQiOjE2MzYzNzUxNDMsImV4cCI6MTYzNjQ2MTU0MywiYXpwIjoiUVdQand2bVZUTFZKaVFlamNQSmltMENLUjNweHRnZDMiLCJzY29wZSI6InJlYWQ6ZGF0YWJhc2Ugd3JpdGU6ZGF0YWJhc2UiLCJndHkiOiJjbGllbnQtY3JlZGVudGlhbHMifQ&amp;#34;&lt;/span&gt;
  &lt;span style=&#34;color:#f92672&#34;&gt;}&lt;/span&gt;
&lt;span style=&#34;color:#f92672&#34;&gt;}&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;h2 id=&#34;who-is-the-requester&#34;&gt;Who is the requester&lt;/h2&gt;
&lt;p&gt;The identity of the requester using JWT can be specified in the &lt;code&gt;requestPrincipals&lt;/code&gt; field as documented &lt;a href=&#34;https://istio.io/latest/docs/reference/config/security/authorization-policy/#Source&#34;&gt;here&lt;/a&gt;. Istio constructs the identity from the JWT payload values in the format of &lt;code&gt;&amp;lt;iss&amp;gt;/&amp;lt;sub&amp;gt;&lt;/code&gt;. However, if you just want to enforce the presence of a valid JWT (regardless of the identity), &lt;code&gt;requestPrincipals&lt;/code&gt; can be set to &lt;code&gt;[*]&lt;/code&gt;.&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-YAML&#34; data-lang=&#34;YAML&#34;&gt;&lt;span style=&#34;color:#f92672&#34;&gt;from&lt;/span&gt;:
- &lt;span style=&#34;color:#f92672&#34;&gt;source&lt;/span&gt;:
    &lt;span style=&#34;color:#f92672&#34;&gt;requestPrincipals&lt;/span&gt;: [&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;https://leonseng.au.auth0.com//QWPjwvmVTLVJiQejcPJim0CKR3pxtgd3@clients&amp;#34;&lt;/span&gt;]  &lt;span style=&#34;color:#75715e&#34;&gt;# iss/sub&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;Requests without a JWT or with a different user/subject will be denied&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-Bash&#34; data-lang=&#34;Bash&#34;&gt;&lt;span style=&#34;color:#75715e&#34;&gt;# No JWT provided&lt;/span&gt;
$ curl -s httpbin/headers
RBAC: access denied

&lt;span style=&#34;color:#75715e&#34;&gt;# JWT with different user/subject&lt;/span&gt;
$ jq -R &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#39;split(&amp;#34;.&amp;#34;) | .[0],.[1] | @base64d | fromjson&amp;#39;&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;&amp;lt;&amp;lt;&lt;/span&gt; &lt;span style=&#34;color:#66d9ef&#34;&gt;$(&lt;/span&gt;echo $ACCESS_TOKEN&lt;span style=&#34;color:#66d9ef&#34;&gt;)&lt;/span&gt;
&lt;span style=&#34;color:#f92672&#34;&gt;{&lt;/span&gt;
  &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;alg&amp;#34;&lt;/span&gt;: &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;RS256&amp;#34;&lt;/span&gt;,
  &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;typ&amp;#34;&lt;/span&gt;: &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;JWT&amp;#34;&lt;/span&gt;,
  &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;kid&amp;#34;&lt;/span&gt;: &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;qv9xb5h9OYy-uJgVyDEyx&amp;#34;&lt;/span&gt;
&lt;span style=&#34;color:#f92672&#34;&gt;}&lt;/span&gt;
&lt;span style=&#34;color:#f92672&#34;&gt;{&lt;/span&gt;
  &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;iss&amp;#34;&lt;/span&gt;: &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;https://leonseng.au.auth0.com/&amp;#34;&lt;/span&gt;,
  &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;sub&amp;#34;&lt;/span&gt;: &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;uoPlJVCJID9UxJS1jdOMPcr9Gmz2TGgP@clients&amp;#34;&lt;/span&gt;,
  &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;aud&amp;#34;&lt;/span&gt;: &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;istio-jwt-test&amp;#34;&lt;/span&gt;,
  &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;iat&amp;#34;&lt;/span&gt;: 1636375387,
  &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;exp&amp;#34;&lt;/span&gt;: 1636461787,
  &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;azp&amp;#34;&lt;/span&gt;: &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;uoPlJVCJID9UxJS1jdOMPcr9Gmz2TGgP&amp;#34;&lt;/span&gt;,
  &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;scope&amp;#34;&lt;/span&gt;: &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;read:database write:database&amp;#34;&lt;/span&gt;,
  &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;gty&amp;#34;&lt;/span&gt;: &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;client-credentials&amp;#34;&lt;/span&gt;
&lt;span style=&#34;color:#f92672&#34;&gt;}&lt;/span&gt;
$ curl -s -H &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;Authorization: Bearer &lt;/span&gt;$ACCESS_TOKEN&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;&lt;/span&gt; httpbin/headers
RBAC: access denied
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;h2 id=&#34;what-is-the-requester-trying-to-do&#34;&gt;What is the requester trying to do&lt;/h2&gt;
&lt;p&gt;Next, we can &lt;a href=&#34;https://istio.io/latest/docs/reference/config/security/authorization-policy/#Operation&#34;&gt;restrict which HTTP verbs and path a requester has access to&lt;/a&gt;. In our example, we are only allowing &lt;code&gt;GET&lt;/code&gt; requests to &lt;code&gt;/headers&lt;/code&gt; path&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-YAML&#34; data-lang=&#34;YAML&#34;&gt;&lt;span style=&#34;color:#f92672&#34;&gt;to&lt;/span&gt;:
- &lt;span style=&#34;color:#f92672&#34;&gt;operation&lt;/span&gt;:
    &lt;span style=&#34;color:#f92672&#34;&gt;methods&lt;/span&gt;: [&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;GET&amp;#34;&lt;/span&gt;]
    &lt;span style=&#34;color:#f92672&#34;&gt;paths&lt;/span&gt;: [&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;/headers&amp;#34;&lt;/span&gt;]
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;Request using another HTTP verb and/or accessing another path will not be allowed&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-Bash&#34; data-lang=&#34;Bash&#34;&gt;&lt;span style=&#34;color:#75715e&#34;&gt;# POST to /post&lt;/span&gt;
$ curl -s -X POST -H &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;Authorization: Bearer &lt;/span&gt;$ACCESS_TOKEN&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;&lt;/span&gt; httpbin/post
RBAC: access denied
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;h2 id=&#34;additional-conditions-in-the-jwt&#34;&gt;Additional conditions in the JWT&lt;/h2&gt;
&lt;p&gt;Lastly, Istio also enables the evaluation of additional &lt;a href=&#34;https://istio.io/latest/docs/reference/config/security/conditions/&#34;&gt;conditions against the JWT claims&lt;/a&gt;. The &lt;code&gt;AuthorizationPolicy&lt;/code&gt; applied is checking against the claims in the JWT payload&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-Bash&#34; data-lang=&#34;Bash&#34;&gt;when:
- key: request.auth.claims&lt;span style=&#34;color:#f92672&#34;&gt;[&lt;/span&gt;aud&lt;span style=&#34;color:#f92672&#34;&gt;]&lt;/span&gt;
  values: &lt;span style=&#34;color:#f92672&#34;&gt;[&lt;/span&gt;&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;istio-jwt-test&amp;#34;&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;]&lt;/span&gt;
- key: request.auth.claims&lt;span style=&#34;color:#f92672&#34;&gt;[&lt;/span&gt;scope&lt;span style=&#34;color:#f92672&#34;&gt;]&lt;/span&gt;
  values: &lt;span style=&#34;color:#f92672&#34;&gt;[&lt;/span&gt;&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;write:database&amp;#34;&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;]&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;In this example, we send a request with the scope &lt;code&gt;read:database&lt;/code&gt;, which will be rejected as the &lt;code&gt;AuthorizationPolicy&lt;/code&gt; is expecting a &lt;code&gt;write:database&lt;/code&gt; scope&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-Bash&#34; data-lang=&#34;Bash&#34;&gt;$ jq -R &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#39;split(&amp;#34;.&amp;#34;) | .[0],.[1] | @base64d | fromjson&amp;#39;&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;&amp;lt;&amp;lt;&lt;/span&gt; &lt;span style=&#34;color:#66d9ef&#34;&gt;$(&lt;/span&gt;echo $ACCESS_TOKEN&lt;span style=&#34;color:#66d9ef&#34;&gt;)&lt;/span&gt;
&lt;span style=&#34;color:#f92672&#34;&gt;{&lt;/span&gt;
  &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;alg&amp;#34;&lt;/span&gt;: &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;RS256&amp;#34;&lt;/span&gt;,
  &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;typ&amp;#34;&lt;/span&gt;: &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;JWT&amp;#34;&lt;/span&gt;,
  &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;kid&amp;#34;&lt;/span&gt;: &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;qv9xb5h9OYy-uJgVyDEyx&amp;#34;&lt;/span&gt;
&lt;span style=&#34;color:#f92672&#34;&gt;}&lt;/span&gt;
&lt;span style=&#34;color:#f92672&#34;&gt;{&lt;/span&gt;
  &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;iss&amp;#34;&lt;/span&gt;: &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;https://leonseng.au.auth0.com/&amp;#34;&lt;/span&gt;,
  &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;sub&amp;#34;&lt;/span&gt;: &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;xYvKrg4QHLA5bsna0Hg1MYiD3itPY1gC@clients&amp;#34;&lt;/span&gt;,
  &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;aud&amp;#34;&lt;/span&gt;: &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;istio-jwt-test&amp;#34;&lt;/span&gt;,
  &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;iat&amp;#34;&lt;/span&gt;: 1636376574,
  &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;exp&amp;#34;&lt;/span&gt;: 1636462974,
  &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;azp&amp;#34;&lt;/span&gt;: &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;xYvKrg4QHLA5bsna0Hg1MYiD3itPY1gC&amp;#34;&lt;/span&gt;,
  &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;scope&amp;#34;&lt;/span&gt;: &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;read:database&amp;#34;&lt;/span&gt;,
  &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;gty&amp;#34;&lt;/span&gt;: &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;client-credentials&amp;#34;&lt;/span&gt;
&lt;span style=&#34;color:#f92672&#34;&gt;}&lt;/span&gt;
$ curl -s -X POST -H &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;Authorization: Bearer &lt;/span&gt;$ACCESS_TOKEN&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;&lt;/span&gt; httpbin/post
RBAC: access denied
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;hr&gt;
&lt;h1 id=&#34;additional-learnings&#34;&gt;Additional learnings&lt;/h1&gt;
&lt;p&gt;Here&amp;rsquo;s a list of things that were picked up during my tests that weren&amp;rsquo;t immediately intuitive:&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;Istio requires the port name in the &lt;code&gt;Service&lt;/code&gt; to be prefixed with the protocol as described &lt;a href=&#34;https://istio.io/latest/docs/ops/configuration/traffic-management/protocol-selection/&#34;&gt;here&lt;/a&gt;. Failing to adhere to the naming convention will break the authentication feature provided by the &lt;a href=&#34;https://istio.io/latest/docs/reference/config/security/request_authentication/&#34;&gt;RequestAuthentication&lt;/a&gt; resource. This can be caught by running &lt;code&gt;istioctl analyze&lt;/code&gt; in the application namespace, which reveals a &lt;a href=&#34;https://istio.io/latest/docs/reference/config/analysis/ist0118/&#34;&gt;PortNameIsNotUnderNamingConvention&lt;/a&gt; message:
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-Bash&#34; data-lang=&#34;Bash&#34;&gt;$ istioctl analyze
&amp;lt;snipped&amp;gt;
Info &lt;span style=&#34;color:#f92672&#34;&gt;[&lt;/span&gt;IST0118&lt;span style=&#34;color:#f92672&#34;&gt;]&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;(&lt;/span&gt;Service httpbin.default&lt;span style=&#34;color:#f92672&#34;&gt;)&lt;/span&gt; Port name &lt;span style=&#34;color:#f92672&#34;&gt;(&lt;/span&gt;port: 80, targetPort: 80&lt;span style=&#34;color:#f92672&#34;&gt;)&lt;/span&gt; doesn&lt;span style=&#34;color:#960050;background-color:#1e0010&#34;&gt;&amp;#39;&lt;/span&gt;t follow the naming convention of Istio port.
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/li&gt;
&lt;li&gt;Defining a &lt;a href=&#34;https://istio.io/latest/docs/reference/config/security/request_authentication/&#34;&gt;RequestAuthentication&lt;/a&gt; alone does not stop requests without JWT, the requests just won&amp;rsquo;t have identities tied to them. Augment it with a &lt;a href=&#34;https://istio.io/latest/docs/reference/config/security/authorization-policy/&#34;&gt;AuthorizationPolicy&lt;/a&gt; to enforce the presence of JWT.&lt;/li&gt;
&lt;li&gt;The &lt;code&gt;scope&lt;/code&gt; field in a JWT can contain multiple scopes in a space delimited format,
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-JSON&#34; data-lang=&#34;JSON&#34;&gt;&lt;span style=&#34;color:#960050;background-color:#1e0010&#34;&gt;scope:&lt;/span&gt; &lt;span style=&#34;color:#960050;background-color:#1e0010&#34;&gt;read:database&lt;/span&gt; &lt;span style=&#34;color:#960050;background-color:#1e0010&#34;&gt;write:database&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;Fortunately, Istio recognizes that and separates the string into multiple scopes. This allows us to match individual scopes from the &lt;code&gt;scope&lt;/code&gt; field without having to do string manipulations.&lt;/li&gt;
&lt;li&gt;To assist with troubleshooting, set the log level for the &lt;code&gt;jwt&lt;/code&gt; and &lt;code&gt;rbac&lt;/code&gt; loggers to &lt;code&gt;debug&lt;/code&gt;, which will produce more logs on JWT validation and RBAC enforcement in the application sidecar proxy.
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-Bash&#34; data-lang=&#34;Bash&#34;&gt;istioctl proxy-config log &lt;span style=&#34;color:#66d9ef&#34;&gt;$(&lt;/span&gt;k get pods -l app&lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt;httpbin -o jsonpath&lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt;&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#39;{.items[*].metadata.name}&amp;#39;&lt;/span&gt;&lt;span style=&#34;color:#66d9ef&#34;&gt;)&lt;/span&gt; --level jwt:debug rbac:debug
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/li&gt;
&lt;/ol&gt;
</content>
    </item>
    
    <item>
      <title>Learning Istio | Ingress</title>
      <link>/posts/learning-istio/ingress/</link>
      <pubDate>Mon, 02 Aug 2021 16:25:55 +1000</pubDate>
      
      <guid>/posts/learning-istio/ingress/</guid>
      <description>In the previous post, we deployed the Bookinfo application on a k3s cluster with Istio enabled. In this post, we will explore the features on Istio Ingress.
Kubernetes Ingress Istio should handle Kubernetes Ingress resource just fine as documented here.
Here we create a Kubernetes Ingress to access the Bookinfo application. Note the additional annotation kubernetes.io/ingress.class: istio:
kubectl -n bookinfo apply -f - &amp;lt;&amp;lt;EOF apiVersion: networking.k8s.io/v1 kind: Ingress metadata: annotations: kubernetes.</description>
      <content>&lt;p&gt;In the previous &lt;a href=&#34;/posts/learning-istio/01-setup/&#34;&gt;post&lt;/a&gt;, we deployed the &lt;a href=&#34;https://istio.io/latest/docs/examples/bookinfo/#deploying-the-application&#34;&gt;Bookinfo&lt;/a&gt; application on a k3s cluster with Istio enabled. In this post, we will explore the features on Istio Ingress.&lt;/p&gt;
&lt;h1 id=&#34;kubernetes-ingress&#34;&gt;Kubernetes Ingress&lt;/h1&gt;
&lt;p&gt;Istio should handle &lt;a href=&#34;https://kubernetes.io/docs/concepts/services-networking/ingress/&#34;&gt;Kubernetes Ingress&lt;/a&gt; resource just fine as documented &lt;a href=&#34;https://istio.io/latest/docs/tasks/traffic-management/ingress/kubernetes-ingress/&#34;&gt;here&lt;/a&gt;.&lt;/p&gt;
&lt;p&gt;Here we create a Kubernetes Ingress to access the Bookinfo application. Note the additional annotation &lt;code&gt;kubernetes.io/ingress.class: istio&lt;/code&gt;:&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-Bash&#34; data-lang=&#34;Bash&#34;&gt;kubectl -n bookinfo apply -f - &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;lt;&amp;lt;EOF
&lt;/span&gt;&lt;span style=&#34;color:#e6db74&#34;&gt;apiVersion: networking.k8s.io/v1
&lt;/span&gt;&lt;span style=&#34;color:#e6db74&#34;&gt;kind: Ingress
&lt;/span&gt;&lt;span style=&#34;color:#e6db74&#34;&gt;metadata:
&lt;/span&gt;&lt;span style=&#34;color:#e6db74&#34;&gt;  annotations:
&lt;/span&gt;&lt;span style=&#34;color:#e6db74&#34;&gt;    kubernetes.io/ingress.class: istio
&lt;/span&gt;&lt;span style=&#34;color:#e6db74&#34;&gt;  name: productpage-k8s-ingress
&lt;/span&gt;&lt;span style=&#34;color:#e6db74&#34;&gt;spec:
&lt;/span&gt;&lt;span style=&#34;color:#e6db74&#34;&gt;  rules:
&lt;/span&gt;&lt;span style=&#34;color:#e6db74&#34;&gt;  - http:
&lt;/span&gt;&lt;span style=&#34;color:#e6db74&#34;&gt;      paths:
&lt;/span&gt;&lt;span style=&#34;color:#e6db74&#34;&gt;      - path: /productpage
&lt;/span&gt;&lt;span style=&#34;color:#e6db74&#34;&gt;        pathType: Exact
&lt;/span&gt;&lt;span style=&#34;color:#e6db74&#34;&gt;        backend:
&lt;/span&gt;&lt;span style=&#34;color:#e6db74&#34;&gt;          service:
&lt;/span&gt;&lt;span style=&#34;color:#e6db74&#34;&gt;            name: productpage
&lt;/span&gt;&lt;span style=&#34;color:#e6db74&#34;&gt;            port:
&lt;/span&gt;&lt;span style=&#34;color:#e6db74&#34;&gt;              number: 9080
&lt;/span&gt;&lt;span style=&#34;color:#e6db74&#34;&gt;      - path: /static
&lt;/span&gt;&lt;span style=&#34;color:#e6db74&#34;&gt;        pathType: Prefix
&lt;/span&gt;&lt;span style=&#34;color:#e6db74&#34;&gt;        backend:
&lt;/span&gt;&lt;span style=&#34;color:#e6db74&#34;&gt;          service:
&lt;/span&gt;&lt;span style=&#34;color:#e6db74&#34;&gt;            name: productpage
&lt;/span&gt;&lt;span style=&#34;color:#e6db74&#34;&gt;            port:
&lt;/span&gt;&lt;span style=&#34;color:#e6db74&#34;&gt;              number: 9080
&lt;/span&gt;&lt;span style=&#34;color:#e6db74&#34;&gt;      - path: /login
&lt;/span&gt;&lt;span style=&#34;color:#e6db74&#34;&gt;        pathType: Exact
&lt;/span&gt;&lt;span style=&#34;color:#e6db74&#34;&gt;        backend:
&lt;/span&gt;&lt;span style=&#34;color:#e6db74&#34;&gt;          service:
&lt;/span&gt;&lt;span style=&#34;color:#e6db74&#34;&gt;            name: productpage
&lt;/span&gt;&lt;span style=&#34;color:#e6db74&#34;&gt;            port:
&lt;/span&gt;&lt;span style=&#34;color:#e6db74&#34;&gt;              number: 9080
&lt;/span&gt;&lt;span style=&#34;color:#e6db74&#34;&gt;      - path: /logout
&lt;/span&gt;&lt;span style=&#34;color:#e6db74&#34;&gt;        pathType: Exact
&lt;/span&gt;&lt;span style=&#34;color:#e6db74&#34;&gt;        backend:
&lt;/span&gt;&lt;span style=&#34;color:#e6db74&#34;&gt;          service:
&lt;/span&gt;&lt;span style=&#34;color:#e6db74&#34;&gt;            name: productpage
&lt;/span&gt;&lt;span style=&#34;color:#e6db74&#34;&gt;            port:
&lt;/span&gt;&lt;span style=&#34;color:#e6db74&#34;&gt;              number: 9080
&lt;/span&gt;&lt;span style=&#34;color:#e6db74&#34;&gt;      - path: /api/v1/products
&lt;/span&gt;&lt;span style=&#34;color:#e6db74&#34;&gt;        pathType: Prefix
&lt;/span&gt;&lt;span style=&#34;color:#e6db74&#34;&gt;        backend:
&lt;/span&gt;&lt;span style=&#34;color:#e6db74&#34;&gt;          service:
&lt;/span&gt;&lt;span style=&#34;color:#e6db74&#34;&gt;            name: productpage
&lt;/span&gt;&lt;span style=&#34;color:#e6db74&#34;&gt;            port:
&lt;/span&gt;&lt;span style=&#34;color:#e6db74&#34;&gt;              number: 9080
&lt;/span&gt;&lt;span style=&#34;color:#e6db74&#34;&gt;EOF&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;The application is now exposed through the Istio ingress gateway on port 80, which in turn is exposed on port 8080 via the k3d configuration. Verify that it is working by browsing to &lt;a href=&#34;http://localhost:8080/productpage&#34;&gt;http://localhost:8080/productpage&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;To verify that the route has been configured on the Istio ingress gateway, first get the name of the &lt;code&gt;route&lt;/code&gt; created by the Ingress:&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-Bash&#34; data-lang=&#34;Bash&#34;&gt;$ ISTIO_INGRESS_GW_POD&lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt;&lt;span style=&#34;color:#66d9ef&#34;&gt;$(&lt;/span&gt;kubectl -n istio-system get pods -l app&lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt;istio-ingressgateway -o jsonpath&lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt;&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#39;{.items[*].metadata.name}&amp;#39;&lt;/span&gt;&lt;span style=&#34;color:#66d9ef&#34;&gt;)&lt;/span&gt;
$ istioctl proxy-config routes -n istio-system $ISTIO_INGRESS_GW_POD
NAME        DOMAINS     MATCH                  VIRTUAL SERVICE
http.80     *           /productpage           -productpage-k8s-ingress-istio-autogenerated-k8s-ingress.bookinfo
            *           /healthz/ready*
            *           /stats/prometheus*
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;In the example above, we see &lt;code&gt;http.80&lt;/code&gt; is the route created for our ingress matching &lt;code&gt;/productpage&lt;/code&gt;. We can then print out the details of the route by name&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-Bash&#34; data-lang=&#34;Bash&#34;&gt;$ istioctl proxy-config routes -n istio-system $ISTIO_INGRESS_GW_POD --name http.80 -o yaml
- name: http.80
  validateClusters: false
  virtualHosts:
  - domains:
    - &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#39;*&amp;#39;&lt;/span&gt;
    includeRequestAttemptCount: true
    name: &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#39;*:80&amp;#39;&lt;/span&gt;
    routes:
    - decorator:
        operation: productpage.bookinfo.svc.cluster.local:9080/productpage
      match:
        caseSensitive: true
        path: /productpage
      metadata:
        filterMetadata:
          istio:
            config: /apis/networking.istio.io/v1alpha3/namespaces/bookinfo/virtual-service/-productpage-k8s-ingress-istio-autogenerated-k8s-ingress
      route:
        cluster: outbound|9080&lt;span style=&#34;color:#f92672&#34;&gt;||&lt;/span&gt;productpage.bookinfo.svc.cluster.local
        maxGrpcTimeout: 0s
        retryPolicy:
          hostSelectionRetryMaxAttempts: &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;5&amp;#34;&lt;/span&gt;
          numRetries: &lt;span style=&#34;color:#ae81ff&#34;&gt;2&lt;/span&gt;
          retriableStatusCodes:
          - &lt;span style=&#34;color:#ae81ff&#34;&gt;503&lt;/span&gt;
          retryHostPredicate:
          - name: envoy.retry_host_predicates.previous_hosts
          retryOn: connect-failure,refused-stream,unavailable,cancelled,retriable-status-codes
        timeout: 0s
&amp;lt;output truncated&amp;gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;Alternatively, you can go all out and get a config dump from the ingress gateway (which is basically Envoy) by exposing the Envoy admin port &lt;code&gt;15000&lt;/code&gt;&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-Bash&#34; data-lang=&#34;Bash&#34;&gt;kubectl -n istio-system port-forward $ISTIO_INGRESS_GW_POD &lt;span style=&#34;color:#ae81ff&#34;&gt;15000&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;and calling the &lt;code&gt;config_dump&lt;/code&gt; API in a separate terminal&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-Bash&#34; data-lang=&#34;Bash&#34;&gt;curl localhost:15000/config_dump
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;h1 id=&#34;istio-gateway-and-virtual-service&#34;&gt;Istio Gateway and Virtual Service&lt;/h1&gt;
&lt;p&gt;Istio offers the &lt;code&gt;Gateway&lt;/code&gt; and &lt;code&gt;VirtualService&lt;/code&gt; CRDs for better control of ingress traffic.&lt;/p&gt;
&lt;p&gt;We start by deploying the &lt;code&gt;Gateway&lt;/code&gt; and &lt;code&gt;VirtualService&lt;/code&gt; resources&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-Bash&#34; data-lang=&#34;Bash&#34;&gt;kubectl -n bookinfo apply -f - &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;lt;&amp;lt;EOF
&lt;/span&gt;&lt;span style=&#34;color:#e6db74&#34;&gt;apiVersion: networking.istio.io/v1alpha3
&lt;/span&gt;&lt;span style=&#34;color:#e6db74&#34;&gt;kind: Gateway
&lt;/span&gt;&lt;span style=&#34;color:#e6db74&#34;&gt;metadata:
&lt;/span&gt;&lt;span style=&#34;color:#e6db74&#34;&gt;  name: bookinfo-gateway
&lt;/span&gt;&lt;span style=&#34;color:#e6db74&#34;&gt;spec:
&lt;/span&gt;&lt;span style=&#34;color:#e6db74&#34;&gt;  selector:
&lt;/span&gt;&lt;span style=&#34;color:#e6db74&#34;&gt;    istio: ingressgateway # use istio default controller
&lt;/span&gt;&lt;span style=&#34;color:#e6db74&#34;&gt;  servers:
&lt;/span&gt;&lt;span style=&#34;color:#e6db74&#34;&gt;  - port:
&lt;/span&gt;&lt;span style=&#34;color:#e6db74&#34;&gt;      number: 80
&lt;/span&gt;&lt;span style=&#34;color:#e6db74&#34;&gt;      name: http
&lt;/span&gt;&lt;span style=&#34;color:#e6db74&#34;&gt;      protocol: HTTP
&lt;/span&gt;&lt;span style=&#34;color:#e6db74&#34;&gt;    hosts:
&lt;/span&gt;&lt;span style=&#34;color:#e6db74&#34;&gt;    - &amp;#34;*&amp;#34;
&lt;/span&gt;&lt;span style=&#34;color:#e6db74&#34;&gt;---
&lt;/span&gt;&lt;span style=&#34;color:#e6db74&#34;&gt;apiVersion: networking.istio.io/v1alpha3
&lt;/span&gt;&lt;span style=&#34;color:#e6db74&#34;&gt;kind: VirtualService
&lt;/span&gt;&lt;span style=&#34;color:#e6db74&#34;&gt;metadata:
&lt;/span&gt;&lt;span style=&#34;color:#e6db74&#34;&gt;  name: bookinfo
&lt;/span&gt;&lt;span style=&#34;color:#e6db74&#34;&gt;spec:
&lt;/span&gt;&lt;span style=&#34;color:#e6db74&#34;&gt;  hosts:
&lt;/span&gt;&lt;span style=&#34;color:#e6db74&#34;&gt;  - &amp;#34;*&amp;#34;
&lt;/span&gt;&lt;span style=&#34;color:#e6db74&#34;&gt;  gateways:
&lt;/span&gt;&lt;span style=&#34;color:#e6db74&#34;&gt;  - bookinfo-gateway
&lt;/span&gt;&lt;span style=&#34;color:#e6db74&#34;&gt;  http:
&lt;/span&gt;&lt;span style=&#34;color:#e6db74&#34;&gt;  - match:
&lt;/span&gt;&lt;span style=&#34;color:#e6db74&#34;&gt;    - uri:
&lt;/span&gt;&lt;span style=&#34;color:#e6db74&#34;&gt;        exact: /productpage
&lt;/span&gt;&lt;span style=&#34;color:#e6db74&#34;&gt;    - uri:
&lt;/span&gt;&lt;span style=&#34;color:#e6db74&#34;&gt;        prefix: /static
&lt;/span&gt;&lt;span style=&#34;color:#e6db74&#34;&gt;    - uri:
&lt;/span&gt;&lt;span style=&#34;color:#e6db74&#34;&gt;        exact: /login
&lt;/span&gt;&lt;span style=&#34;color:#e6db74&#34;&gt;    - uri:
&lt;/span&gt;&lt;span style=&#34;color:#e6db74&#34;&gt;        exact: /logout
&lt;/span&gt;&lt;span style=&#34;color:#e6db74&#34;&gt;    - uri:
&lt;/span&gt;&lt;span style=&#34;color:#e6db74&#34;&gt;        prefix: /api/v1/products
&lt;/span&gt;&lt;span style=&#34;color:#e6db74&#34;&gt;    route:
&lt;/span&gt;&lt;span style=&#34;color:#e6db74&#34;&gt;    - destination:
&lt;/span&gt;&lt;span style=&#34;color:#e6db74&#34;&gt;        host: productpage
&lt;/span&gt;&lt;span style=&#34;color:#e6db74&#34;&gt;        port:
&lt;/span&gt;&lt;span style=&#34;color:#e6db74&#34;&gt;          number: 9080
&lt;/span&gt;&lt;span style=&#34;color:#e6db74&#34;&gt;EOF&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;Verify that the appropriate routes are created:&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-Bash&#34; data-lang=&#34;Bash&#34;&gt;$ istioctl proxy-config routes -n istio-system $ISTIO_INGRESS_GW_POD
NAME        DOMAINS     MATCH                  VIRTUAL SERVICE
http.80     *           /productpage           -productpage-k8s-ingress-istio-autogenerated-k8s-ingress.bookinfo
http.80     *           /static/*              -productpage-k8s-ingress-istio-autogenerated-k8s-ingress.bookinfo
http.80     *           /login                 -productpage-k8s-ingress-istio-autogenerated-k8s-ingress.bookinfo
http.80     *           /logout                -productpage-k8s-ingress-istio-autogenerated-k8s-ingress.bookinfo
http.80     *           /api/v1/products/*     -productpage-k8s-ingress-istio-autogenerated-k8s-ingress.bookinfo
http.80     *           /productpage           bookinfo.bookinfo
http.80     *           /static*               bookinfo.bookinfo
http.80     *           /login                 bookinfo.bookinfo
http.80     *           /logout                bookinfo.bookinfo
http.80     *           /api/v1/products*      bookinfo.bookinfo
            *           /healthz/ready*
            *           /stats/prometheus*
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;Notice that we now have 2 sets of routes, 1 from Kubernetes Ingress and another from the Istio VirtualService. According to Envoy&amp;rsquo;s &lt;a href=&#34;https://www.envoyproxy.io/docs/envoy/latest/configuration/http/http_conn_man/route_matching&#34;&gt;route matching&lt;/a&gt; rules, they are evaluated in order, so the routes introduced by the Ingress resource still has priority.&lt;/p&gt;
&lt;p&gt;Let&amp;rsquo;s verify this by changing the target port for /productpage in the &lt;code&gt;productpage-k8s-ingress&lt;/code&gt; Ingress to something else&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-Bash&#34; data-lang=&#34;Bash&#34;&gt;kubectl -n bookinfo patch ingress productpage-k8s-ingress -p &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#39;{
&lt;/span&gt;&lt;span style=&#34;color:#e6db74&#34;&gt;  &amp;#34;spec&amp;#34;: {
&lt;/span&gt;&lt;span style=&#34;color:#e6db74&#34;&gt;    &amp;#34;rules&amp;#34;: [
&lt;/span&gt;&lt;span style=&#34;color:#e6db74&#34;&gt;      {
&lt;/span&gt;&lt;span style=&#34;color:#e6db74&#34;&gt;        &amp;#34;http&amp;#34;: {
&lt;/span&gt;&lt;span style=&#34;color:#e6db74&#34;&gt;          &amp;#34;paths&amp;#34;: [
&lt;/span&gt;&lt;span style=&#34;color:#e6db74&#34;&gt;            {
&lt;/span&gt;&lt;span style=&#34;color:#e6db74&#34;&gt;              &amp;#34;path&amp;#34;: &amp;#34;/productpage&amp;#34;,
&lt;/span&gt;&lt;span style=&#34;color:#e6db74&#34;&gt;              &amp;#34;pathType&amp;#34;: &amp;#34;Exact&amp;#34;,
&lt;/span&gt;&lt;span style=&#34;color:#e6db74&#34;&gt;              &amp;#34;backend&amp;#34;: {
&lt;/span&gt;&lt;span style=&#34;color:#e6db74&#34;&gt;                &amp;#34;service&amp;#34;: {
&lt;/span&gt;&lt;span style=&#34;color:#e6db74&#34;&gt;                  &amp;#34;name&amp;#34;: &amp;#34;productpage&amp;#34;,
&lt;/span&gt;&lt;span style=&#34;color:#e6db74&#34;&gt;                  &amp;#34;port&amp;#34;: {
&lt;/span&gt;&lt;span style=&#34;color:#e6db74&#34;&gt;                    &amp;#34;number&amp;#34;: 10080
&lt;/span&gt;&lt;span style=&#34;color:#e6db74&#34;&gt;                  }
&lt;/span&gt;&lt;span style=&#34;color:#e6db74&#34;&gt;                }
&lt;/span&gt;&lt;span style=&#34;color:#e6db74&#34;&gt;              }
&lt;/span&gt;&lt;span style=&#34;color:#e6db74&#34;&gt;            }
&lt;/span&gt;&lt;span style=&#34;color:#e6db74&#34;&gt;          ]
&lt;/span&gt;&lt;span style=&#34;color:#e6db74&#34;&gt;        }
&lt;/span&gt;&lt;span style=&#34;color:#e6db74&#34;&gt;      }
&lt;/span&gt;&lt;span style=&#34;color:#e6db74&#34;&gt;    ]
&lt;/span&gt;&lt;span style=&#34;color:#e6db74&#34;&gt;  }
&lt;/span&gt;&lt;span style=&#34;color:#e6db74&#34;&gt;}&amp;#39;&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;Attempting to browse to &lt;a href=&#34;http://localhost:8080/productpage&#34;&gt;http://localhost:8080/productpage&lt;/a&gt; will now fail as expected since the &lt;code&gt;productpage-k8s-ingress&lt;/code&gt; Ingress configuration is wrong.&lt;/p&gt;
&lt;p&gt;Now that we have observed this behaviour of Envoy route matching, we can remove the &lt;code&gt;productpage-k8s-ingress&lt;/code&gt; Ingress, and have Istio&amp;rsquo;s Gateway and VirtualService to take effect&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-Bash&#34; data-lang=&#34;Bash&#34;&gt;kubectl -n bookinfo delete ingress productpage-k8s-ingress
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;The &lt;a href=&#34;http://localhost:8080/productpage&#34;&gt;productpage&lt;/a&gt; should now work again.&lt;/p&gt;
&lt;h1 id=&#34;learnings&#34;&gt;Learnings&lt;/h1&gt;
&lt;ul&gt;
&lt;li&gt;Istio can handle Kubernetes Ingress once the &lt;code&gt;kubernetes.io/ingress.class: istio&lt;/code&gt; annotation has been added&lt;/li&gt;
&lt;li&gt;Viewing the Ingress gateway routes&lt;/li&gt;
&lt;li&gt;Ingress gateway route matching behaviour&lt;/li&gt;
&lt;/ul&gt;
</content>
    </item>
    
    <item>
      <title>Istio | Sidecar iptables and traffic steering detail</title>
      <link>/posts/istio-traffic-control-deepdive/</link>
      <pubDate>Thu, 25 Jun 2020 00:00:00 +0000</pubDate>
      
      <guid>/posts/istio-traffic-control-deepdive/</guid>
      <description>How istio manipulates traffic.</description>
      <content>&lt;h2 id=&#34;istio-injected-iptables&#34;&gt;Istio injected iptables&lt;/h2&gt;
&lt;p&gt;Istio implements the hijacking and processing of traffic by injecting the init container and envoy proxy container into the business pod. After the init container runs, the following NAT table rules for iptables will be generated in the corresponding linux namespace&lt;/p&gt;
&lt;pre tabindex=&#34;0&#34;&gt;&lt;code&gt;&amp;amp;#91;root@k8s-node1-v1-16 ~]# iptables -t nat -L -v
Chain PREROUTING (policy ACCEPT 192K packets, 12M bytes)
 pkts bytes target     prot opt in     out     source               destination
 192K   12M ISTIO_INBOUND  tcp  --  any    any     anywhere             anywhere

Chain INPUT (policy ACCEPT 192K packets, 12M bytes)
 pkts bytes target     prot opt in     out     source               destination

Chain OUTPUT (policy ACCEPT 40673 packets, 3694K bytes)
 pkts bytes target     prot opt in     out     source               destination
 8917  535K ISTIO_OUTPUT  tcp  --  any    any     anywhere             anywhere

Chain POSTROUTING (policy ACCEPT 40673 packets, 3694K bytes)
 pkts bytes target     prot opt in     out     source               destination

Chain ISTIO_INBOUND (1 references)
 pkts bytes target     prot opt in     out     source               destination
    0     0 RETURN     tcp  --  any    any     anywhere             anywhere             tcp dpt:ssh
  356 21360 RETURN     tcp  --  any    any     anywhere             anywhere             tcp dpt:15090
 192K   11M RETURN     tcp  --  any    any     anywhere             anywhere             tcp dpt:15021
    0     0 RETURN     tcp  --  any    any     anywhere             anywhere             tcp dpt:15020
   34  2040 ISTIO_IN_REDIRECT  tcp  --  any    any     anywhere             anywhere

Chain ISTIO_IN_REDIRECT (3 references)
 pkts bytes target     prot opt in     out     source               destination
   34  2040 REDIRECT   tcp  --  any    any     anywhere             anywhere             redir ports 15006

Chain ISTIO_OUTPUT (1 references)
 pkts bytes target     prot opt in     out     source               destination
    0     0 RETURN     all  --  any    lo      127.0.0.6            anywhere    
    0     0 ISTIO_IN_REDIRECT  all  --  any    lo      anywhere            !localhost            owner UID match 1337
    0     0 RETURN     all  --  any    lo      anywhere             anywhere             ! owner UID match 1337
 8917  535K RETURN     all  --  any    any     anywhere             anywhere             owner UID match 1337
    0     0 ISTIO_IN_REDIRECT  all  --  any    lo      anywhere            !localhost            owner GID match 1337
    0     0 RETURN     all  --  any    lo      anywhere             anywhere             ! owner GID match 1337
    0     0 RETURN     all  --  any    any     anywhere             anywhere             owner GID match 1337
    0     0 RETURN     all  --  any    any     anywhere             localhost
    0     0 ISTIO_REDIRECT  all  --  any    any     anywhere             anywhere

Chain ISTIO_REDIRECT (1 references)
 pkts bytes target     prot opt in     out     source               destination
    0     0 REDIRECT   tcp  --  any    any     anywhere             anywhere             redir ports 15001
&lt;/code&gt;&lt;/pre&gt;&lt;h2 id=&#34;outbound-flow-control&#34;&gt;Outbound flow control&lt;/h2&gt;
&lt;p&gt;When the business container sends the request to the outside, such as productpage to reviews: 9080 port access, this connection will be redirected by iptables to port 127.0.0.1:115001, and then processed by envoy.&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;REDIRECT
This target is only valid in the nat table, in the PREROUTING and OUTPUT chains, and user-defined chains which are only called from those chains. It redirects the packet to the machine itself by changing the destination IP to the primary address of the incoming interface (locally-generated packets are mapped to the localhost address, 127.0.0.1 for IPv4 and ::1 for IPv6).&lt;/p&gt;
&lt;p&gt;&lt;a href=&#34;https://ipset.netfilter.org/iptables-extensions.man.html#lbDK&#34;&gt;https://ipset.netfilter.org/iptables-extensions.man.html#lbDK&lt;/a&gt;&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;The virtualOutbound in envoy will be hit. This is a special listener. It contains the Original Destination listener filter. Note &amp;ldquo;useOriginalDst&amp;rdquo;: truethat after such configuration in the following configuration , envoy will re-find the matching listener in the configuration. If found, press the hit. The listener performs follow-up processing. If it cannot find it, it sends the request to the cluster in this listener. Here is a passthrough cluster. This cluster will forward the packet directly to the fourth layer.&lt;/p&gt;
&lt;pre tabindex=&#34;0&#34;&gt;&lt;code&gt;root@k8s-master-v1-16 ~]# istioctl proxy-config listener productpage-v1-7f4cc988c6-qxqjs.istio-bookinfo --port 15001 -o json
&amp;amp;#91;
    {
        &amp;quot;name&amp;quot;: &amp;quot;virtualOutbound&amp;quot;,
        &amp;quot;address&amp;quot;: {
            &amp;quot;socketAddress&amp;quot;: {
                &amp;quot;address&amp;quot;: &amp;quot;0.0.0.0&amp;quot;,
                &amp;quot;portValue&amp;quot;: 15001
            }
        },
        &amp;quot;filterChains&amp;quot;: &amp;amp;#91;
            {
                &amp;quot;filters&amp;quot;: &amp;amp;#91;
                    {
                        &amp;quot;name&amp;quot;: &amp;quot;istio.stats&amp;quot;,
                        &amp;quot;typedConfig&amp;quot;: {
                            &amp;quot;@type&amp;quot;: &amp;quot;type.googleapis.com/udpa.type.v1.TypedStruct&amp;quot;,
                            &amp;quot;typeUrl&amp;quot;: &amp;quot;type.googleapis.com/envoy.extensions.filters.network.wasm.v3.Wasm&amp;quot;,
                            &amp;quot;value&amp;quot;: {
                                &amp;quot;config&amp;quot;: {
                                    &amp;quot;configuration&amp;quot;: &amp;quot;{\n  \&amp;quot;debug\&amp;quot;: \&amp;quot;false\&amp;quot;,\n  \&amp;quot;stat_prefix\&amp;quot;: \&amp;quot;istio\&amp;quot;\n}\n&amp;quot;,
                                    &amp;quot;root_id&amp;quot;: &amp;quot;stats_outbound&amp;quot;,
                                    &amp;quot;vm_config&amp;quot;: {
                                        &amp;quot;code&amp;quot;: {
                                            &amp;quot;local&amp;quot;: {
                                                &amp;quot;inline_string&amp;quot;: &amp;quot;envoy.wasm.stats&amp;quot;
                                            }
                                        },
                                        &amp;quot;runtime&amp;quot;: &amp;quot;envoy.wasm.runtime.null&amp;quot;,
                                        &amp;quot;vm_id&amp;quot;: &amp;quot;tcp_stats_outbound&amp;quot;
                                    }
                                }
                            }
                        }
                    },
                    {
                        &amp;quot;name&amp;quot;: &amp;quot;envoy.tcp_proxy&amp;quot;,
                        &amp;quot;typedConfig&amp;quot;: {
                            &amp;quot;@type&amp;quot;: &amp;quot;type.googleapis.com/envoy.config.filter.network.tcp_proxy.v2.TcpProxy&amp;quot;,
                            &amp;quot;statPrefix&amp;quot;: &amp;quot;PassthroughCluster&amp;quot;,
                            &amp;quot;cluster&amp;quot;: &amp;quot;PassthroughCluster&amp;quot;,
                            &amp;quot;accessLog&amp;quot;: &amp;amp;#91;
                                {
                                    &amp;quot;name&amp;quot;: &amp;quot;envoy.file_access_log&amp;quot;,
                                    &amp;quot;typedConfig&amp;quot;: {
                                        &amp;quot;@type&amp;quot;: &amp;quot;type.googleapis.com/envoy.config.accesslog.v2.FileAccessLog&amp;quot;,
                                        &amp;quot;path&amp;quot;: &amp;quot;/dev/stdout&amp;quot;,
                                        &amp;quot;format&amp;quot;: &amp;quot;&amp;amp;#91;%START_TIME%] \&amp;quot;%REQ(:METHOD)% %REQ(X-ENVOY-ORIGINAL-PATH?:PATH)% %PROTOCOL%\&amp;quot; %RESPONSE_CODE% %RESPONSE_FLAGS% \&amp;quot;%DYNAMIC_METADATA(istio.mixer:status)%\&amp;quot; \&amp;quot;%UPSTREAM_TRANSPORT_FAILURE_REASON%\&amp;quot; %BYTES_RECEIVED% %BYTES_SENT% %DURATION% %RESP(X-ENVOY-UPSTREAM-SERVICE-TIME)% \&amp;quot;%REQ(X-FORWARDED-FOR)%\&amp;quot; \&amp;quot;%REQ(USER-AGENT)%\&amp;quot; \&amp;quot;%REQ(X-REQUEST-ID)%\&amp;quot; \&amp;quot;%REQ(:AUTHORITY)%\&amp;quot; \&amp;quot;%UPSTREAM_HOST%\&amp;quot; %UPSTREAM_CLUSTER% %UPSTREAM_LOCAL_ADDRESS% %DOWNSTREAM_LOCAL_ADDRESS% %DOWNSTREAM_REMOTE_ADDRESS% %REQUESTED_SERVER_NAME% %ROUTE_NAME%\n&amp;quot;
                                    }
                                }
                            ]
                        }
                    }
                ],
                &amp;quot;name&amp;quot;: &amp;quot;virtualOutbound-catchall-tcp&amp;quot;
            }
        ],
        &amp;quot;useOriginalDst&amp;quot;: true,
        &amp;quot;trafficDirection&amp;quot;: &amp;quot;OUTBOUND&amp;quot;
    }
]
&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;The above listener will hand over the connection to the listener that matches the original destination IP and port. In the bookinfo example, it will be handed over to the 9080 listener. There is a question to consider here. From the perspective of envoy, the destination port of this link is already 15001, why can it match the following port 0.0.0.0:9080. This is because the NAT is done in the system kernel when iptables is redirected. The system kernel has this converted storage. Envoy obtains the real destination port through getsockopt() , so that it can correctly match the business listener.&lt;/p&gt;
&lt;pre tabindex=&#34;0&#34;&gt;&lt;code&gt;&amp;amp;#91;root@k8s-master-v1-16 ~]# istioctl proxy-config listener productpage-v1-7f4cc988c6-qxqjs.istio-bookinfo --port 9080 -o json
&amp;amp;#91;
    {
        &amp;quot;name&amp;quot;: &amp;quot;0.0.0.0_9080&amp;quot;,
        &amp;quot;address&amp;quot;: {
            &amp;quot;socketAddress&amp;quot;: {
                &amp;quot;address&amp;quot;: &amp;quot;0.0.0.0&amp;quot;,
                &amp;quot;portValue&amp;quot;: 9080
            }
        },
        &amp;quot;filterChains&amp;quot;: &amp;amp;#91;
            {
                &amp;quot;filterChainMatch&amp;quot;: {
                    &amp;quot;applicationProtocols&amp;quot;: &amp;amp;#91;
                        &amp;quot;http/1.0&amp;quot;,
                        &amp;quot;http/1.1&amp;quot;,
                        &amp;quot;h2c&amp;quot;
                    ]
                },
                &amp;quot;filters&amp;quot;: &amp;amp;#91;
                    {
                        &amp;quot;name&amp;quot;: &amp;quot;envoy.http_connection_manager&amp;quot;,
                        &amp;quot;typedConfig&amp;quot;: {
                            &amp;quot;@type&amp;quot;: &amp;quot;type.googleapis.com/envoy.config.filter.network.http_connection_manager.v2.HttpConnectionManager&amp;quot;,
                            &amp;quot;statPrefix&amp;quot;: &amp;quot;outbound_0.0.0.0_9080&amp;quot;,
                            &amp;quot;rds&amp;quot;: {
                                &amp;quot;configSource&amp;quot;: {
                                    &amp;quot;ads&amp;quot;: {}
                                },
                                &amp;quot;routeConfigName&amp;quot;: &amp;quot;9080&amp;quot;
                            },
&lt;/code&gt;&lt;/pre&gt;&lt;pre tabindex=&#34;0&#34;&gt;&lt;code&gt;&amp;amp;#91;root@k8s-master-v1-16 ~]# istioctl proxy-config listener productpage-v1-7f4cc988c6-qxqjs.istio-bookinfo
ADDRESS            PORT      TYPE
10.102.252.88      15012     TCP
10.96.122.225      31400     TCP
10.96.0.10         53        TCP
10.110.88.185      15443     TCP
10.96.122.225      15443     TCP
10.110.88.185      443       TCP
10.102.252.88      443       TCP
10.106.109.172     9001      TCP
10.96.0.1          443       TCP
10.96.122.225      443       TCP
10.106.109.172     9000      TCP
10.105.130.171     14267     HTTP+TCP
10.96.81.27        5601      HTTP+TCP
0.0.0.0            15014     HTTP+TCP
10.105.130.171     14250     HTTP+TCP
0.0.0.0            20001     HTTP+TCP
0.0.0.0            9411      HTTP+TCP
10.111.37.34       9090      HTTP+TCP
10.105.145.36      80        HTTP+TCP
10.105.130.171     14268     HTTP+TCP
10.96.0.10         9153      HTTP+TCP
10.110.244.188     80        HTTP+TCP
10.102.252.88      853       HTTP+TCP
10.99.139.251      16686     HTTP+TCP
0.0.0.0            12345     HTTP+TCP
10.103.155.149     80        HTTP+TCP
0.0.0.0            8000      HTTP+TCP
0.0.0.0            15010     HTTP+TCP
10.96.122.225      15020     HTTP+TCP
0.0.0.0            9090      HTTP+TCP
10.107.150.251     80        HTTP+TCP
0.0.0.0            14250     HTTP+TCP
0.0.0.0            80        HTTP+TCP
0.0.0.0            3000      HTTP+TCP
10.110.28.96       8181      HTTP+TCP
10.102.69.143      9200      HTTP+TCP
0.0.0.0            9080      HTTP+TCP 《《《《《《《《《《《《
0.0.0.0            15001     TCP 《《《《《《《《《《《《
0.0.0.0            15006     HTTP+TCP
0.0.0.0            15090     HTTP
0.0.0.0            15021     HTTP
&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;Related passthrough cluster:&lt;/p&gt;
&lt;pre tabindex=&#34;0&#34;&gt;&lt;code&gt;root@k8s-master-v1-16 ~]# istioctl proxy-config cluster productpage-v1-7f4cc988c6-qxqjs.istio-bookinfo --fqdn PassthroughCluster -o json
&amp;amp;#91;
。。。。忽略。。。
    {
        &amp;quot;name&amp;quot;: &amp;quot;PassthroughCluster&amp;quot;,
        &amp;quot;type&amp;quot;: &amp;quot;ORIGINAL_DST&amp;quot;,
        &amp;quot;connectTimeout&amp;quot;: &amp;quot;10s&amp;quot;,
        &amp;quot;lbPolicy&amp;quot;: &amp;quot;CLUSTER_PROVIDED&amp;quot;,
        &amp;quot;circuitBreakers&amp;quot;: {
            &amp;quot;thresholds&amp;quot;: &amp;amp;#91;
                {
                    &amp;quot;maxConnections&amp;quot;: 4294967295,
                    &amp;quot;maxPendingRequests&amp;quot;: 4294967295,
                    &amp;quot;maxRequests&amp;quot;: 4294967295,
                    &amp;quot;maxRetries&amp;quot;: 4294967295
                }
            ]
        },
        &amp;quot;filters&amp;quot;: &amp;amp;#91;
            {
                &amp;quot;name&amp;quot;: &amp;quot;istio.metadata_exchange&amp;quot;,
                &amp;quot;typedConfig&amp;quot;: {
                    &amp;quot;@type&amp;quot;: &amp;quot;type.googleapis.com/udpa.type.v1.TypedStruct&amp;quot;,
                    &amp;quot;typeUrl&amp;quot;: &amp;quot;type.googleapis.com/envoy.tcp.metadataexchange.config.MetadataExchange&amp;quot;,
                    &amp;quot;value&amp;quot;: {
                        &amp;quot;protocol&amp;quot;: &amp;quot;istio-peer-exchange&amp;quot;
                    }
                }
            }
        ]
    }
]
&lt;/code&gt;&lt;/pre&gt;&lt;h2 id=&#34;inbound-flow-control&#34;&gt;Inbound flow control&lt;/h2&gt;
&lt;p&gt;When it is an inbound request, the destination address of the packet is the IP of the pod, and the destination port is the real port of the business (9080, non-svc mapping port). Since the link destination port of iptables is changed to 15006, it will Hit virtual inbound listener (0.0.0.0:15006), this listener has a series of filterchain, and the virtualoutbound listener configuration method is different, virtualinbound contains a series of actual service filters for specific ports, the connection will find specific in these fitlers Business matching. So how does it match the real 9080 business? For example, the following output:
addressPrefix can be matched. If the pod actually has multiple ports, only addressPrefix does not match. It also needs to match the application layer protocol, but the DestinationPort in the Match condition is not matched . In fact, it is similar to Virtualoutbound. The filter of the original destination listener is also used, so envoy will obtain the real destination port and IP from the kernel. This configuration method is different from the virtual outbound &amp;ldquo;useOriginalDst&amp;rdquo;: true configuration method, because this is an updated configuration method.&amp;quot; useOriginalDst&amp;quot;: true This configuration is about to be abandoned.&lt;/p&gt;
&lt;p&gt;&lt;code&gt;&amp;quot;listenerFilters&amp;quot;: [ { &amp;quot;name&amp;quot;: &amp;quot;envoy.listener.original_dst&amp;quot;, &amp;quot;typedConfig&amp;quot;: { &amp;quot;@type&amp;quot;: &amp;quot;type.googleapis.com/envoy.config.filter.listener.original_dst.v2.OriginalDst&amp;quot; } },&lt;/code&gt;&lt;/p&gt;
&lt;p&gt;(According to &lt;a href=&#34;https://www.envoyproxy.io/docs/envoy/latest/api-v2/api/v2/listener/listener_components.proto&#34;&gt;https://www.envoyproxy.io/docs/envoy/latest/api-v2/api/v2/listener/listener_components.proto&lt;/a&gt;, the  filtermatch condition is that all must match)&lt;/p&gt;
&lt;pre tabindex=&#34;0&#34;&gt;&lt;code&gt;            {
                &amp;quot;filterChainMatch&amp;quot;: {
                    &amp;quot;destinationPort&amp;quot;: 9080,
                    &amp;quot;prefixRanges&amp;quot;: &amp;amp;#91;
                        {
                            &amp;quot;addressPrefix&amp;quot;: &amp;quot;10.244.2.138&amp;quot;,
                            &amp;quot;prefixLen&amp;quot;: 32
                        }
                    ],
### 根据https://istio.io/latest/zh/docs/ops/deployment/requirements/ , 
### 同一个业务端口是不能被两个用不同协议的svc来发布的，因此这帮助避免了同端口同协议的match在整个配置文件里的出现。
                    &amp;quot;applicationProtocols&amp;quot;: &amp;amp;#91;
                        &amp;quot;istio&amp;quot;,
                        &amp;quot;istio-http/1.0&amp;quot;,
                        &amp;quot;istio-http/1.1&amp;quot;,
                        &amp;quot;istio-h2&amp;quot;
                    ]
                },
                &amp;quot;filters&amp;quot;: &amp;amp;#91;
                    {
                        &amp;quot;name&amp;quot;: &amp;quot;istio.metadata_exchange&amp;quot;,
                        &amp;quot;typedConfig&amp;quot;: {
                            &amp;quot;@type&amp;quot;: &amp;quot;type.googleapis.com/udpa.type.v1.TypedStruct&amp;quot;,
                            &amp;quot;typeUrl&amp;quot;: &amp;quot;type.googleapis.com/envoy.tcp.metadataexchange.config.MetadataExchange&amp;quot;,
                            &amp;quot;value&amp;quot;: {
                                &amp;quot;protocol&amp;quot;: &amp;quot;istio-peer-exchange&amp;quot;
                            }
                        }
                    },
                    {
                        &amp;quot;name&amp;quot;: &amp;quot;envoy.http_connection_manager&amp;quot;,
                        &amp;quot;typedConfig&amp;quot;: {
                            &amp;quot;@type&amp;quot;: &amp;quot;type.googleapis.com/envoy.config.filter.network.http_connection_manager.v2.HttpConnectionManager&amp;quot;,
                            &amp;quot;statPrefix&amp;quot;: &amp;quot;inbound_10.244.2.138_9080&amp;quot;,
                            &amp;quot;routeConfig&amp;quot;: {
                                &amp;quot;name&amp;quot;: &amp;quot;inbound|9080|http|productpage.istio-bookinfo.svc.cluster.local&amp;quot;,
                                &amp;quot;virtualHosts&amp;quot;: &amp;amp;#91;
                                    {
                                        &amp;quot;name&amp;quot;: &amp;quot;inbound|http|9080&amp;quot;,
                                        &amp;quot;domains&amp;quot;: &amp;amp;#91;
                                            &amp;quot;*&amp;quot;
                                        ],
                                        &amp;quot;routes&amp;quot;: &amp;amp;#91;
                                            {
                                                &amp;quot;name&amp;quot;: &amp;quot;default&amp;quot;,
                                                &amp;quot;match&amp;quot;: {
                                                    &amp;quot;prefix&amp;quot;: &amp;quot;/&amp;quot;
                                                },
                                                &amp;quot;route&amp;quot;: {
                                                    &amp;quot;cluster&amp;quot;: &amp;quot;inbound|9080|http|productpage.istio-bookinfo.svc.cluster.local&amp;quot;,
                                                    &amp;quot;timeout&amp;quot;: &amp;quot;0s&amp;quot;,
                                                    &amp;quot;maxGrpcTimeout&amp;quot;: &amp;quot;0s&amp;quot;
                                                },
                                                &amp;quot;decorator&amp;quot;: {
                                                    &amp;quot;operation&amp;quot;: &amp;quot;productpage.istio-bookinfo.svc.cluster.local:9080/*&amp;quot;
                                                }
                                            }
                                        ]
                                    }
                                ],
&lt;/code&gt;&lt;/pre&gt;&lt;h2 id=&#34;last&#34;&gt;Last&lt;/h2&gt;
&lt;p&gt;Attach the actual configuration of 15006&lt;/p&gt;
&lt;pre tabindex=&#34;0&#34;&gt;&lt;code&gt;&amp;amp;#91;root@k8s-master-v1-16 ~]# istioctl proxy-config listener productpage-v1-7f4cc988c6-qxqjs.istio-bookinfo --port 15006 -o json
&amp;amp;#91;
    {
        &amp;quot;name&amp;quot;: &amp;quot;virtualInbound&amp;quot;,
        &amp;quot;address&amp;quot;: {
            &amp;quot;socketAddress&amp;quot;: {
                &amp;quot;address&amp;quot;: &amp;quot;0.0.0.0&amp;quot;,
                &amp;quot;portValue&amp;quot;: 15006
            }
        },
        &amp;quot;filterChains&amp;quot;: &amp;amp;#91;
            {
                &amp;quot;filterChainMatch&amp;quot;: {
                    &amp;quot;prefixRanges&amp;quot;: &amp;amp;#91;
                        {
                            &amp;quot;addressPrefix&amp;quot;: &amp;quot;0.0.0.0&amp;quot;,
                            &amp;quot;prefixLen&amp;quot;: 0
                        }
                    ],
                    &amp;quot;transportProtocol&amp;quot;: &amp;quot;tls&amp;quot;,
                    &amp;quot;applicationProtocols&amp;quot;: &amp;amp;#91;
                        &amp;quot;istio-peer-exchange&amp;quot;,
                        &amp;quot;istio&amp;quot;
                    ]
                },
                &amp;quot;filters&amp;quot;: &amp;amp;#91;
                    {
                        &amp;quot;name&amp;quot;: &amp;quot;istio.metadata_exchange&amp;quot;,
                        &amp;quot;typedConfig&amp;quot;: {
                            &amp;quot;@type&amp;quot;: &amp;quot;type.googleapis.com/udpa.type.v1.TypedStruct&amp;quot;,
                            &amp;quot;typeUrl&amp;quot;: &amp;quot;type.googleapis.com/envoy.tcp.metadataexchange.config.MetadataExchange&amp;quot;,
                            &amp;quot;value&amp;quot;: {
                                &amp;quot;protocol&amp;quot;: &amp;quot;istio-peer-exchange&amp;quot;
                            }
                        }
                    },
                    {
                        &amp;quot;name&amp;quot;: &amp;quot;istio.stats&amp;quot;,
                        &amp;quot;typedConfig&amp;quot;: {
                            &amp;quot;@type&amp;quot;: &amp;quot;type.googleapis.com/udpa.type.v1.TypedStruct&amp;quot;,
                            &amp;quot;typeUrl&amp;quot;: &amp;quot;type.googleapis.com/envoy.extensions.filters.network.wasm.v3.Wasm&amp;quot;,
                            &amp;quot;value&amp;quot;: {
                                &amp;quot;config&amp;quot;: {
                                    &amp;quot;configuration&amp;quot;: &amp;quot;{\n  \&amp;quot;debug\&amp;quot;: \&amp;quot;false\&amp;quot;,\n  \&amp;quot;stat_prefix\&amp;quot;: \&amp;quot;istio\&amp;quot;\n}\n&amp;quot;,
                                    &amp;quot;root_id&amp;quot;: &amp;quot;stats_inbound&amp;quot;,
                                    &amp;quot;vm_config&amp;quot;: {
                                        &amp;quot;code&amp;quot;: {
                                            &amp;quot;local&amp;quot;: {
                                                &amp;quot;inline_string&amp;quot;: &amp;quot;envoy.wasm.stats&amp;quot;
                                            }
                                        },
                                        &amp;quot;runtime&amp;quot;: &amp;quot;envoy.wasm.runtime.null&amp;quot;,
                                        &amp;quot;vm_id&amp;quot;: &amp;quot;tcp_stats_inbound&amp;quot;
                                    }
                                }
                            }
                        }
                    },
                    {
                        &amp;quot;name&amp;quot;: &amp;quot;envoy.tcp_proxy&amp;quot;,
                        &amp;quot;typedConfig&amp;quot;: {
                            &amp;quot;@type&amp;quot;: &amp;quot;type.googleapis.com/envoy.config.filter.network.tcp_proxy.v2.TcpProxy&amp;quot;,
                            &amp;quot;statPrefix&amp;quot;: &amp;quot;InboundPassthroughClusterIpv4&amp;quot;,
                            &amp;quot;cluster&amp;quot;: &amp;quot;InboundPassthroughClusterIpv4&amp;quot;,
                            &amp;quot;accessLog&amp;quot;: &amp;amp;#91;
                                {
                                    &amp;quot;name&amp;quot;: &amp;quot;envoy.file_access_log&amp;quot;,
                                    &amp;quot;typedConfig&amp;quot;: {
                                        &amp;quot;@type&amp;quot;: &amp;quot;type.googleapis.com/envoy.config.accesslog.v2.FileAccessLog&amp;quot;,
                                        &amp;quot;path&amp;quot;: &amp;quot;/dev/stdout&amp;quot;,
                                        &amp;quot;format&amp;quot;: &amp;quot;&amp;amp;#91;%START_TIME%] \&amp;quot;%REQ(:METHOD)% %REQ(X-ENVOY-ORIGINAL-PATH?:PATH)% %PROTOCOL%\&amp;quot; %RESPONSE_CODE% %RESPONSE_FLAGS% \&amp;quot;%DYNAMIC_METADATA(istio.mixer:status)%\&amp;quot; \&amp;quot;%UPSTREAM_TRANSPORT_FAILURE_REASON%\&amp;quot; %BYTES_RECEIVED% %BYTES_SENT% %DURATION% %RESP(X-ENVOY-UPSTREAM-SERVICE-TIME)% \&amp;quot;%REQ(X-FORWARDED-FOR)%\&amp;quot; \&amp;quot;%REQ(USER-AGENT)%\&amp;quot; \&amp;quot;%REQ(X-REQUEST-ID)%\&amp;quot; \&amp;quot;%REQ(:AUTHORITY)%\&amp;quot; \&amp;quot;%UPSTREAM_HOST%\&amp;quot; %UPSTREAM_CLUSTER% %UPSTREAM_LOCAL_ADDRESS% %DOWNSTREAM_LOCAL_ADDRESS% %DOWNSTREAM_REMOTE_ADDRESS% %REQUESTED_SERVER_NAME% %ROUTE_NAME%\n&amp;quot;
                                    }
                                }
                            ]
                        }
                    }
                ],
                &amp;quot;transportSocket&amp;quot;: {
                    &amp;quot;name&amp;quot;: &amp;quot;envoy.transport_sockets.tls&amp;quot;,
                    &amp;quot;typedConfig&amp;quot;: {
                        &amp;quot;@type&amp;quot;: &amp;quot;type.googleapis.com/envoy.api.v2.auth.DownstreamTlsContext&amp;quot;,
                        &amp;quot;commonTlsContext&amp;quot;: {
                            &amp;quot;tlsCertificateSdsSecretConfigs&amp;quot;: &amp;amp;#91;
                                {
                                    &amp;quot;name&amp;quot;: &amp;quot;default&amp;quot;,
                                    &amp;quot;sdsConfig&amp;quot;: {
                                        &amp;quot;apiConfigSource&amp;quot;: {
                                            &amp;quot;apiType&amp;quot;: &amp;quot;GRPC&amp;quot;,
                                            &amp;quot;grpcServices&amp;quot;: &amp;amp;#91;
                                                {
                                                    &amp;quot;envoyGrpc&amp;quot;: {
                                                        &amp;quot;clusterName&amp;quot;: &amp;quot;sds-grpc&amp;quot;
                                                    }
                                                }
                                            ]
                                        }
                                    }
                                }
                            ],
                            &amp;quot;combinedValidationContext&amp;quot;: {
                                &amp;quot;defaultValidationContext&amp;quot;: {},
                                &amp;quot;validationContextSdsSecretConfig&amp;quot;: {
                                    &amp;quot;name&amp;quot;: &amp;quot;ROOTCA&amp;quot;,
                                    &amp;quot;sdsConfig&amp;quot;: {
                                        &amp;quot;apiConfigSource&amp;quot;: {
                                            &amp;quot;apiType&amp;quot;: &amp;quot;GRPC&amp;quot;,
                                            &amp;quot;grpcServices&amp;quot;: &amp;amp;#91;
                                                {
                                                    &amp;quot;envoyGrpc&amp;quot;: {
                                                        &amp;quot;clusterName&amp;quot;: &amp;quot;sds-grpc&amp;quot;
                                                    }
                                                }
                                            ]
                                        }
                                    }
                                }
                            },
                            &amp;quot;alpnProtocols&amp;quot;: &amp;amp;#91;
                                &amp;quot;istio-peer-exchange&amp;quot;,
                                &amp;quot;h2&amp;quot;,
                                &amp;quot;http/1.1&amp;quot;
                            ]
                        },
                        &amp;quot;requireClientCertificate&amp;quot;: true
                    }
                },
                &amp;quot;name&amp;quot;: &amp;quot;virtualInbound&amp;quot;
            },
            {
                &amp;quot;filterChainMatch&amp;quot;: {
                    &amp;quot;prefixRanges&amp;quot;: &amp;amp;#91;
                        {
                            &amp;quot;addressPrefix&amp;quot;: &amp;quot;0.0.0.0&amp;quot;,
                            &amp;quot;prefixLen&amp;quot;: 0
                        }
                    ]
                },
                &amp;quot;filters&amp;quot;: &amp;amp;#91;
                    {
                        &amp;quot;name&amp;quot;: &amp;quot;istio.metadata_exchange&amp;quot;,
                        &amp;quot;typedConfig&amp;quot;: {
                            &amp;quot;@type&amp;quot;: &amp;quot;type.googleapis.com/udpa.type.v1.TypedStruct&amp;quot;,
                            &amp;quot;typeUrl&amp;quot;: &amp;quot;type.googleapis.com/envoy.tcp.metadataexchange.config.MetadataExchange&amp;quot;,
                            &amp;quot;value&amp;quot;: {
                                &amp;quot;protocol&amp;quot;: &amp;quot;istio-peer-exchange&amp;quot;
                            }
                        }
                    },
                    {
                        &amp;quot;name&amp;quot;: &amp;quot;istio.stats&amp;quot;,
                        &amp;quot;typedConfig&amp;quot;: {
                            &amp;quot;@type&amp;quot;: &amp;quot;type.googleapis.com/udpa.type.v1.TypedStruct&amp;quot;,
                            &amp;quot;typeUrl&amp;quot;: &amp;quot;type.googleapis.com/envoy.extensions.filters.network.wasm.v3.Wasm&amp;quot;,
                            &amp;quot;value&amp;quot;: {
                                &amp;quot;config&amp;quot;: {
                                    &amp;quot;configuration&amp;quot;: &amp;quot;{\n  \&amp;quot;debug\&amp;quot;: \&amp;quot;false\&amp;quot;,\n  \&amp;quot;stat_prefix\&amp;quot;: \&amp;quot;istio\&amp;quot;\n}\n&amp;quot;,
                                    &amp;quot;root_id&amp;quot;: &amp;quot;stats_inbound&amp;quot;,
                                    &amp;quot;vm_config&amp;quot;: {
                                        &amp;quot;code&amp;quot;: {
                                            &amp;quot;local&amp;quot;: {
                                                &amp;quot;inline_string&amp;quot;: &amp;quot;envoy.wasm.stats&amp;quot;
                                            }
                                        },
                                        &amp;quot;runtime&amp;quot;: &amp;quot;envoy.wasm.runtime.null&amp;quot;,
                                        &amp;quot;vm_id&amp;quot;: &amp;quot;tcp_stats_inbound&amp;quot;
                                    }
                                }
                            }
                        }
                    },
                    {
                        &amp;quot;name&amp;quot;: &amp;quot;envoy.tcp_proxy&amp;quot;,
                        &amp;quot;typedConfig&amp;quot;: {
                            &amp;quot;@type&amp;quot;: &amp;quot;type.googleapis.com/envoy.config.filter.network.tcp_proxy.v2.TcpProxy&amp;quot;,
                            &amp;quot;statPrefix&amp;quot;: &amp;quot;InboundPassthroughClusterIpv4&amp;quot;,
                            &amp;quot;cluster&amp;quot;: &amp;quot;InboundPassthroughClusterIpv4&amp;quot;,
                            &amp;quot;accessLog&amp;quot;: &amp;amp;#91;
                                {
                                    &amp;quot;name&amp;quot;: &amp;quot;envoy.file_access_log&amp;quot;,
                                    &amp;quot;typedConfig&amp;quot;: {
                                        &amp;quot;@type&amp;quot;: &amp;quot;type.googleapis.com/envoy.config.accesslog.v2.FileAccessLog&amp;quot;,
                                        &amp;quot;path&amp;quot;: &amp;quot;/dev/stdout&amp;quot;,
                                        &amp;quot;format&amp;quot;: &amp;quot;&amp;amp;#91;%START_TIME%] \&amp;quot;%REQ(:METHOD)% %REQ(X-ENVOY-ORIGINAL-PATH?:PATH)% %PROTOCOL%\&amp;quot; %RESPONSE_CODE% %RESPONSE_FLAGS% \&amp;quot;%DYNAMIC_METADATA(istio.mixer:status)%\&amp;quot; \&amp;quot;%UPSTREAM_TRANSPORT_FAILURE_REASON%\&amp;quot; %BYTES_RECEIVED% %BYTES_SENT% %DURATION% %RESP(X-ENVOY-UPSTREAM-SERVICE-TIME)% \&amp;quot;%REQ(X-FORWARDED-FOR)%\&amp;quot; \&amp;quot;%REQ(USER-AGENT)%\&amp;quot; \&amp;quot;%REQ(X-REQUEST-ID)%\&amp;quot; \&amp;quot;%REQ(:AUTHORITY)%\&amp;quot; \&amp;quot;%UPSTREAM_HOST%\&amp;quot; %UPSTREAM_CLUSTER% %UPSTREAM_LOCAL_ADDRESS% %DOWNSTREAM_LOCAL_ADDRESS% %DOWNSTREAM_REMOTE_ADDRESS% %REQUESTED_SERVER_NAME% %ROUTE_NAME%\n&amp;quot;
                                    }
                                }
                            ]
                        }
                    }
                ],
                &amp;quot;name&amp;quot;: &amp;quot;virtualInbound&amp;quot;
            },
            {
                &amp;quot;filterChainMatch&amp;quot;: {
                    &amp;quot;prefixRanges&amp;quot;: &amp;amp;#91;
                        {
                            &amp;quot;addressPrefix&amp;quot;: &amp;quot;0.0.0.0&amp;quot;,
                            &amp;quot;prefixLen&amp;quot;: 0
                        }
                    ],
                    &amp;quot;transportProtocol&amp;quot;: &amp;quot;tls&amp;quot;,
                    &amp;quot;applicationProtocols&amp;quot;: &amp;amp;#91;
                        &amp;quot;http/1.0&amp;quot;,
                        &amp;quot;http/1.1&amp;quot;,
                        &amp;quot;h2c&amp;quot;,
                        &amp;quot;istio-http/1.0&amp;quot;,
                        &amp;quot;istio-http/1.1&amp;quot;,
                        &amp;quot;istio-h2&amp;quot;
                    ]
                },
                &amp;quot;filters&amp;quot;: &amp;amp;#91;
                    {
                        &amp;quot;name&amp;quot;: &amp;quot;istio.metadata_exchange&amp;quot;,
                        &amp;quot;typedConfig&amp;quot;: {
                            &amp;quot;@type&amp;quot;: &amp;quot;type.googleapis.com/udpa.type.v1.TypedStruct&amp;quot;,
                            &amp;quot;typeUrl&amp;quot;: &amp;quot;type.googleapis.com/envoy.tcp.metadataexchange.config.MetadataExchange&amp;quot;,
                            &amp;quot;value&amp;quot;: {
                                &amp;quot;protocol&amp;quot;: &amp;quot;istio-peer-exchange&amp;quot;
                            }
                        }
                    },
                    {
                        &amp;quot;name&amp;quot;: &amp;quot;envoy.http_connection_manager&amp;quot;,
                        &amp;quot;typedConfig&amp;quot;: {
                            &amp;quot;@type&amp;quot;: &amp;quot;type.googleapis.com/envoy.config.filter.network.http_connection_manager.v2.HttpConnectionManager&amp;quot;,
                            &amp;quot;statPrefix&amp;quot;: &amp;quot;InboundPassthroughClusterIpv4&amp;quot;,
                            &amp;quot;routeConfig&amp;quot;: {
                                &amp;quot;name&amp;quot;: &amp;quot;InboundPassthroughClusterIpv4&amp;quot;,
                                &amp;quot;virtualHosts&amp;quot;: &amp;amp;#91;
                                    {
                                        &amp;quot;name&amp;quot;: &amp;quot;inbound|http|0&amp;quot;,
                                        &amp;quot;domains&amp;quot;: &amp;amp;#91;
                                            &amp;quot;*&amp;quot;
                                        ],
                                        &amp;quot;routes&amp;quot;: &amp;amp;#91;
                                            {
                                                &amp;quot;name&amp;quot;: &amp;quot;default&amp;quot;,
                                                &amp;quot;match&amp;quot;: {
                                                    &amp;quot;prefix&amp;quot;: &amp;quot;/&amp;quot;
                                                },
                                                &amp;quot;route&amp;quot;: {
                                                    &amp;quot;cluster&amp;quot;: &amp;quot;InboundPassthroughClusterIpv4&amp;quot;,
                                                    &amp;quot;timeout&amp;quot;: &amp;quot;0s&amp;quot;,
                                                    &amp;quot;maxGrpcTimeout&amp;quot;: &amp;quot;0s&amp;quot;
                                                },
                                                &amp;quot;decorator&amp;quot;: {
                                                    &amp;quot;operation&amp;quot;: &amp;quot;:0/*&amp;quot;
                                                }
                                            }
                                        ]
                                    }
                                ],
                                &amp;quot;validateClusters&amp;quot;: false
                            },
                            &amp;quot;httpFilters&amp;quot;: &amp;amp;#91;
                                {
                                    &amp;quot;name&amp;quot;: &amp;quot;istio.metadata_exchange&amp;quot;,
                                    &amp;quot;typedConfig&amp;quot;: {
                                        &amp;quot;@type&amp;quot;: &amp;quot;type.googleapis.com/udpa.type.v1.TypedStruct&amp;quot;,
                                        &amp;quot;typeUrl&amp;quot;: &amp;quot;type.googleapis.com/envoy.extensions.filters.http.wasm.v3.Wasm&amp;quot;,
                                        &amp;quot;value&amp;quot;: {
                                            &amp;quot;config&amp;quot;: {
                                                &amp;quot;configuration&amp;quot;: &amp;quot;{}\n&amp;quot;,
                                                &amp;quot;vm_config&amp;quot;: {
                                                    &amp;quot;code&amp;quot;: {
                                                        &amp;quot;local&amp;quot;: {
                                                            &amp;quot;inline_string&amp;quot;: &amp;quot;envoy.wasm.metadata_exchange&amp;quot;
                                                        }
                                                    },
                                                    &amp;quot;runtime&amp;quot;: &amp;quot;envoy.wasm.runtime.null&amp;quot;
                                                }
                                            }
                                        }
                                    }
                                },
                                {
                                    &amp;quot;name&amp;quot;: &amp;quot;envoy.cors&amp;quot;,
                                    &amp;quot;typedConfig&amp;quot;: {
                                        &amp;quot;@type&amp;quot;: &amp;quot;type.googleapis.com/envoy.config.filter.http.cors.v2.Cors&amp;quot;
                                    }
                                },
                                {
                                    &amp;quot;name&amp;quot;: &amp;quot;envoy.fault&amp;quot;,
                                    &amp;quot;typedConfig&amp;quot;: {
                                        &amp;quot;@type&amp;quot;: &amp;quot;type.googleapis.com/envoy.config.filter.http.fault.v2.HTTPFault&amp;quot;
                                    }
                                },
                                {
                                    &amp;quot;name&amp;quot;: &amp;quot;istio.stats&amp;quot;,
                                    &amp;quot;typedConfig&amp;quot;: {
                                        &amp;quot;@type&amp;quot;: &amp;quot;type.googleapis.com/udpa.type.v1.TypedStruct&amp;quot;,
                                        &amp;quot;typeUrl&amp;quot;: &amp;quot;type.googleapis.com/envoy.extensions.filters.http.wasm.v3.Wasm&amp;quot;,
                                        &amp;quot;value&amp;quot;: {
                                            &amp;quot;config&amp;quot;: {
                                                &amp;quot;configuration&amp;quot;: &amp;quot;{\n  \&amp;quot;debug\&amp;quot;: \&amp;quot;false\&amp;quot;,\n  \&amp;quot;stat_prefix\&amp;quot;: \&amp;quot;istio\&amp;quot;\n}\n&amp;quot;,
                                                &amp;quot;root_id&amp;quot;: &amp;quot;stats_inbound&amp;quot;,
                                                &amp;quot;vm_config&amp;quot;: {
                                                    &amp;quot;code&amp;quot;: {
                                                        &amp;quot;local&amp;quot;: {
                                                            &amp;quot;inline_string&amp;quot;: &amp;quot;envoy.wasm.stats&amp;quot;
                                                        }
                                                    },
                                                    &amp;quot;runtime&amp;quot;: &amp;quot;envoy.wasm.runtime.null&amp;quot;,
                                                    &amp;quot;vm_id&amp;quot;: &amp;quot;stats_inbound&amp;quot;
                                                }
                                            }
                                        }
                                    }
                                },
                                {
                                    &amp;quot;name&amp;quot;: &amp;quot;envoy.router&amp;quot;,
                                    &amp;quot;typedConfig&amp;quot;: {
                                        &amp;quot;@type&amp;quot;: &amp;quot;type.googleapis.com/envoy.config.filter.http.router.v2.Router&amp;quot;
                                    }
                                }
                            ],
                            &amp;quot;tracing&amp;quot;: {
                                &amp;quot;clientSampling&amp;quot;: {
                                    &amp;quot;value&amp;quot;: 100
                                },
                                &amp;quot;randomSampling&amp;quot;: {
                                    &amp;quot;value&amp;quot;: 100
                                },
                                &amp;quot;overallSampling&amp;quot;: {
                                    &amp;quot;value&amp;quot;: 100
                                }
                            },
                            &amp;quot;serverName&amp;quot;: &amp;quot;istio-envoy&amp;quot;,
                            &amp;quot;streamIdleTimeout&amp;quot;: &amp;quot;0s&amp;quot;,
                            &amp;quot;accessLog&amp;quot;: &amp;amp;#91;
                                {
                                    &amp;quot;name&amp;quot;: &amp;quot;envoy.file_access_log&amp;quot;,
                                    &amp;quot;typedConfig&amp;quot;: {
                                        &amp;quot;@type&amp;quot;: &amp;quot;type.googleapis.com/envoy.config.accesslog.v2.FileAccessLog&amp;quot;,
                                        &amp;quot;path&amp;quot;: &amp;quot;/dev/stdout&amp;quot;,
                                        &amp;quot;format&amp;quot;: &amp;quot;&amp;amp;#91;%START_TIME%] \&amp;quot;%REQ(:METHOD)% %REQ(X-ENVOY-ORIGINAL-PATH?:PATH)% %PROTOCOL%\&amp;quot; %RESPONSE_CODE% %RESPONSE_FLAGS% \&amp;quot;%DYNAMIC_METADATA(istio.mixer:status)%\&amp;quot; \&amp;quot;%UPSTREAM_TRANSPORT_FAILURE_REASON%\&amp;quot; %BYTES_RECEIVED% %BYTES_SENT% %DURATION% %RESP(X-ENVOY-UPSTREAM-SERVICE-TIME)% \&amp;quot;%REQ(X-FORWARDED-FOR)%\&amp;quot; \&amp;quot;%REQ(USER-AGENT)%\&amp;quot; \&amp;quot;%REQ(X-REQUEST-ID)%\&amp;quot; \&amp;quot;%REQ(:AUTHORITY)%\&amp;quot; \&amp;quot;%UPSTREAM_HOST%\&amp;quot; %UPSTREAM_CLUSTER% %UPSTREAM_LOCAL_ADDRESS% %DOWNSTREAM_LOCAL_ADDRESS% %DOWNSTREAM_REMOTE_ADDRESS% %REQUESTED_SERVER_NAME% %ROUTE_NAME%\n&amp;quot;
                                    }
                                }
                            ],
                            &amp;quot;useRemoteAddress&amp;quot;: false,
                            &amp;quot;generateRequestId&amp;quot;: true,
                            &amp;quot;forwardClientCertDetails&amp;quot;: &amp;quot;APPEND_FORWARD&amp;quot;,
                            &amp;quot;setCurrentClientCertDetails&amp;quot;: {
                                &amp;quot;subject&amp;quot;: true,
                                &amp;quot;dns&amp;quot;: true,
                                &amp;quot;uri&amp;quot;: true
                            },
                            &amp;quot;upgradeConfigs&amp;quot;: &amp;amp;#91;
                                {
                                    &amp;quot;upgradeType&amp;quot;: &amp;quot;websocket&amp;quot;
                                }
                            ],
                            &amp;quot;normalizePath&amp;quot;: true
                        }
                    }
                ],
                &amp;quot;transportSocket&amp;quot;: {
                    &amp;quot;name&amp;quot;: &amp;quot;envoy.transport_sockets.tls&amp;quot;,
                    &amp;quot;typedConfig&amp;quot;: {
                        &amp;quot;@type&amp;quot;: &amp;quot;type.googleapis.com/envoy.api.v2.auth.DownstreamTlsContext&amp;quot;,
                        &amp;quot;commonTlsContext&amp;quot;: {
                            &amp;quot;tlsCertificateSdsSecretConfigs&amp;quot;: &amp;amp;#91;
                                {
                                    &amp;quot;name&amp;quot;: &amp;quot;default&amp;quot;,
                                    &amp;quot;sdsConfig&amp;quot;: {
                                        &amp;quot;apiConfigSource&amp;quot;: {
                                            &amp;quot;apiType&amp;quot;: &amp;quot;GRPC&amp;quot;,
                                            &amp;quot;grpcServices&amp;quot;: &amp;amp;#91;
                                                {
                                                    &amp;quot;envoyGrpc&amp;quot;: {
                                                        &amp;quot;clusterName&amp;quot;: &amp;quot;sds-grpc&amp;quot;
                                                    }
                                                }
                                            ]
                                        }
                                    }
                                }
                            ],
                            &amp;quot;combinedValidationContext&amp;quot;: {
                                &amp;quot;defaultValidationContext&amp;quot;: {},
                                &amp;quot;validationContextSdsSecretConfig&amp;quot;: {
                                    &amp;quot;name&amp;quot;: &amp;quot;ROOTCA&amp;quot;,
                                    &amp;quot;sdsConfig&amp;quot;: {
                                        &amp;quot;apiConfigSource&amp;quot;: {
                                            &amp;quot;apiType&amp;quot;: &amp;quot;GRPC&amp;quot;,
                                            &amp;quot;grpcServices&amp;quot;: &amp;amp;#91;
                                                {
                                                    &amp;quot;envoyGrpc&amp;quot;: {
                                                        &amp;quot;clusterName&amp;quot;: &amp;quot;sds-grpc&amp;quot;
                                                    }
                                                }
                                            ]
                                        }
                                    }
                                }
                            },
                            &amp;quot;alpnProtocols&amp;quot;: &amp;amp;#91;
                                &amp;quot;h2&amp;quot;,
                                &amp;quot;http/1.1&amp;quot;
                            ]
                        },
                        &amp;quot;requireClientCertificate&amp;quot;: true
                    }
                },
                &amp;quot;name&amp;quot;: &amp;quot;virtualInbound-catchall-http&amp;quot;
            },
            {
                &amp;quot;filterChainMatch&amp;quot;: {
                    &amp;quot;prefixRanges&amp;quot;: &amp;amp;#91;
                        {
                            &amp;quot;addressPrefix&amp;quot;: &amp;quot;0.0.0.0&amp;quot;,
                            &amp;quot;prefixLen&amp;quot;: 0
                        }
                    ],
                    &amp;quot;applicationProtocols&amp;quot;: &amp;amp;#91;
                        &amp;quot;http/1.0&amp;quot;,
                        &amp;quot;http/1.1&amp;quot;,
                        &amp;quot;h2c&amp;quot;
                    ]
                },
                &amp;quot;filters&amp;quot;: &amp;amp;#91;
                    {
                        &amp;quot;name&amp;quot;: &amp;quot;istio.metadata_exchange&amp;quot;,
                        &amp;quot;typedConfig&amp;quot;: {
                            &amp;quot;@type&amp;quot;: &amp;quot;type.googleapis.com/udpa.type.v1.TypedStruct&amp;quot;,
                            &amp;quot;typeUrl&amp;quot;: &amp;quot;type.googleapis.com/envoy.tcp.metadataexchange.config.MetadataExchange&amp;quot;,
                            &amp;quot;value&amp;quot;: {
                                &amp;quot;protocol&amp;quot;: &amp;quot;istio-peer-exchange&amp;quot;
                            }
                        }
                    },
                    {
                        &amp;quot;name&amp;quot;: &amp;quot;envoy.http_connection_manager&amp;quot;,
                        &amp;quot;typedConfig&amp;quot;: {
                            &amp;quot;@type&amp;quot;: &amp;quot;type.googleapis.com/envoy.config.filter.network.http_connection_manager.v2.HttpConnectionManager&amp;quot;,
                            &amp;quot;statPrefix&amp;quot;: &amp;quot;InboundPassthroughClusterIpv4&amp;quot;,
                            &amp;quot;routeConfig&amp;quot;: {
                                &amp;quot;name&amp;quot;: &amp;quot;InboundPassthroughClusterIpv4&amp;quot;,
                                &amp;quot;virtualHosts&amp;quot;: &amp;amp;#91;
                                    {
                                        &amp;quot;name&amp;quot;: &amp;quot;inbound|http|0&amp;quot;,
                                        &amp;quot;domains&amp;quot;: &amp;amp;#91;
                                            &amp;quot;*&amp;quot;
                                        ],
                                        &amp;quot;routes&amp;quot;: &amp;amp;#91;
                                            {
                                                &amp;quot;name&amp;quot;: &amp;quot;default&amp;quot;,
                                                &amp;quot;match&amp;quot;: {
                                                    &amp;quot;prefix&amp;quot;: &amp;quot;/&amp;quot;
                                                },
                                                &amp;quot;route&amp;quot;: {
                                                    &amp;quot;cluster&amp;quot;: &amp;quot;InboundPassthroughClusterIpv4&amp;quot;,
                                                    &amp;quot;timeout&amp;quot;: &amp;quot;0s&amp;quot;,
                                                    &amp;quot;maxGrpcTimeout&amp;quot;: &amp;quot;0s&amp;quot;
                                                },
                                                &amp;quot;decorator&amp;quot;: {
                                                    &amp;quot;operation&amp;quot;: &amp;quot;:0/*&amp;quot;
                                                }
                                            }
                                        ]
                                    }
                                ],
                                &amp;quot;validateClusters&amp;quot;: false
                            },
                            &amp;quot;httpFilters&amp;quot;: &amp;amp;#91;
                                {
                                    &amp;quot;name&amp;quot;: &amp;quot;istio.metadata_exchange&amp;quot;,
                                    &amp;quot;typedConfig&amp;quot;: {
                                        &amp;quot;@type&amp;quot;: &amp;quot;type.googleapis.com/udpa.type.v1.TypedStruct&amp;quot;,
                                        &amp;quot;typeUrl&amp;quot;: &amp;quot;type.googleapis.com/envoy.extensions.filters.http.wasm.v3.Wasm&amp;quot;,
                                        &amp;quot;value&amp;quot;: {
                                            &amp;quot;config&amp;quot;: {
                                                &amp;quot;configuration&amp;quot;: &amp;quot;{}\n&amp;quot;,
                                                &amp;quot;vm_config&amp;quot;: {
                                                    &amp;quot;code&amp;quot;: {
                                                        &amp;quot;local&amp;quot;: {
                                                            &amp;quot;inline_string&amp;quot;: &amp;quot;envoy.wasm.metadata_exchange&amp;quot;
                                                        }
                                                    },
                                                    &amp;quot;runtime&amp;quot;: &amp;quot;envoy.wasm.runtime.null&amp;quot;
                                                }
                                            }
                                        }
                                    }
                                },
                                {
                                    &amp;quot;name&amp;quot;: &amp;quot;envoy.cors&amp;quot;,
                                    &amp;quot;typedConfig&amp;quot;: {
                                        &amp;quot;@type&amp;quot;: &amp;quot;type.googleapis.com/envoy.config.filter.http.cors.v2.Cors&amp;quot;
                                    }
                                },
                                {
                                    &amp;quot;name&amp;quot;: &amp;quot;envoy.fault&amp;quot;,
                                    &amp;quot;typedConfig&amp;quot;: {
                                        &amp;quot;@type&amp;quot;: &amp;quot;type.googleapis.com/envoy.config.filter.http.fault.v2.HTTPFault&amp;quot;
                                    }
                                },
                                {
                                    &amp;quot;name&amp;quot;: &amp;quot;istio.stats&amp;quot;,
                                    &amp;quot;typedConfig&amp;quot;: {
                                        &amp;quot;@type&amp;quot;: &amp;quot;type.googleapis.com/udpa.type.v1.TypedStruct&amp;quot;,
                                        &amp;quot;typeUrl&amp;quot;: &amp;quot;type.googleapis.com/envoy.extensions.filters.http.wasm.v3.Wasm&amp;quot;,
                                        &amp;quot;value&amp;quot;: {
                                            &amp;quot;config&amp;quot;: {
                                                &amp;quot;configuration&amp;quot;: &amp;quot;{\n  \&amp;quot;debug\&amp;quot;: \&amp;quot;false\&amp;quot;,\n  \&amp;quot;stat_prefix\&amp;quot;: \&amp;quot;istio\&amp;quot;\n}\n&amp;quot;,
                                                &amp;quot;root_id&amp;quot;: &amp;quot;stats_inbound&amp;quot;,
                                                &amp;quot;vm_config&amp;quot;: {
                                                    &amp;quot;code&amp;quot;: {
                                                        &amp;quot;local&amp;quot;: {
                                                            &amp;quot;inline_string&amp;quot;: &amp;quot;envoy.wasm.stats&amp;quot;
                                                        }
                                                    },
                                                    &amp;quot;runtime&amp;quot;: &amp;quot;envoy.wasm.runtime.null&amp;quot;,
                                                    &amp;quot;vm_id&amp;quot;: &amp;quot;stats_inbound&amp;quot;
                                                }
                                            }
                                        }
                                    }
                                },
                                {
                                    &amp;quot;name&amp;quot;: &amp;quot;envoy.router&amp;quot;,
                                    &amp;quot;typedConfig&amp;quot;: {
                                        &amp;quot;@type&amp;quot;: &amp;quot;type.googleapis.com/envoy.config.filter.http.router.v2.Router&amp;quot;
                                    }
                                }
                            ],
                            &amp;quot;tracing&amp;quot;: {
                                &amp;quot;clientSampling&amp;quot;: {
                                    &amp;quot;value&amp;quot;: 100
                                },
                                &amp;quot;randomSampling&amp;quot;: {
                                    &amp;quot;value&amp;quot;: 100
                                },
                                &amp;quot;overallSampling&amp;quot;: {
                                    &amp;quot;value&amp;quot;: 100
                                }
                            },
                            &amp;quot;serverName&amp;quot;: &amp;quot;istio-envoy&amp;quot;,
                            &amp;quot;streamIdleTimeout&amp;quot;: &amp;quot;0s&amp;quot;,
                            &amp;quot;accessLog&amp;quot;: &amp;amp;#91;
                                {
                                    &amp;quot;name&amp;quot;: &amp;quot;envoy.file_access_log&amp;quot;,
                                    &amp;quot;typedConfig&amp;quot;: {
                                        &amp;quot;@type&amp;quot;: &amp;quot;type.googleapis.com/envoy.config.accesslog.v2.FileAccessLog&amp;quot;,
                                        &amp;quot;path&amp;quot;: &amp;quot;/dev/stdout&amp;quot;,
                                        &amp;quot;format&amp;quot;: &amp;quot;&amp;amp;#91;%START_TIME%] \&amp;quot;%REQ(:METHOD)% %REQ(X-ENVOY-ORIGINAL-PATH?:PATH)% %PROTOCOL%\&amp;quot; %RESPONSE_CODE% %RESPONSE_FLAGS% \&amp;quot;%DYNAMIC_METADATA(istio.mixer:status)%\&amp;quot; \&amp;quot;%UPSTREAM_TRANSPORT_FAILURE_REASON%\&amp;quot; %BYTES_RECEIVED% %BYTES_SENT% %DURATION% %RESP(X-ENVOY-UPSTREAM-SERVICE-TIME)% \&amp;quot;%REQ(X-FORWARDED-FOR)%\&amp;quot; \&amp;quot;%REQ(USER-AGENT)%\&amp;quot; \&amp;quot;%REQ(X-REQUEST-ID)%\&amp;quot; \&amp;quot;%REQ(:AUTHORITY)%\&amp;quot; \&amp;quot;%UPSTREAM_HOST%\&amp;quot; %UPSTREAM_CLUSTER% %UPSTREAM_LOCAL_ADDRESS% %DOWNSTREAM_LOCAL_ADDRESS% %DOWNSTREAM_REMOTE_ADDRESS% %REQUESTED_SERVER_NAME% %ROUTE_NAME%\n&amp;quot;
                                    }
                                }
                            ],
                            &amp;quot;useRemoteAddress&amp;quot;: false,
                            &amp;quot;generateRequestId&amp;quot;: true,
                            &amp;quot;forwardClientCertDetails&amp;quot;: &amp;quot;APPEND_FORWARD&amp;quot;,
                            &amp;quot;setCurrentClientCertDetails&amp;quot;: {
                                &amp;quot;subject&amp;quot;: true,
                                &amp;quot;dns&amp;quot;: true,
                                &amp;quot;uri&amp;quot;: true
                            },
                            &amp;quot;upgradeConfigs&amp;quot;: &amp;amp;#91;
                                {
                                    &amp;quot;upgradeType&amp;quot;: &amp;quot;websocket&amp;quot;
                                }
                            ],
                            &amp;quot;normalizePath&amp;quot;: true
                        }
                    }
                ],
                &amp;quot;name&amp;quot;: &amp;quot;virtualInbound-catchall-http&amp;quot;
            },
            {
                &amp;quot;filterChainMatch&amp;quot;: {
                    &amp;quot;destinationPort&amp;quot;: 15021,
                    &amp;quot;prefixRanges&amp;quot;: &amp;amp;#91;
                        {
                            &amp;quot;addressPrefix&amp;quot;: &amp;quot;10.244.2.155&amp;quot;,
                            &amp;quot;prefixLen&amp;quot;: 32
                        }
                    ]
                },
                &amp;quot;filters&amp;quot;: &amp;amp;#91;
                    {
                        &amp;quot;name&amp;quot;: &amp;quot;istio.metadata_exchange&amp;quot;,
                        &amp;quot;typedConfig&amp;quot;: {
                            &amp;quot;@type&amp;quot;: &amp;quot;type.googleapis.com/udpa.type.v1.TypedStruct&amp;quot;,
                            &amp;quot;typeUrl&amp;quot;: &amp;quot;type.googleapis.com/envoy.tcp.metadataexchange.config.MetadataExchange&amp;quot;,
                            &amp;quot;value&amp;quot;: {
                                &amp;quot;protocol&amp;quot;: &amp;quot;istio-peer-exchange&amp;quot;
                            }
                        }
                    },
                    {
                        &amp;quot;name&amp;quot;: &amp;quot;istio.stats&amp;quot;,
                        &amp;quot;typedConfig&amp;quot;: {
                            &amp;quot;@type&amp;quot;: &amp;quot;type.googleapis.com/udpa.type.v1.TypedStruct&amp;quot;,
                            &amp;quot;typeUrl&amp;quot;: &amp;quot;type.googleapis.com/envoy.extensions.filters.network.wasm.v3.Wasm&amp;quot;,
                            &amp;quot;value&amp;quot;: {
                                &amp;quot;config&amp;quot;: {
                                    &amp;quot;configuration&amp;quot;: &amp;quot;{\n  \&amp;quot;debug\&amp;quot;: \&amp;quot;false\&amp;quot;,\n  \&amp;quot;stat_prefix\&amp;quot;: \&amp;quot;istio\&amp;quot;\n}\n&amp;quot;,
                                    &amp;quot;root_id&amp;quot;: &amp;quot;stats_inbound&amp;quot;,
                                    &amp;quot;vm_config&amp;quot;: {
                                        &amp;quot;code&amp;quot;: {
                                            &amp;quot;local&amp;quot;: {
                                                &amp;quot;inline_string&amp;quot;: &amp;quot;envoy.wasm.stats&amp;quot;
                                            }
                                        },
                                        &amp;quot;runtime&amp;quot;: &amp;quot;envoy.wasm.runtime.null&amp;quot;,
                                        &amp;quot;vm_id&amp;quot;: &amp;quot;tcp_stats_inbound&amp;quot;
                                    }
                                }
                            }
                        }
                    },
                    {
                        &amp;quot;name&amp;quot;: &amp;quot;envoy.tcp_proxy&amp;quot;,
                        &amp;quot;typedConfig&amp;quot;: {
                            &amp;quot;@type&amp;quot;: &amp;quot;type.googleapis.com/envoy.config.filter.network.tcp_proxy.v2.TcpProxy&amp;quot;,
                            &amp;quot;statPrefix&amp;quot;: &amp;quot;inbound|15021|mgmt-15021|mgmtCluster&amp;quot;,
                            &amp;quot;cluster&amp;quot;: &amp;quot;inbound|15021|mgmt-15021|mgmtCluster&amp;quot;,
                            &amp;quot;accessLog&amp;quot;: &amp;amp;#91;
                                {
                                    &amp;quot;name&amp;quot;: &amp;quot;envoy.file_access_log&amp;quot;,
                                    &amp;quot;typedConfig&amp;quot;: {
                                        &amp;quot;@type&amp;quot;: &amp;quot;type.googleapis.com/envoy.config.accesslog.v2.FileAccessLog&amp;quot;,
                                        &amp;quot;path&amp;quot;: &amp;quot;/dev/stdout&amp;quot;,
                                        &amp;quot;format&amp;quot;: &amp;quot;&amp;amp;#91;%START_TIME%] \&amp;quot;%REQ(:METHOD)% %REQ(X-ENVOY-ORIGINAL-PATH?:PATH)% %PROTOCOL%\&amp;quot; %RESPONSE_CODE% %RESPONSE_FLAGS% \&amp;quot;%DYNAMIC_METADATA(istio.mixer:status)%\&amp;quot; \&amp;quot;%UPSTREAM_TRANSPORT_FAILURE_REASON%\&amp;quot; %BYTES_RECEIVED% %BYTES_SENT% %DURATION% %RESP(X-ENVOY-UPSTREAM-SERVICE-TIME)% \&amp;quot;%REQ(X-FORWARDED-FOR)%\&amp;quot; \&amp;quot;%REQ(USER-AGENT)%\&amp;quot; \&amp;quot;%REQ(X-REQUEST-ID)%\&amp;quot; \&amp;quot;%REQ(:AUTHORITY)%\&amp;quot; \&amp;quot;%UPSTREAM_HOST%\&amp;quot; %UPSTREAM_CLUSTER% %UPSTREAM_LOCAL_ADDRESS% %DOWNSTREAM_LOCAL_ADDRESS% %DOWNSTREAM_REMOTE_ADDRESS% %REQUESTED_SERVER_NAME% %ROUTE_NAME%\n&amp;quot;
                                    }
                                }
                            ]
                        }
                    }
                ],
                &amp;quot;name&amp;quot;: &amp;quot;10.244.2.155_15021&amp;quot;
            },
            {
                &amp;quot;filterChainMatch&amp;quot;: {
                    &amp;quot;destinationPort&amp;quot;: 9080,
                    &amp;quot;prefixRanges&amp;quot;: &amp;amp;#91;
                        {
                            &amp;quot;addressPrefix&amp;quot;: &amp;quot;10.244.2.155&amp;quot;,
                            &amp;quot;prefixLen&amp;quot;: 32
                        }
                    ],
                    &amp;quot;applicationProtocols&amp;quot;: &amp;amp;#91;
                        &amp;quot;istio&amp;quot;,
                        &amp;quot;istio-http/1.0&amp;quot;,
                        &amp;quot;istio-http/1.1&amp;quot;,
                        &amp;quot;istio-h2&amp;quot;
                    ]
                },
                &amp;quot;filters&amp;quot;: &amp;amp;#91;
                    {
                        &amp;quot;name&amp;quot;: &amp;quot;istio.metadata_exchange&amp;quot;,
                        &amp;quot;typedConfig&amp;quot;: {
                            &amp;quot;@type&amp;quot;: &amp;quot;type.googleapis.com/udpa.type.v1.TypedStruct&amp;quot;,
                            &amp;quot;typeUrl&amp;quot;: &amp;quot;type.googleapis.com/envoy.tcp.metadataexchange.config.MetadataExchange&amp;quot;,
                            &amp;quot;value&amp;quot;: {
                                &amp;quot;protocol&amp;quot;: &amp;quot;istio-peer-exchange&amp;quot;
                            }
                        }
                    },
                    {
                        &amp;quot;name&amp;quot;: &amp;quot;envoy.http_connection_manager&amp;quot;,
                        &amp;quot;typedConfig&amp;quot;: {
                            &amp;quot;@type&amp;quot;: &amp;quot;type.googleapis.com/envoy.config.filter.network.http_connection_manager.v2.HttpConnectionManager&amp;quot;,
                            &amp;quot;statPrefix&amp;quot;: &amp;quot;inbound_10.244.2.155_9080&amp;quot;,
                            &amp;quot;routeConfig&amp;quot;: {
                                &amp;quot;name&amp;quot;: &amp;quot;inbound|9080|http|productpage.istio-bookinfo.svc.cluster.local&amp;quot;,
                                &amp;quot;virtualHosts&amp;quot;: &amp;amp;#91;
                                    {
                                        &amp;quot;name&amp;quot;: &amp;quot;inbound|http|9080&amp;quot;,
                                        &amp;quot;domains&amp;quot;: &amp;amp;#91;
                                            &amp;quot;*&amp;quot;
                                        ],
                                        &amp;quot;routes&amp;quot;: &amp;amp;#91;
                                            {
                                                &amp;quot;name&amp;quot;: &amp;quot;default&amp;quot;,
                                                &amp;quot;match&amp;quot;: {
                                                    &amp;quot;prefix&amp;quot;: &amp;quot;/&amp;quot;
                                                },
                                                &amp;quot;route&amp;quot;: {
                                                    &amp;quot;cluster&amp;quot;: &amp;quot;inbound|9080|http|productpage.istio-bookinfo.svc.cluster.local&amp;quot;,
                                                    &amp;quot;timeout&amp;quot;: &amp;quot;0s&amp;quot;,
                                                    &amp;quot;maxGrpcTimeout&amp;quot;: &amp;quot;0s&amp;quot;
                                                },
                                                &amp;quot;decorator&amp;quot;: {
                                                    &amp;quot;operation&amp;quot;: &amp;quot;productpage.istio-bookinfo.svc.cluster.local:9080/*&amp;quot;
                                                }
                                            }
                                        ]
                                    }
                                ],
                                &amp;quot;validateClusters&amp;quot;: false
                            },
                            &amp;quot;httpFilters&amp;quot;: &amp;amp;#91;
                                {
                                    &amp;quot;name&amp;quot;: &amp;quot;istio.metadata_exchange&amp;quot;,
                                    &amp;quot;typedConfig&amp;quot;: {
                                        &amp;quot;@type&amp;quot;: &amp;quot;type.googleapis.com/udpa.type.v1.TypedStruct&amp;quot;,
                                        &amp;quot;typeUrl&amp;quot;: &amp;quot;type.googleapis.com/envoy.extensions.filters.http.wasm.v3.Wasm&amp;quot;,
                                        &amp;quot;value&amp;quot;: {
                                            &amp;quot;config&amp;quot;: {
                                                &amp;quot;configuration&amp;quot;: &amp;quot;{}\n&amp;quot;,
                                                &amp;quot;vm_config&amp;quot;: {
                                                    &amp;quot;code&amp;quot;: {
                                                        &amp;quot;local&amp;quot;: {
                                                            &amp;quot;inline_string&amp;quot;: &amp;quot;envoy.wasm.metadata_exchange&amp;quot;
                                                        }
                                                    },
                                                    &amp;quot;runtime&amp;quot;: &amp;quot;envoy.wasm.runtime.null&amp;quot;
                                                }
                                            }
                                        }
                                    }
                                },
                                {
                                    &amp;quot;name&amp;quot;: &amp;quot;istio_authn&amp;quot;,
                                    &amp;quot;typedConfig&amp;quot;: {
                                        &amp;quot;@type&amp;quot;: &amp;quot;type.googleapis.com/istio.envoy.config.filter.http.authn.v2alpha1.FilterConfig&amp;quot;,
                                        &amp;quot;policy&amp;quot;: {
                                            &amp;quot;peers&amp;quot;: &amp;amp;#91;
                                                {
                                                    &amp;quot;mtls&amp;quot;: {
                                                        &amp;quot;mode&amp;quot;: &amp;quot;PERMISSIVE&amp;quot;
                                                    }
                                                }
                                            ]
                                        }
                                    }
                                },
                                {
                                    &amp;quot;name&amp;quot;: &amp;quot;envoy.cors&amp;quot;,
                                    &amp;quot;typedConfig&amp;quot;: {
                                        &amp;quot;@type&amp;quot;: &amp;quot;type.googleapis.com/envoy.config.filter.http.cors.v2.Cors&amp;quot;
                                    }
                                },
                                {
                                    &amp;quot;name&amp;quot;: &amp;quot;envoy.fault&amp;quot;,
                                    &amp;quot;typedConfig&amp;quot;: {
                                        &amp;quot;@type&amp;quot;: &amp;quot;type.googleapis.com/envoy.config.filter.http.fault.v2.HTTPFault&amp;quot;
                                    }
                                },
                                {
                                    &amp;quot;name&amp;quot;: &amp;quot;istio.stats&amp;quot;,
                                    &amp;quot;typedConfig&amp;quot;: {
                                        &amp;quot;@type&amp;quot;: &amp;quot;type.googleapis.com/udpa.type.v1.TypedStruct&amp;quot;,
                                        &amp;quot;typeUrl&amp;quot;: &amp;quot;type.googleapis.com/envoy.extensions.filters.http.wasm.v3.Wasm&amp;quot;,
                                        &amp;quot;value&amp;quot;: {
                                            &amp;quot;config&amp;quot;: {
                                                &amp;quot;configuration&amp;quot;: &amp;quot;{\n  \&amp;quot;debug\&amp;quot;: \&amp;quot;false\&amp;quot;,\n  \&amp;quot;stat_prefix\&amp;quot;: \&amp;quot;istio\&amp;quot;\n}\n&amp;quot;,
                                                &amp;quot;root_id&amp;quot;: &amp;quot;stats_inbound&amp;quot;,
                                                &amp;quot;vm_config&amp;quot;: {
                                                    &amp;quot;code&amp;quot;: {
                                                        &amp;quot;local&amp;quot;: {
                                                            &amp;quot;inline_string&amp;quot;: &amp;quot;envoy.wasm.stats&amp;quot;
                                                        }
                                                    },
                                                    &amp;quot;runtime&amp;quot;: &amp;quot;envoy.wasm.runtime.null&amp;quot;,
                                                    &amp;quot;vm_id&amp;quot;: &amp;quot;stats_inbound&amp;quot;
                                                }
                                            }
                                        }
                                    }
                                },
                                {
                                    &amp;quot;name&amp;quot;: &amp;quot;envoy.router&amp;quot;,
                                    &amp;quot;typedConfig&amp;quot;: {
                                        &amp;quot;@type&amp;quot;: &amp;quot;type.googleapis.com/envoy.config.filter.http.router.v2.Router&amp;quot;
                                    }
                                }
                            ],
                            &amp;quot;tracing&amp;quot;: {
                                &amp;quot;clientSampling&amp;quot;: {
                                    &amp;quot;value&amp;quot;: 100
                                },
                                &amp;quot;randomSampling&amp;quot;: {
                                    &amp;quot;value&amp;quot;: 100
                                },
                                &amp;quot;overallSampling&amp;quot;: {
                                    &amp;quot;value&amp;quot;: 100
                                }
                            },
                            &amp;quot;serverName&amp;quot;: &amp;quot;istio-envoy&amp;quot;,
                            &amp;quot;streamIdleTimeout&amp;quot;: &amp;quot;0s&amp;quot;,
                            &amp;quot;accessLog&amp;quot;: &amp;amp;#91;
                                {
                                    &amp;quot;name&amp;quot;: &amp;quot;envoy.file_access_log&amp;quot;,
                                    &amp;quot;typedConfig&amp;quot;: {
                                        &amp;quot;@type&amp;quot;: &amp;quot;type.googleapis.com/envoy.config.accesslog.v2.FileAccessLog&amp;quot;,
                                        &amp;quot;path&amp;quot;: &amp;quot;/dev/stdout&amp;quot;,
                                        &amp;quot;format&amp;quot;: &amp;quot;&amp;amp;#91;%START_TIME%] \&amp;quot;%REQ(:METHOD)% %REQ(X-ENVOY-ORIGINAL-PATH?:PATH)% %PROTOCOL%\&amp;quot; %RESPONSE_CODE% %RESPONSE_FLAGS% \&amp;quot;%DYNAMIC_METADATA(istio.mixer:status)%\&amp;quot; \&amp;quot;%UPSTREAM_TRANSPORT_FAILURE_REASON%\&amp;quot; %BYTES_RECEIVED% %BYTES_SENT% %DURATION% %RESP(X-ENVOY-UPSTREAM-SERVICE-TIME)% \&amp;quot;%REQ(X-FORWARDED-FOR)%\&amp;quot; \&amp;quot;%REQ(USER-AGENT)%\&amp;quot; \&amp;quot;%REQ(X-REQUEST-ID)%\&amp;quot; \&amp;quot;%REQ(:AUTHORITY)%\&amp;quot; \&amp;quot;%UPSTREAM_HOST%\&amp;quot; %UPSTREAM_CLUSTER% %UPSTREAM_LOCAL_ADDRESS% %DOWNSTREAM_LOCAL_ADDRESS% %DOWNSTREAM_REMOTE_ADDRESS% %REQUESTED_SERVER_NAME% %ROUTE_NAME%\n&amp;quot;
                                    }
                                }
                            ],
                            &amp;quot;useRemoteAddress&amp;quot;: false,
                            &amp;quot;generateRequestId&amp;quot;: true,
                            &amp;quot;forwardClientCertDetails&amp;quot;: &amp;quot;APPEND_FORWARD&amp;quot;,
                            &amp;quot;setCurrentClientCertDetails&amp;quot;: {
                                &amp;quot;subject&amp;quot;: true,
                                &amp;quot;dns&amp;quot;: true,
                                &amp;quot;uri&amp;quot;: true
                            },
                            &amp;quot;upgradeConfigs&amp;quot;: &amp;amp;#91;
                                {
                                    &amp;quot;upgradeType&amp;quot;: &amp;quot;websocket&amp;quot;
                                }
                            ],
                            &amp;quot;normalizePath&amp;quot;: true
                        }
                    }
                ],
                &amp;quot;transportSocket&amp;quot;: {
                    &amp;quot;name&amp;quot;: &amp;quot;envoy.transport_sockets.tls&amp;quot;,
                    &amp;quot;typedConfig&amp;quot;: {
                        &amp;quot;@type&amp;quot;: &amp;quot;type.googleapis.com/envoy.api.v2.auth.DownstreamTlsContext&amp;quot;,
                        &amp;quot;commonTlsContext&amp;quot;: {
                            &amp;quot;tlsCertificateSdsSecretConfigs&amp;quot;: &amp;amp;#91;
                                {
                                    &amp;quot;name&amp;quot;: &amp;quot;default&amp;quot;,
                                    &amp;quot;sdsConfig&amp;quot;: {
                                        &amp;quot;apiConfigSource&amp;quot;: {
                                            &amp;quot;apiType&amp;quot;: &amp;quot;GRPC&amp;quot;,
                                            &amp;quot;grpcServices&amp;quot;: &amp;amp;#91;
                                                {
                                                    &amp;quot;envoyGrpc&amp;quot;: {
                                                        &amp;quot;clusterName&amp;quot;: &amp;quot;sds-grpc&amp;quot;
                                                    }
                                                }
                                            ]
                                        }
                                    }
                                }
                            ],
                            &amp;quot;combinedValidationContext&amp;quot;: {
                                &amp;quot;defaultValidationContext&amp;quot;: {},
                                &amp;quot;validationContextSdsSecretConfig&amp;quot;: {
                                    &amp;quot;name&amp;quot;: &amp;quot;ROOTCA&amp;quot;,
                                    &amp;quot;sdsConfig&amp;quot;: {
                                        &amp;quot;apiConfigSource&amp;quot;: {
                                            &amp;quot;apiType&amp;quot;: &amp;quot;GRPC&amp;quot;,
                                            &amp;quot;grpcServices&amp;quot;: &amp;amp;#91;
                                                {
                                                    &amp;quot;envoyGrpc&amp;quot;: {
                                                        &amp;quot;clusterName&amp;quot;: &amp;quot;sds-grpc&amp;quot;
                                                    }
                                                }
                                            ]
                                        }
                                    }
                                }
                            },
                            &amp;quot;alpnProtocols&amp;quot;: &amp;amp;#91;
                                &amp;quot;h2&amp;quot;,
                                &amp;quot;http/1.1&amp;quot;
                            ]
                        },
                        &amp;quot;requireClientCertificate&amp;quot;: true
                    }
                },
                &amp;quot;name&amp;quot;: &amp;quot;10.244.2.155_9080&amp;quot;
            },
            {
                &amp;quot;filterChainMatch&amp;quot;: {
                    &amp;quot;destinationPort&amp;quot;: 9080,
                    &amp;quot;prefixRanges&amp;quot;: &amp;amp;#91;
                        {
                            &amp;quot;addressPrefix&amp;quot;: &amp;quot;10.244.2.155&amp;quot;,
                            &amp;quot;prefixLen&amp;quot;: 32
                        }
                    ]
                },
                &amp;quot;filters&amp;quot;: &amp;amp;#91;
                    {
                        &amp;quot;name&amp;quot;: &amp;quot;istio.metadata_exchange&amp;quot;,
                        &amp;quot;typedConfig&amp;quot;: {
                            &amp;quot;@type&amp;quot;: &amp;quot;type.googleapis.com/udpa.type.v1.TypedStruct&amp;quot;,
                            &amp;quot;typeUrl&amp;quot;: &amp;quot;type.googleapis.com/envoy.tcp.metadataexchange.config.MetadataExchange&amp;quot;,
                            &amp;quot;value&amp;quot;: {
                                &amp;quot;protocol&amp;quot;: &amp;quot;istio-peer-exchange&amp;quot;
                            }
                        }
                    },
                    {
                        &amp;quot;name&amp;quot;: &amp;quot;envoy.http_connection_manager&amp;quot;,
                        &amp;quot;typedConfig&amp;quot;: {
                            &amp;quot;@type&amp;quot;: &amp;quot;type.googleapis.com/envoy.config.filter.network.http_connection_manager.v2.HttpConnectionManager&amp;quot;,
                            &amp;quot;statPrefix&amp;quot;: &amp;quot;inbound_10.244.2.155_9080&amp;quot;,
                            &amp;quot;routeConfig&amp;quot;: {
                                &amp;quot;name&amp;quot;: &amp;quot;inbound|9080|http|productpage.istio-bookinfo.svc.cluster.local&amp;quot;,
                                &amp;quot;virtualHosts&amp;quot;: &amp;amp;#91;
                                    {
                                        &amp;quot;name&amp;quot;: &amp;quot;inbound|http|9080&amp;quot;,
                                        &amp;quot;domains&amp;quot;: &amp;amp;#91;
                                            &amp;quot;*&amp;quot;
                                        ],
                                        &amp;quot;routes&amp;quot;: &amp;amp;#91;
                                            {
                                                &amp;quot;name&amp;quot;: &amp;quot;default&amp;quot;,
                                                &amp;quot;match&amp;quot;: {
                                                    &amp;quot;prefix&amp;quot;: &amp;quot;/&amp;quot;
                                                },
                                                &amp;quot;route&amp;quot;: {
                                                    &amp;quot;cluster&amp;quot;: &amp;quot;inbound|9080|http|productpage.istio-bookinfo.svc.cluster.local&amp;quot;,
                                                    &amp;quot;timeout&amp;quot;: &amp;quot;0s&amp;quot;,
                                                    &amp;quot;maxGrpcTimeout&amp;quot;: &amp;quot;0s&amp;quot;
                                                },
                                                &amp;quot;decorator&amp;quot;: {
                                                    &amp;quot;operation&amp;quot;: &amp;quot;productpage.istio-bookinfo.svc.cluster.local:9080/*&amp;quot;
                                                }
                                            }
                                        ]
                                    }
                                ],
                                &amp;quot;validateClusters&amp;quot;: false
                            },
                            &amp;quot;httpFilters&amp;quot;: &amp;amp;#91;
                                {
                                    &amp;quot;name&amp;quot;: &amp;quot;istio.metadata_exchange&amp;quot;,
                                    &amp;quot;typedConfig&amp;quot;: {
                                        &amp;quot;@type&amp;quot;: &amp;quot;type.googleapis.com/udpa.type.v1.TypedStruct&amp;quot;,
                                        &amp;quot;typeUrl&amp;quot;: &amp;quot;type.googleapis.com/envoy.extensions.filters.http.wasm.v3.Wasm&amp;quot;,
                                        &amp;quot;value&amp;quot;: {
                                            &amp;quot;config&amp;quot;: {
                                                &amp;quot;configuration&amp;quot;: &amp;quot;{}\n&amp;quot;,
                                                &amp;quot;vm_config&amp;quot;: {
                                                    &amp;quot;code&amp;quot;: {
                                                        &amp;quot;local&amp;quot;: {
                                                            &amp;quot;inline_string&amp;quot;: &amp;quot;envoy.wasm.metadata_exchange&amp;quot;
                                                        }
                                                    },
                                                    &amp;quot;runtime&amp;quot;: &amp;quot;envoy.wasm.runtime.null&amp;quot;
                                                }
                                            }
                                        }
                                    }
                                },
                                {
                                    &amp;quot;name&amp;quot;: &amp;quot;istio_authn&amp;quot;,
                                    &amp;quot;typedConfig&amp;quot;: {
                                        &amp;quot;@type&amp;quot;: &amp;quot;type.googleapis.com/istio.envoy.config.filter.http.authn.v2alpha1.FilterConfig&amp;quot;,
                                        &amp;quot;policy&amp;quot;: {
                                            &amp;quot;peers&amp;quot;: &amp;amp;#91;
                                                {
                                                    &amp;quot;mtls&amp;quot;: {
                                                        &amp;quot;mode&amp;quot;: &amp;quot;PERMISSIVE&amp;quot;
                                                    }
                                                }
                                            ]
                                        }
                                    }
                                },
                                {
                                    &amp;quot;name&amp;quot;: &amp;quot;envoy.cors&amp;quot;,
                                    &amp;quot;typedConfig&amp;quot;: {
                                        &amp;quot;@type&amp;quot;: &amp;quot;type.googleapis.com/envoy.config.filter.http.cors.v2.Cors&amp;quot;
                                    }
                                },
                                {
                                    &amp;quot;name&amp;quot;: &amp;quot;envoy.fault&amp;quot;,
                                    &amp;quot;typedConfig&amp;quot;: {
                                        &amp;quot;@type&amp;quot;: &amp;quot;type.googleapis.com/envoy.config.filter.http.fault.v2.HTTPFault&amp;quot;
                                    }
                                },
                                {
                                    &amp;quot;name&amp;quot;: &amp;quot;istio.stats&amp;quot;,
                                    &amp;quot;typedConfig&amp;quot;: {
                                        &amp;quot;@type&amp;quot;: &amp;quot;type.googleapis.com/udpa.type.v1.TypedStruct&amp;quot;,
                                        &amp;quot;typeUrl&amp;quot;: &amp;quot;type.googleapis.com/envoy.extensions.filters.http.wasm.v3.Wasm&amp;quot;,
                                        &amp;quot;value&amp;quot;: {
                                            &amp;quot;config&amp;quot;: {
                                                &amp;quot;configuration&amp;quot;: &amp;quot;{\n  \&amp;quot;debug\&amp;quot;: \&amp;quot;false\&amp;quot;,\n  \&amp;quot;stat_prefix\&amp;quot;: \&amp;quot;istio\&amp;quot;\n}\n&amp;quot;,
                                                &amp;quot;root_id&amp;quot;: &amp;quot;stats_inbound&amp;quot;,
                                                &amp;quot;vm_config&amp;quot;: {
                                                    &amp;quot;code&amp;quot;: {
                                                        &amp;quot;local&amp;quot;: {
                                                            &amp;quot;inline_string&amp;quot;: &amp;quot;envoy.wasm.stats&amp;quot;
                                                        }
                                                    },
                                                    &amp;quot;runtime&amp;quot;: &amp;quot;envoy.wasm.runtime.null&amp;quot;,
                                                    &amp;quot;vm_id&amp;quot;: &amp;quot;stats_inbound&amp;quot;
                                                }
                                            }
                                        }
                                    }
                                },
                                {
                                    &amp;quot;name&amp;quot;: &amp;quot;envoy.router&amp;quot;,
                                    &amp;quot;typedConfig&amp;quot;: {
                                        &amp;quot;@type&amp;quot;: &amp;quot;type.googleapis.com/envoy.config.filter.http.router.v2.Router&amp;quot;
                                    }
                                }
                            ],
                            &amp;quot;tracing&amp;quot;: {
                                &amp;quot;clientSampling&amp;quot;: {
                                    &amp;quot;value&amp;quot;: 100
                                },
                                &amp;quot;randomSampling&amp;quot;: {
                                    &amp;quot;value&amp;quot;: 100
                                },
                                &amp;quot;overallSampling&amp;quot;: {
                                    &amp;quot;value&amp;quot;: 100
                                }
                            },
                            &amp;quot;serverName&amp;quot;: &amp;quot;istio-envoy&amp;quot;,
                            &amp;quot;streamIdleTimeout&amp;quot;: &amp;quot;0s&amp;quot;,
                            &amp;quot;accessLog&amp;quot;: &amp;amp;#91;
                                {
                                    &amp;quot;name&amp;quot;: &amp;quot;envoy.file_access_log&amp;quot;,
                                    &amp;quot;typedConfig&amp;quot;: {
                                        &amp;quot;@type&amp;quot;: &amp;quot;type.googleapis.com/envoy.config.accesslog.v2.FileAccessLog&amp;quot;,
                                        &amp;quot;path&amp;quot;: &amp;quot;/dev/stdout&amp;quot;,
                                        &amp;quot;format&amp;quot;: &amp;quot;&amp;amp;#91;%START_TIME%] \&amp;quot;%REQ(:METHOD)% %REQ(X-ENVOY-ORIGINAL-PATH?:PATH)% %PROTOCOL%\&amp;quot; %RESPONSE_CODE% %RESPONSE_FLAGS% \&amp;quot;%DYNAMIC_METADATA(istio.mixer:status)%\&amp;quot; \&amp;quot;%UPSTREAM_TRANSPORT_FAILURE_REASON%\&amp;quot; %BYTES_RECEIVED% %BYTES_SENT% %DURATION% %RESP(X-ENVOY-UPSTREAM-SERVICE-TIME)% \&amp;quot;%REQ(X-FORWARDED-FOR)%\&amp;quot; \&amp;quot;%REQ(USER-AGENT)%\&amp;quot; \&amp;quot;%REQ(X-REQUEST-ID)%\&amp;quot; \&amp;quot;%REQ(:AUTHORITY)%\&amp;quot; \&amp;quot;%UPSTREAM_HOST%\&amp;quot; %UPSTREAM_CLUSTER% %UPSTREAM_LOCAL_ADDRESS% %DOWNSTREAM_LOCAL_ADDRESS% %DOWNSTREAM_REMOTE_ADDRESS% %REQUESTED_SERVER_NAME% %ROUTE_NAME%\n&amp;quot;
                                    }
                                }
                            ],
                            &amp;quot;useRemoteAddress&amp;quot;: false,
                            &amp;quot;generateRequestId&amp;quot;: true,
                            &amp;quot;forwardClientCertDetails&amp;quot;: &amp;quot;APPEND_FORWARD&amp;quot;,
                            &amp;quot;setCurrentClientCertDetails&amp;quot;: {
                                &amp;quot;subject&amp;quot;: true,
                                &amp;quot;dns&amp;quot;: true,
                                &amp;quot;uri&amp;quot;: true
                            },
                            &amp;quot;upgradeConfigs&amp;quot;: &amp;amp;#91;
                                {
                                    &amp;quot;upgradeType&amp;quot;: &amp;quot;websocket&amp;quot;
                                }
                            ],
                            &amp;quot;normalizePath&amp;quot;: true
                        }
                    }
                ],
                &amp;quot;name&amp;quot;: &amp;quot;10.244.2.155_9080&amp;quot;
            }
        ],
        &amp;quot;listenerFilters&amp;quot;: &amp;amp;#91;
            {
                &amp;quot;name&amp;quot;: &amp;quot;envoy.listener.original_dst&amp;quot;,
                &amp;quot;typedConfig&amp;quot;: {
                    &amp;quot;@type&amp;quot;: &amp;quot;type.googleapis.com/envoy.config.filter.listener.original_dst.v2.OriginalDst&amp;quot;
                }
            },
            {
                &amp;quot;name&amp;quot;: &amp;quot;envoy.listener.tls_inspector&amp;quot;,
                &amp;quot;typedConfig&amp;quot;: {
                    &amp;quot;@type&amp;quot;: &amp;quot;type.googleapis.com/envoy.config.filter.listener.tls_inspector.v2.TlsInspector&amp;quot;
                }
            },
            {
                &amp;quot;name&amp;quot;: &amp;quot;envoy.listener.http_inspector&amp;quot;,
                &amp;quot;typedConfig&amp;quot;: {
                    &amp;quot;@type&amp;quot;: &amp;quot;type.googleapis.com/envoy.config.filter.listener.http_inspector.v2.HttpInspector&amp;quot;
                }
            }
        ],
        &amp;quot;listenerFiltersTimeout&amp;quot;: &amp;quot;1s&amp;quot;,
        &amp;quot;continueOnListenerFiltersTimeout&amp;quot;: true,
        &amp;quot;trafficDirection&amp;quot;: &amp;quot;INBOUND&amp;quot;
    }
]
&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;Check more istio practice detail at my tech blog &lt;a href=&#34;https://imesh.club&#34;&gt;https://imesh.club&lt;/a&gt;&lt;/p&gt;
</content>
    </item>
    
  </channel>
</rss>
